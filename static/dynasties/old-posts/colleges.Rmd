---
title: "Collges - Pan-India"
params:
  orig_date: "Original Publish Date: 19 August, 2021"
  update_date: !r paste("Updated on:", format(Sys.time(), '%I:%m  %p -- %d %B, %Y'))

output:
  html_document:
    theme: yeti
    toc: TRUE
    toc_float: TRUE
    toc_depth: 5
    number_sections: false
    fig_width: 6
editor_options:
  chunk_output_type: inline
---

------------------------------------------------------------------------

### Document History

`r params$orig_date`

`r params$update_date`

------------------------------------------------------------------------

```{r set up, warning=FALSE, include=FALSE, message= FALSE}

knitr::opts_chunk$set(cache = FALSE,echo = FALSE, message=FALSE, warning = FALSE)

##fig.width = 16/2, fig.height = 9/2

library(tidyverse)
library(data.table)
library(knitr)
library(kableExtra)


library(stargazer)
`%!in%` = Negate(`%in%`)

library(lfe)

select <- dplyr::select

summarise <- dplyr::summarise
filter <- dplyr::filter
mutate <- dplyr::mutate



rename <- dplyr::rename

```

# India {.tabset}

## Observations

+-----------------------------------+-------+-----------------------------------------------+
| Stage                             | N     | note                                          |
+===================================+=======+===============================================+
| Total colleges                    | 57009 | From the pdf                                  |
+-----------------------------------+-------+-----------------------------------------------+
| with lat & long                   | 54683 | Ones with proper address                      |
+-----------------------------------+-------+-----------------------------------------------+
| built in and after 1989           | 40854 | filtered to match with available dynasty data |
+-----------------------------------+-------+-----------------------------------------------+
| After removing Andhra & Telengana | 37908 | Andhra/telengana separation causing fuss      |
+-----------------------------------+-------+-----------------------------------------------+
| After merging with dynasty data   | 36026 | 5% no match                                   |
+-----------------------------------+-------+-----------------------------------------------+
| After removing universities       |       |                                               |
+-----------------------------------+-------+-----------------------------------------------+

: Observations

```{r}

dyn_5pc <- fread("d:/cpr/UP/up-dynasties/dyn_other_data/dyn_5pc_8919.csv") %>% 
   mutate(state_name = str_replace(state_name,  "&", "and")
                   ,state_name = tolower(state_name),
                                  
                                  
                                  state_name= str_trim(state_name))


college_in <- fread("D:/cpr/data/college/colleges_pc.csv") %>% 
  rename_all(tolower) 

college <- college_in

#college_in <- college_in %>% mutate( year_estd = factor(year_estd))

college <- college %>% filter(year_estd>=1989  &!is.na(pc_no)) %>% 
  mutate(year_el = case_when(
    year_estd>=1989 & year_estd<1991 ~1989,
      year_estd>=1991 & year_estd<1996 ~1991,
      year_estd>=1996 & year_estd<1998 ~1996,
      year_estd>=1998 & year_estd<1999 ~1998,
      year_estd>=1999 & year_estd<2004 ~1999,
      year_estd>=2004 & year_estd<2009 ~2004,
      year_estd>=2009 & year_estd<2014 ~2009,
      year_estd>=2014 & year_estd<2019 ~2014,
      year_estd>=2019 & year_estd<2022 ~2019,
    TRUE ~0
  )) %>% 
 mutate(state = tolower(state),
        state= str_trim(state)) %>% 
  filter(state!= "andhra pradesh" & state!= "telengana" & management!= "University")
# 
# hist(college$year_el)
# 
# unique(dyn_5pc$year)
# names(college)
# 
# unique(college$state)
# 
# unique(dyn_5pc$state_name)



## removin andhra - since is is causing matching issue - attributed to telengana split
# college %>% group_by(year_el,state, constituency_n) %>% summarise(n_college= n())


college_dyn <- inner_join(college, dyn_5pc, by = c("state"= "state_name", "year_el" = "year",
                                                   "pc_no" = "constituency_no"))

# dim(college_dyn)
# 
# college %>% filter(!is.na(pc_no))
```

```{r}
# unique(dyn_5pc$state_name)
# 
# names(college)
```

## Summary

```{r results="asis", warning=FALSE}

college_dyn <- college_dyn %>%mutate(year_el = factor(year_el)) 

summarytools::dfSummary(college_dyn,
                        plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE,
          headings = FALSE,
           tmp.img.dir  = "/tmp")

 
```

## distribution of colleges at pc level

```{r}

ac_df <- college_dyn %>% group_by(year_el,state, constituency_name) %>% summarise(count = n())

ggplot(ac_df, aes(count))+
  geom_histogram()+
   scale_x_continuous(trans = "pseudo_log",
                       breaks = c(0:5,10,25,50, 100, 250), minor_breaks = NULL)+
  labs(x = "n_colleges",y ="COunt at PC level",
       subtitle = "College distribution at constituency level for every election cycle")+
  theme_bw()


```

## colleges at pc level

**average number of colleges established in a parliamentary constituency during** particular election cycle

```{r}
college_dyn <- college_dyn %>% mutate(dynast = ifelse(dyn==1,1,0))

std <- function(x) sd(x)/sqrt(length(x))

ac_college <- rbindlist(list(college_dyn %>% group_by(year_el,state, constituency_name) %>% summarise(count = n()) %>% ungroup() %>% 
  summarise(mean = mean(count),  se = std(count)),


college_dyn %>% group_by(year_el,state, constituency_name, dynast) %>% summarise(count = n()) %>% ungroup() %>% group_by(dynast) %>% 
  summarise(mean= mean(count),se = std(count))), fill = TRUE)

entity <- c("All", "Non-Family","Family")


mean_df <- cbind(ac_college, entity) %>% select(-dynast)






mean_df$entity <-  factor(mean_df$entity)

 ggplot(mean_df , aes(x=entity, y=mean)) +
    geom_bar(position=position_dodge(), stat="identity",
             colour="black", # Use black outlines,
            # size=.3
            ) +      # Thinner lines
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                  size=.3,    # Thinner lines
                  width=.2,
                  position=position_dodge(.9)) +
  labs(y = "Mean")+
   ylim(0,15)+

    theme_bw()+
  theme(axis.title.x = element_blank(),
        text = element_text("serif"))+
   theme(aspect.ratio=3/2)



```

## managment

```{r results = "asis"}


college_dyn %>% group_by(management) %>% 
  summarise(count = n(),prop = count/length(college_dyn$management)) %>% arrange(-prop) %>%
  select(-count) %>% 
  kable(digits = 2) %>% 
  kable_styling(full_width = FALSE)
  


```

## Colleges by state and year

```{r}

college_dyn %>% group_by(year_el, state) %>% 
  summarise(count= n()) %>% 
  ggplot(aes(year_el, count, fill = state))+
  geom_bar(position = "stack",
           stat = "identity")+
  theme_bw()+
  scale_fill_grey()+
  labs(caption = "note : fill shades represents states",
       y = "N colleges established",
       x = "election cycle")+
  theme(legend.position = "none")

```

# rdd

```{r}

ac_df <- college %>% group_by(year_el,state, pc_no) %>% summarise(n_college = n()/5) %>% 
  filter(state!= "andhra pradesh" & state!= "telangana" &year_el %in% c(2004, 2009, 2014))


dyn_5pc  <- dyn_5pc  %>% mutate(family = ifelse(dyn==1,TRUE,FALSE))


dyn_5pc<- dyn_5pc  %>% filter(position %in% c(1,2)) %>% 
  group_by(state_name, year, constituency_no) %>% 
  mutate(pos_sum = n()) %>% 
  filter(pos_sum==2) %>% 
  mutate(dyn_sum = sum(family)) %>% 
  filter(position ==1) %>% 
  mutate(dyn_vs_nondyn = ifelse(dyn_sum==1,1,0))



dyn_ac <- dyn_5pc  %>% 
  filter(state_name!= "andhra pradesh" & state_name!= "telangana" &
           year %in% c(2004, 2009, 2014)) 
# 

college_dyn_ac <-right_join(ac_df, dyn_ac, by = c("state"= "state_name", "year_el" = "year",
                                                   "pc_no" = "constituency_no")) %>% 
  mutate(n_college = ifelse(is.na(n_college),0,n_college))

```


### Summary
```{r}


college_rdd <- college_dyn_ac %>% filter(margin_percentage<=10 & dyn_vs_nondyn==1) %>% 
  mutate(mv = ifelse(family ==0, -margin_percentage, margin_percentage),
         electors_million = electors/1000000,
         n_college = n_college/electors_million)


```

-   our independent variable`n_college` is defined as the number of colleges built per a million population in a year within a parliamentary constituency

-   We have only included 2004, 2014 & 2019 electoral cycles given they more large in numbers . within these 3 elections there were 408 contest in which a family politician contested against a non-family politician and vice versa.

 -Margin percentage (cut off) break up look like this:
 
| cut off            | 2.5 | 5   | 10  |
|--------------------|-----|-----|-----|
| total              | 78  | 165 | 297 |
| family winners     | 40  | 86  | 167 |
| non-family winners | 38  | 79  | 130 |




```{r}
college_rdd <- college_rdd %>% mutate(mv_2.5 = ifelse(margin_percentage<= 2.5,1,0),
                       mv_5 = ifelse(margin_percentage<= 5,1,0),
                       mv_10 = ifelse(margin_percentage<= 10,1,0))
```


--- 


## rdd graph for 5pc


```{r}
ggplot(college_rdd,  aes(mv,n_college , color = family))+
  geom_point()+
    geom_smooth(method="lm", se= FALSE)+
  geom_vline(xintercept = 0)+
    scale_color_grey(labels = c("non-family winner", "family winner"))+
   labs(x = "Margin of victory", y = "n collegs per million population",
        caption = "note: collegesbuilt in year in a parliamentary constituency")+
   theme_bw()+
  theme(legend.position = "bottom", legend.title = element_blank())+
  ylim(0,10)
  
```


---


## rdd model

---


```{r, results = "asis"}
fit2.5 <- lm(n_college~family, data = subset(college_rdd %>% filter(mv_2.5 ==1)))

fit5 <- lm(n_college~family, data = subset(college_rdd %>% filter(mv_5 ==1)))

fit10 <- lm(n_college~family, data = subset(college_rdd %>% filter(mv_10 ==1)))



stargazer::stargazer(fit2.5,fit5, fit10, type = "html", omit = "Constant", column.labels = c("2,5","5","10"))
```


---


## Further improvments


- Add more years

- do seperate ones for private/government college

- remove/keep standalone colleges

- 
