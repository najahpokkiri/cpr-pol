---
title: "MPLADS Carlos"
author: ""
params:
  orig_date: "Orignal Publish Date: 15 September 2021"
  update_date:  !r paste("Updated on:", format(Sys.time(), '%I:%m  %p -- %d %B, %Y'))
output: 
  html_document:
    theme: yeti
    toc: true
    toc_float: true
    number_sections: true
    fig_width: 6
editor_options:
  chunk_output_type: inline
---

------------------------------------------------------------------------

### Document history

`r params$orig_date`

`r params$update_date`

------------------------------------------------------------------------



```{r set up, echo =  FALSE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(cache = FALSE, echo =  FALSE, message = FALSE, warning = FALSE)
                      
         #fig.width = 16/2, fig.height = 9/2             

```

```{r libraries}

library(tidyverse)

library(data.table)

library(kableExtra)
library(scales)
library(haven)

library(lfe)

library(lme4)

# library(lmerTest)
library(stargazer)
`%!in%` = Negate(`%in%`)


select <- dplyr::select

```

<!-- # Fam df -->

```{r reading the main file}


fam_df <- read.csv("~/work/cpr/UP/up-dynasties/dyn_other_data/fam_df.csv")

fam_select <- fam_df %>% select(family_id, fam_type = success_cat)

dyn <- fread("~/work/cpr/UP/up-dynasties/dyn_other_data/dyn_ae_ge.csv") %>% 
  left_join(fam_select, by = "family_id") %>% 
  mutate(fam_type = replace_na(fam_type, "Non-Fam"))

# 
# 
# dyn %>% filter( position ==1 & fam_type == "Stable" &  year>2008) %>% select(year, constituency_name, candidate_name, party, dyn_cum_2) 
## filtering ge data to only 2009

dyn_ge_w_09 <- dyn %>% filter(election_type == "GE" & position==1 & year==2009)


```

# UP
All analysis are limited to 2009:14 session.


## Audit data {.tabset}

Second part of carlos data that provides full information on MPLADS projects

```{r}


mplads_car1 <- load("~/work/cpr/data/replication/carlos_mplads/data/mplads-eval-data.RData")


mplads_car_up <- mplads.eval %>% filter(state == "Uttar Pradesh")


##

mplads_car3 <- load("~/work/cpr/data/replication/carlos_mplads/data/mplads-data.RData")




```

```{r, results = "asis"}
dyn_ge_w_09 <- dyn_ge_w_09 %>% mutate(stable = ifelse(fam_type=="Stable", "Stable", "Rest"))

mplads_car_09 <- mplads_car_up %>% filter(session ==15)
mp_car_dyn <- inner_join(mplads_car_09,dyn_ge_w_09,by = c("idpc" = "constituency_no"))


mp_car_dyn  <- mp_car_dyn %>% group_by(idpc) %>% 
  mutate(n_ac = n())
```


### top level summary

```{r, results = "asis"}
mp_car_dyn %>% group_by(stable) %>% 
  summarise(count = n(),
            ngo = mean(ngo),
            completion_time = mean(comp_time, na.rm = TRUE),
            amount = mean(amt_sanc),
            n_proj_ac = mean(n_ac),
            mean_proj_el = mean(elec_yr),
            mean_app_time = mean(app.time, na.rm = TRUE)
            ) %>% 
            kable(digits =2, type = "html") %>% 
            kable_styling()


```

### projects break-up

```{r}

mp_car_dyn %>% group_by (stable, clean.sector) %>% summarise(count = n()) %>% 
  group_by(stable) %>% mutate(sum = sum(count), prop= count /sum) %>% 
  ggplot(aes(stable, prop, fill= clean.sector, label = ifelse(prop>.03, round(prop,2),"")))+
  geom_bar(stat = "identity",
           position = "stack")+
  geom_text(size = 3, position = position_stack(vjust = 0.5))+ 
    
    scale_x_discrete(labels = c("Non-Families","Families"))+
   #scale_fill_grey()+
    labs(title = " MPLADS projects composition",x = "", y = "Proportion", fill = "Type of work") +
 theme_minimal()+
  coord_fixed(ratio =2)+
  theme(plot.background = element_blank(),
        axis.line.x = element_line(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_blank(),
        #legend.position = "bottom",
        axis.title = element_blank(), 
        axis.text = element_text(size = 10),
        text = element_text(family = "serif")       )
```


## Bureaucrats data {.tabset}
First part of carlos data that provides limited information on MPLADS projects, but a huge dataset with ~3 lakhs obs. for pan-india and for different sessions

### Summary {.tabset}

```{r}


mplads_09_up <- mplads %>% filter(session=="15" & State == "Uttar Pradesh") %>% 
  mutate(pc_name = str_trim(str_remove(tolower(Constituency.Name),"\\(sc\\)"
         )))

dyn_ge_w_09 <- dyn_ge_w_09 %>% mutate( constituency_name= str_trim(tolower(constituency_name)),
                                       constituency_name = ifelse(constituency_name=="gautam buddh nagar","gautam buddha nagar", constituency_name)) 

# up_pc_uniq <- mplads_09_up %>% distinct(pc_name)
# dyn_pc_uniq <- dyn_ge_w_09 %>% distinct(constituency_name)
# 
# inner_join(dyn_pc_uniq, up_pc_uniq, by = c(constituency_name = "pc_name"))

mplads_dyn_up09 <- inner_join(mplads_09_up , dyn_ge_w_09, by = c( "pc_name" = "constituency_name"))

mplads_dyn_up09 <- mplads_dyn_up09 %>%  mutate(completed = ifelse(Work.Status == "COMPLETED", 1,0),
                                               stable_binary = ifelse(stable =="Stable", 1,0),
                                               party_bjp = ifelse(party =="BJP", 1,0),
                                               party_inc = ifelse(party =="INC",1,0),
                                               party_bsp = ifelse(party =="BSP",1,0),
                                               party_sp
                                               = ifelse(party =="SP",1,0),
                                               )



```

#### Top level summary

```{r}
mplads_dyn_up09 %>% group_by(stable) %>% 
  summarise(n_projects = n(),
            n_pc = n_distinct(pc_name),
            avg_proj_pc = n_projects/n_pc,
            avg_days_approv = mean(app.time*7, na.rm = TRUE),
            avg_cost = mean(cost.sanc, na.rm = TRUE),
            avg_unfinished = mean(unfinish*100),
            completed = mean(completed)
            ) %>% 
  kable(digits = 2) %>% 
  kable_styling()
```

#### weeks for approval

```{r, weeks}
ggplot(mplads_dyn_up09, aes(stable, log(app.time+1)))+
  geom_boxplot()+
  labs(title = "Weeks to approve proposal",
       subtitle = "UP Loksabha MPs - 2009:14",
       y = "log of weeks",
       x="Legislator")+
  theme_light()
```

#### Cost per project

```{r cost }
ggplot(mplads_dyn_up09, aes(stable, log(cost.sanc+1)))+
  geom_boxplot()+
  labs(title = "Project costs",
       subtitle = "UP Loksabha MPs - 2009:14",
       y = "log of cost",
       x="Legislator")+
  theme_light()
```

#### Number of projects in PCs

```{r n proj }


n_proj_df<- mplads_dyn_up09 %>% group_by(stable, pc_name) %>% summarise(count = n())  
n_proj_bp <- ggplot(n_proj_df, aes(stable, log(count)))+
  geom_boxplot()+
  labs(title = "Number of projects in PCs",
       subtitle = "UP Loksabha MPs - 2009:14",
       y = "log+1 of count",
       x="Legislator")+
  theme_light()

n_proj_dens <-ggplot(n_proj_df, aes( log(count+1), fill = stable))+
    geom_density(alpha = .5)+
    labs(title = "Number of projects in PCs",
         subtitle = "UP Loksabha MPs - 2009:14",
         y = "log+1 of count",
         x="Legislator")+
    theme_light()

library(patchwork)

n_proj_bp +  n_proj_dens


```

### Models {.tabset}

```{r}


df <- mplads_dyn_up09 %>% 
   group_by(pc_name) %>% mutate(n_proj_pc = n()) %>% ungroup() %>% 
 
  select(n_proj_pc, approval_time = app.time , cost_sanctioned = cost.sanc , stable_binary ,cpwork ,  poweryr ,  national , govcol, reserved , margin.x , turnout , ncan,party_bjp , party_inc ,party_sp , party_bsp, tot.dis.works , mp.per.dis,  gdppc , rugged, pc_name) %>% mutate(approval_time = log(approval_time+1),  cost_sanctioned = log(cost_sanctioned+1),
                                                                                                                                                                                                                                                                                                                     gdppc = log(gdppc+1),
                                                                                                                                                                                                                                                                                                                     rugged = log(rugged+1)) %>% 
  filter(cost_sanctioned>0 & approval_time>0)




```


#### Data summary


```{r}


mean1 <- df %>% summarise_at(c(1:20),~ mean(.x, na.rm = TRUE)) %>% transpose() %>% setNames("Mean")

min1 <- df %>% summarise_at(c(1:20),~ min(.x, na.rm = TRUE))%>% transpose()%>% setNames("Min")

max1 <- df %>% summarise_at(c(1:20),~ max(.x, na.rm = TRUE))%>% transpose()%>% setNames("Max")


sd1 <- df %>% summarise_at(c(1:20),~ sd(.x, na.rm = TRUE))%>% transpose()%>% setNames("SD")



na1 <- df %>%
  summarise_all(funs(sum(is.na(.))))%>% transpose()%>% slice(1:20)%>% setNames("NA")

vars1 <- c("Number of projects (PC)","Log(Approval Time)","Log(Cost Sanctioned)", 
           "State Alignment","Stable Family",  "CM Tenure", "National Party",
           "Centre Alignment", "Reserved PC","Margin", "Turnout", "Number of Candidates",
           "Party: BJP",   "Party: INC",
           "Party: SP","Party BSP", "Number of Works: District", "MPs per District",
           "Log(Rugged)", "Log(GDP per Capita)") %>% as.data.frame() %>% slice(1:20) %>% setNames("variable")

cbind(vars1, mean1, min1, max1, sd1, na1) %>% 
  kable(digits = 2,) %>% 
  kable_styling(full_width = F)

```


#### Models sub{.tabset}

##### Approval time


```{r,results="asis"}


fit_time1 <- felm(approval_time ~ cost_sanctioned+cpwork +  stable_binary,data = df)

fit_time2 <- lmer(approval_time ~ cost_sanctioned+ cpwork + stable_binary+(1|pc_name),data = df)

fit_time3 <- lmer(approval_time ~ cost_sanctioned+ cpwork + stable_binary+ national+ poweryr +(1|pc_name),data = df)

fit_time4 <- lmer(approval_time ~ cost_sanctioned+ cpwork + stable_binary+ national+ poweryr + ncan+rugged+ (1|pc_name),data = df)

fit_time <- lmer(approval_time ~ cost_sanctioned+ stable_binary +cpwork +  poweryr +  national + govcol+ reserved + margin.x + turnout + ncan+party_bjp + party_inc +party_sp + party_bsp+ tot.dis.works + mp.per.dis+  gdppc + rugged + (1|pc_name),data = df)

lines <-  list (c("RE Parliamentary Constituency", "No","Yes", "Yes", "Yes", "Yes"))

labs <- c( "Log Cost Sanctioned", 
           "State Alignment","Stable Family",  "CM Tenure", "National Party",
           "Centre Alignment", "Reserved PC","Margin", "Turnout", "Number of Candidates",
           "Party: BJP",   "Party: INC",
           "Party: SP", "Number of Works: District", "MPs per District",
           "Log(Rugged)", "Log(GDP per Capita)", "Intercept"
          )

stargazer(fit_time1,
          fit_time2,
          fit_time3,
          fit_time4,
          fit_time,
          type = "html",
          add.lines = lines,
          covariate.labels = labs,
          dep.var.caption = "Log(Approval time- weeks)",
          dep.var.labels.include = FALSE
          )

```

##### Cost Sanctioned

```{r, results="asis"}

fit_cost1 <- felm(cost_sanctioned~approval_time+cpwork +  stable_binary,data = df)

fit_cost2 <- lmer(cost_sanctioned~approval_time+ cpwork + stable_binary+(1|pc_name),data = df)

fit_cost3 <- lmer(cost_sanctioned~approval_time+ cpwork + stable_binary+ national+ poweryr +(1|pc_name),data = df)

fit_cost4 <- lmer(cost_sanctioned~approval_time+ cpwork + stable_binary+ national+ poweryr + ncan+rugged+ (1|pc_name),data = df)

fit_cost <- lmer(cost_sanctioned~approval_time+ stable_binary +cpwork +  poweryr +  national + govcol+ reserved + margin.x + turnout + ncan+party_bjp + party_inc +party_sp + party_bsp+ tot.dis.works + mp.per.dis+  gdppc + rugged + (1|pc_name),data = df)

lines <-  list (c("RE Parliamentary Constituency", "No","Yes", "Yes", "Yes", "Yes"))

labs <- c( "Log Approval Time", 
           "State Alignment","Stable Family",  "CM Tenure", "National Party",
           "Centre Alignment", "Reserved PC","Margin", "Turnout", "Number of Candidates",
           "Party: BJP",   "Party: INC",
           "Party: SP", "Number of Works: District", "MPs per District",
           "Log(Rugged)", "Log(GDP per Capita)", "Intercept"
          )

stargazer(fit_cost1,
          fit_cost2,
          fit_cost3,
          fit_cost4,
          fit_cost,type = "html",
          add.lines = lines,
          covariate.labels = labs,
          dep.var.caption = "Log(Cost sanctioned)",
          dep.var.labels.include = FALSE
            
          )

```


```{r}

# df <- df %>% group_by(pc_name) %>% 
#   mutate(mean_app_time = mean(approval_time),
#          mean_cost = mean(cost_sanctioned))
# 
# fit.3 <- felm(n_proj_pc~mean_app_time + mean_cost + stable_binary +cpwork +  poweryr +  national +  reserved + margin.x + turnout + ncan +party_bjp + party_inc +party_sp + party_bsp+  mp.per.dis+  gdppc + rugged ,data = subset(df %>% distinct(pc_name,.keep_all = TRUE)))


```



