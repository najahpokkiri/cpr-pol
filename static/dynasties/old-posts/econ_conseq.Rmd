---
title: "Economic consequences"
author: ""
params:
  orig_date: "Orignal Publish Date: 02 September 2021"
  update_date:  !r paste("Updated on:", format(Sys.time(), '%I:%m  %p -- %d %B, %Y'))
output: 
  html_document:
    theme: yeti
    toc: true
    toc_float: true
    number_sections: true
    fig_width: 6
editor_options:
  chunk_output_type: inline
---

------------------------------------------------------------------------

### Document history

`r params$orig_date`

`r params$update_date`

------------------------------------------------------------------------

```{r set up, echo =  FALSE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(cache = FALSE, echo =  FALSE, message = FALSE, warning = FALSE,
                      fig.width = 16/2, fig.height = 9/2)

```

```{r libraries}

library(tidyverse)

library(data.table)

library(kableExtra)
library(scales)
library(haven)
`%!in%` = Negate(`%in%`)


select <- dplyr::select

```

So far we have been focusing on the economic consequences of having political families in constituencies by comparing them against non-families. Here onwards, we will be comparing stable against non-families and other categories.

We address two main question here how does the development indices differ from the political family constituencies from non-political family constituencies. Two address this question we use NREGA , PMGSY, MPL̄̄̄̄̄̄̄̄̄̄̄ADS and nightlights data.

The second question is where do political families come from. This would need longitudinal data or historical data. Given the above datasets are recent we will depend on population census, economic census, weather data, agitation data, criminality data etc.

In our full dataset we have 667 winners from the stable family and 415 after the family formation. Since 2009, it is 161 . We would only be able to use these stable category to assess the consequence of family politicians after 2009 since that category is formed after 2008. This limits us to MPLADS, PMGSY and NREGA

```{r reading the main file}


fam_df <- read.csv("~/work/cpr/UP/up-dynasties/dyn_other_data/fam_df.csv")

fam_select <- fam_df %>% select(family_id, fam_type = success_cat)

dyn <- fread("~/work/cpr/UP/up-dynasties/dyn_other_data/dyn_ae_ge.csv") %>% 
  left_join(fam_select, by = "family_id") %>% 
  mutate(fam_type = replace_na(fam_type, "Non-Fam"))

# 
# 
# dyn %>% filter( position ==1 & fam_type == "Stable" &  year>2008) %>% select(year, constituency_name, candidate_name, party, dyn_cum_2) 
## filtering ge data to only 2009

dyn_ge_w_09 <- dyn %>% filter(election_type == "GE" & position==1 & year==2009)


```

# Econ consequences

# MPLADS {.tabset}

```{r}

## reading the data set
mplads <- fread("~/work/cpr/UP/up-dynasties/dyn_other_data/mplads-dataset.csv")



names(mplads) <- tolower(names(mplads))

## remove the unwanted columns

mplads <- mplads %>% select(constituency_no,year, everything()) %>% select(- c(30:102)) %>% filter(year>2008)

## filtering ge data to only 2009

dyn_ge_w_09 <- dyn %>% filter(election_type == "GE" & position==1 & year==2009)


## categorising the costs to 3 catagories


mplads$cost_cat <- cut(mplads$costnew, breaks = c(0,200000,500000,Inf), labels = c("Low", "Medium", "High"))

## names(dyn_mplads) <- make.unique(names(dyn_mplads))
dyn_mplads <- merge(mplads,dyn_ge_w_09, by = c("year", "constituency_no"))

## just changing the families to just stable ones

dyn_mplads$dyn_cum_2_text <- ifelse(dyn_mplads$fam_type=="Stable", "Stable","Rest")

## winsorizng few columns to remove the discrepencies

dyn_mplads <- dyn_mplads %>% 
  mutate(costnew =  DescTools::Winsorize(costnew, na.rm = TRUE,probs = c(.01,.99)),
         days =  DescTools::Winsorize(days, na.rm = TRUE,probs = c(.01,.99)))

```

## Summary {.tabset}

```{r results="asis", warning=FALSE}

library(summarytools)

# college_dyn <- college_dyn %>%mutate(year_el = factor(year_el)) 

summarytools::dfSummary(mplads,
                        plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE,
          headings = FALSE,
           tmp.img.dir  = "/tmp")

 
```

## Top level summary: stable v/s Non-family

This table shows the average number of projects and the cost for the family types. First table is forboth years and the second one is year by year break-up of the same.

```{r}

  dyn_mplads <- dyn_mplads %>% group_by(constituency_no) %>% mutate(ac_contr_n = n(), ac_mean_cost = mean(costnew))



dyn_mplads_mean <- dyn_mplads %>% group_by(dyn_cum_2_text) %>%
  summarise(n_pc = n_distinct(pc_name),
            mean_contract = mean(ac_contr_n),
            mean_cost = mean(ac_mean_cost),
            mean_dyas = mean(days))

 Entity <- c("Stable", "Rest")


dyn_mplads_mean%>%  kable(caption = "MPLADS 2009",col.names = c ("Entity", "N PCs","Avg. number of projects in a PC","Avg. cost sanctioned for a project", "Avg. number of days to sanction"),digits = 0)%>% kable_styling(bootstrap_options = "striped")


  #dyn_mplads %>% group_by(dyn_cum_2) %>% summarise(mean_cost = mean(costsanctionedbydistrict))

 



```

```{r}

dyn_mplads %>% group_by(dyn_cum_2_text, constituency_name) %>% 
  summarise(mean_cost = mean(costnew))

```

```{r t test to check the mean difference}



# t.test(dyn_mplads$costnew ~ dyn_mplads$dyn_cum_2) 
# 
# t.test(dyn_mplads$ac_contr_n ~ dyn_mplads$dyn_cum_2)
```

<!-- The difference in the mean of both project count and the expenditure is statistically significant. -->

------------------------------------------------------------------------

## Break-up {.tabset}

### Projects

**Question** - Is there any difference in the project choices of family politicians?

This table shows the composition of the category of the projects they choose work on.

```{r snumber of projects composition - families - non/families}
dyn_mplads %>% group_by(dyn_cum_2, category_work) %>% summarise( count = n()) %>% group_by(dyn_cum_2) %>% mutate(sum = sum(count), prop = count/sum) %>% select(dyn_cum_2, category_work, prop) %>% 
   ggplot(aes(factor(dyn_cum_2), prop, fill = category_work,label = round(prop,2)))+
   geom_bar(stat="identity", position = "stack")+
    geom_text(size = 3, position = position_stack(vjust = 0.5))+ 
    
    scale_x_discrete(labels = c("Non-Families","Families"))+
   scale_fill_grey()+
    labs(title = " MPLADS projects composition",x = "", y = "Proportion", fill = "Type of work") +
 theme_minimal()+
  coord_fixed(ratio =2)+
  theme(plot.background = element_blank(),
        axis.line.x = element_line(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_blank(),
        #legend.position = "bottom",
        axis.title = element_blank(), 
        axis.text = element_text(size = 10),
        text = element_text(family = "serif")       )
```

------------------------------------------------------------------------

This chart shows the average number of projects of each categories according to the family type.

```{r}

dyn_mplads %>% group_by(dyn_cum_2, category_work ) %>% summarise(mean_projects = mean(ac_contr_n, trim = .1)) %>% 
  ggplot(aes(factor(reorder(category_work, mean_projects)), mean_projects, fill = factor(dyn_cum_2)))+
  geom_bar(stat = "identity", position = "dodge")+
    theme_minimal()+
  scale_y_continuous(label = label_number_si())+
  scale_fill_grey (labels = c("Non-family", "Family")
   )+
  theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"))+
  labs(title = "Average count of projects",  x = "Type of project", y = "Average count") +
  theme(legend.position = "top",
        plot.background = element_blank(),
        plot.title = element_text(family = "serif",hjust = 0.5, size = 20), 
        plot.subtitle = element_text(hjust = 0.5, size = 15,
                                     margin = margin(t = 0, r = 0, b = 20, l = 0)),
        text = element_text(color = "gray20",family = "serif"),
        axis.text.x = element_text( 
                                   hjust = .5, vjust = 0),
        legend.title = element_blank(),
        legend.text = element_text(size = 15),
        axis.text = element_text(face = "italic", size = 10),
        axis.title.x = element_text(vjust = 1, size = 15,
                                  margin = margin(t = 20, r = 0, b = 0, l = 0)),  
        axis.title.y = element_text(vjust = 1, size = 15),
        axis.ticks = element_blank(),
        panel.grid.major = element_line(color = "gray50", size = .5),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()
  ) 
 



#z%>% melt(id = 1:3, measure = 4:4) %>% 
#   ggplot(aes(factor(fam_exp_cum_cat,levels=c("[0,1)","[1,6)","[6,11)","[11,21)","[21,Inf]")), value, fill = category_work))+
#   geom_bar(stat = "identity", position = "dodge")+
#   facet_grid(~dyn_cum_2)




```

------------------------------------------------------------------------

### Expenditure

**Question** - Is there any difference in the spending patterns of family politicians?

```{r spending composition}

 dyn_mplads %>% group_by(dyn_cum_2, category_work) %>% summarise(sum_cat = sum(costnew)) %>% group_by(dyn_cum_2) %>% mutate(sum_tot = sum(sum_cat), prop = sum_cat/sum_tot) %>% select(dyn_cum_2, category_work, prop) %>% 
   ggplot(aes(factor(dyn_cum_2), prop, fill = category_work,label = round(prop,2)))+
   geom_bar(stat="identity", position = "stack")+
    geom_text(size = 3, position = position_stack(vjust = 0.5))+ 
    theme_minimal()+
  scale_fill_grey()+
    coord_fixed(ratio =2)+
    scale_x_discrete(labels = c("Non-Families","Families"))+
    labs(title = " MPLADS expenditure ",x = "", y = "Proportion", fill = "Type of work") +
  theme_minimal()+
  
  theme(plot.background = element_blank(),
        axis.line.x = element_line(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_blank(),
        #legend.position = "bottom",
        axis.title = element_blank(), 
        axis.text = element_text(size = 10),
        text = element_text(family = "serif")       )


```

------------------------------------------------------------------------

**Question** : What's the average cost of a project for each categories?

```{r}
dyn_mplads %>% group_by(dyn_cum_2, category_work ) %>% summarise(mean_cost = mean(costnew, trim = .1)) %>% 
  ggplot(aes(factor(reorder(category_work, mean_cost)), mean_cost, fill = factor(dyn_cum_2)))+
  geom_bar(stat = "identity", position = "dodge")+
  theme_minimal()+
  scale_y_continuous(label = label_number_si())+
  scale_fill_grey(labels = c("Non-family", "Family"))+
  theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"))+
  labs(title = "Average cost per project",  x = "Type of project", y = "Average cost") +
  theme(legend.position = "top",
        plot.background = element_blank(),
        plot.title = element_text(family = "serif",hjust = 0.5, size = 20), 
        plot.subtitle = element_text(hjust = 0.5, size = 15,
                                     margin = margin(t = 0, r = 0, b = 20, l = 0)),
        text = element_text(color = "gray20",family = "serif"),
        axis.text.x = element_text( 
                                   hjust = .5, vjust = 0),
        legend.title = element_blank(),
        legend.text = element_text(size = 15),
        axis.text = element_text(face = "italic", size = 10),
        axis.title.x = element_text(vjust = 1, size = 15,
                                  margin = margin(t = 20, r = 0, b = 0, l = 0)),  
        axis.title.y = element_text(vjust = 1, size = 15),
        axis.ticks = element_blank(),
        panel.grid.major = element_line(color = "gray50", size = .5),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()
  ) 
```

## cost categories

We categorised the projects into three depending upon the cost of the project:

Categories:

Low - 0-.2 mn

Medium - 2.2 mn - 5 mn

High - 5 mn+

```{r}


# names(mplads)
# 
# summary(mplads$costnew)
# 
# hist(mplads$costnew) %>% scale_x_continuous(label = label_number_si())

ggplot(dyn_mplads, aes(costnew, color = dyn_cum_2_text))+
  geom_density()+ 
  theme_minimal()+ scale_y_continuous(label = label_number())+
  theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"))+
  scale_color_grey()+
  labs(title = "Project cost distribution wrt politician's identity",  x = "Cost", y = "Density") +
  theme(legend.position = "top",
        plot.background = element_blank(),
        plot.title = element_text(family = "serif",hjust = 0.5, size = 20), 
        plot.subtitle = element_text(hjust = 0.5, size = 15,
                                     margin = margin(t = 0, r = 0, b = 20, l = 0)),
        text = element_text(color = "gray20",family = "serif"),
        axis.text.x = element_text( 
                                   hjust = .5, vjust = 0),
        legend.title = element_blank(),
        legend.text = element_text(size = 15),
        axis.text = element_text(face = "italic", size = 10),
        axis.title.x = element_text(vjust = 1, size = 15,
                                  margin = margin(t = 20, r = 0, b = 0, l = 0)),  
        axis.title.y = element_text(vjust = 1, size = 15),
        axis.ticks = element_blank(),
        
  )



```

------------------------------------------------------------------------

```{r}

dyn_mplads %>% group_by(cost_cat,dyn_cum_2_text) %>% summarise(count = n()) %>% group_by(dyn_cum_2_text) %>% mutate(sum = sum(count), prop = count/sum) %>% select(-c(count,sum)) %>% kable(caption = "Project cost categories wrt politician's identity", col.names = c("Cost Categry","Politicians Identity", "Proportion of projects"), digit = 2) %>% kable_styling(bootstrap_options = "striped")

```

# MPLADS carlos

```{r}


mplads_car1 <- load("~/work/cpr/data/replication/carlos_mplads/data/mplads-eval-data.RData")


mplads_car_up <- mplads.eval %>% filter(state == "Uttar Pradesh")



mplads_car2 <- load("~/work/cpr/data/replication/carlos_mplads/data/mplads-eval-data-bureaucrats-for-imputation.RData")



mplads_car2_up <- mplads.ebureau %>% filter(state == "Uttar Pradesh")

##

mplads_car3 <- load("~/work/cpr/data/replication/carlos_mplads/data/mplads-data.RData")

mplads_car4 <- load("~/work/cpr/data/replication/carlos_mplads/data/mplads-data-bureaucrats-for-imputation.RData")

mplads_car2_up <- mplads.ebureau %>% filter(state == "Uttar Pradesh")

dyn %>% filter(constituency_no ==40  & year ==2009)

glimpse(mplads_car_up)

table(mplads_car_up$idpc)

table(mplads_car_up$session)

```

```{r, results = "asis}

dyn_ge_w_09 <- dyn_ge_w_09 %>% mutate(stable = ifelse(fam_type=="Stable", "Stable", "Rest"))

mplads_car_09 <- mplads_car_up %>% filter(session ==15)
mp_car_dyn <- inner_join(mplads_car_09,dyn_ge_w_09,by = c("idpc" = "constituency_no"))

table(mp_car_dyn$stable)

mp_car_dyn  <- mp_car_dyn %>% group_by(idpc) %>% 
  mutate(n_ac = n())

mp_car_dyn %>% group_by(stable) %>% 
  summarise(count = n(),
            ngo = mean(ngo),
            completion_time = mean(comp_time, na.rm = TRUE),
            amount = mean(amt_sanc),
            n_proj_ac = mean(n_ac),
            mean_proj_el = mean(elec_yr),
            mean_app_time = mean(app.time, na.rm = TRUE)
            ) %>% 
            kable(digits =2, type = "html") %>% 
            kable_styling()


```

```{r}

mp_car_dyn %>% group_by (stable, clean.sector) %>% summarise(count = n()) %>% 
  group_by(stable) %>% mutate(sum = sum(count), prop= count /sum) %>% 
  ggplot(aes(stable, prop, fill= clean.sector, label = ifelse(prop>.03, round(prop,2),"")))+
  geom_bar(stat = "identity",
           position = "stack")+
  geom_text(size = 3, position = position_stack(vjust = 0.5))+ 
    
    scale_x_discrete(labels = c("Non-Families","Families"))+
   #scale_fill_grey()+
    labs(title = " MPLADS projects composition",x = "", y = "Proportion", fill = "Type of work") +
 theme_minimal()+
  coord_fixed(ratio =2)+
  theme(plot.background = element_blank(),
        axis.line.x = element_line(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_blank(),
        #legend.position = "bottom",
        axis.title = element_blank(), 
        axis.text = element_text(size = 10),
        text = element_text(family = "serif")       )
```

# Census

```{r}
cen_ft <- haven::read_dta("~/work/cpr/data/replication/francesca/punishmentDTA.dta")

View(cen_ft)
```

# PMGSY {.tabset}

```{r pmgsy read}
pmgsy<- fread("~/work/cpr/UP/up-dynasties/dyn_other_data/pmgsy.csv", stringsAsFactors = FALSE)

pmgsy <- pmgsy %>% mutate(year_ac = as.numeric(case_when(`Sanctioned Year` %in% c("2007 - 2008", "2009 - 2010","2010 - 2011","2011 - 2012")~"2007",
                                     `Sanctioned Year` =="2012 - 2013" ~"2012",
                                     `Sanctioned Year` =="2018 - 2019" ~"2017",
                                     TRUE~ "Others"
                                     )))

#glimpse(pmgsy)


names(pmgsy) <- tolower(names(pmgsy))


pmgsy <- pmgsy %>% select(year, everything())%>%  select(- c(2:78)) %>% rename(constituency_no = `pc no`) %>% filter(year != 2014) 
```

## Summary table

```{r results="asis", warning=FALSE}

summarytools::dfSummary(pmgsy,
                        plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE,
          headings = FALSE,
           tmp.img.dir  = "/tmp")

 
```

```{r}


pmgsy <- pmgsy %>% filter(year ==2009)


# dyn_ae_pmgsy <- inner_join(pmgsy, dyn_ae_w, by = c("year_ac" = "year", "ac no" = "constituency_no"))


dyn_pmgsy <- merge(pmgsy,dyn_ge_w_09, by = c("year", "constituency_no"))



dyn_pmgsy$dyn_cum_2_text <- ifelse(dyn_pmgsy$fam_type=="Stable", "Family","Non-family")


#summary(pwd)

#names(dyn_pmgsy) <- make.unique(names(dyn_pmgsy))

dyn_pmgsy$fam_rel_id_uniq <-  paste(dyn_pmgsy$family_id, dyn_pmgsy$rel_id_uniq,sep = "")

dyn_pmgsy  <- dyn_pmgsy %>% group_by(fam_rel_id_uniq) %>% mutate(n_proj_ind = n())
```

## total stats

```{r}


dyn_pmgsy %>% group_by(dyn_cum_2_text) %>% summarise(count = n(), sum(`road length (kms)`), sum(sanctionedcostnew)) %>% kable(caption = "PMGSY across years" ,col.names = c ("Loksabha Term", "Number of projects", "Length coverd (Kms)", "Total sanctioned amount (Lakhs)"),digits = 0)%>% kable_styling(bootstrap_options = "striped")


```

## Constituency level avg.

```{r}


dyn_pmgsy$sanc_cost_rup <-(dyn_pmgsy$sanctionedcostnew)*100000

dyn_pmgsy <- dyn_pmgsy %>% group_by(year,constituency_no) %>% mutate(ac_proj_no = n())


 

#  dyn_pmgsy  %>% group_by(dyn_cum_2_text) %>% summarise(mean_proj = mean(ac_proj_no), mean_cost = mean(sanc_cost_rup ), mean_rd_len = mean(`road length (kms)`))
# 
# #,sum_rd = sum(`road length (kms)`),sum_cost = sum(`sanction cost`), cost_p_km = (sum_rd/sum_cost)*100000) 
# 
# 
# Entity <- c("Non-family", "Family")
#  
#  cbind(Entity,dyn_pmgsy_mean) %>% select(-dyn_cum_2) %>%  kable(caption = "PMGSY summary wrt constituency type", col.names = c ("Type of constituency", "Average number of projects","Avergae expenditure per project", "Average road length (km)"),digits = 1)%>% kable_styling(bootstrap_options = "striped")

 #summary(pmgsy)
 
 
 dyn_pmgsy %>% group_by(dyn_cum_2_text) %>% summarise(sum = sum(`road length (kms)`), count = n_distinct(constituency_no),mean_proj_con = n()/count,mean_proj = mean(`road length (kms)`), mean_con = sum/count) %>% select(dyn_cum_2_text,mean_proj_con,mean_proj, mean_con) %>% kable(caption = "PMGSY summary stats wrt constituency type", col.names = c("Constituency Type","Average number of projects"," Average length per project", "Average length over all"),digits = 1)%>% kable_styling(bootstrap_options = "striped")





```

## Contractors

```{r}


dyn_pmgsy <- dyn_pmgsy %>% group_by(constituency_no) %>% mutate(cont_uniq = n_distinct(`contractor name`))


dyn_pmgsy  <- dyn_pmgsy %>% group_by(fam_rel_id_uniq) %>% mutate(n_cont_ind = n_distinct(`contractor name`))

dyn_pmgsy %>% group_by(dyn_cum_2_text) %>% summarise(mean(n_cont_ind),sum(sanctionedcostnew)/n_distinct(`contractor name`)) %>% 
kable(caption = "PMGSY average number of contractors and amount sanctioned  wrt constituency type", col.names = c ("Type of constituency", "Average number of unique contractors", "AAvergae amount sanctioned to a unique contractor (Lakhs)"),digits = 0)%>% kable_styling(bootstrap_options = "striped")

```

# NREGA {.tabset}

```{r file config}





nrega <- fread("~/work/cpr/UP/up-dynasties/dyn_other_data/nrega.csv", stringsAsFactors = FALSE)

dyn_ge_w_09 <- dyn %>% filter(year == 2009 &position == 1)


#glimpse(nrega)

# 
names(nrega) <- tolower(names(nrega))
# 
nrega <- nrega %>% select(- c(343:417)) %>%   rename(constituency_no = `pc no`) %>%select(constituency_no,worked, workdays,workdays_jc,disbursed_all,ratio) 

# 
# dyn_ge_w <- dyn %>% filter(election_type == "GE" & position==1)
# 
# 
dyn_nrega <- merge(dyn_ge_w_09,nrega, by = c("constituency_no"))
# 
# 
#names(dyn_nrega) <- make.unique(names(dyn_nrega))


#summary(nrega)

dyn_nrega$dyn_cum_2_text <- ifelse(dyn_nrega$fam_type=="Stable", "Family","Non-family")

dyn_nrega$fam_rel_id_uniq <-  paste(dyn_nrega$family_id, dyn_nrega$rel_id_uniq,sep = "")



 dyn_nrega  <- dyn_nrega%>% group_by(fam_rel_id_uniq) %>% mutate(n_proj_ind = n())
```

**Variable summary**

Workdays - total days worked under NREGS

-- Coded as: log(Workdays + 1)

Worked - number of individuals who worked under NREGS

-- Coded as: log(Worked + 1)

Deposits - sum of disbursements to laborers' bank and post office accounts

-- Coded as: log(Bank Deposits + Post office Deposits + 1)

## Summary table

```{r results="asis", warning=FALSE}

summarytools::dfSummary(nrega,
                        plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE,
          headings = FALSE,
           tmp.img.dir  = "/tmp")

 
```

## total stats

```{r}

# dyn_nrega %>% group_by(dyn_cum_2_text) %>% summarise(n()/n_distinct(constituency_no))
# 
# 
# dyn_nrega %>% group_by(dyn_cum_2) %>% summarise(n())


dyn_nrega %>% group_by(year) %>% summarise(count = n(),total_workdays =sum(workdays), mean_len_proj = total_workdays/count,proj_con =n()/n_distinct(constituency_no), len_con = sum(workdays)/n_distinct(constituency_no)) %>%  kable(caption = "Summary of NREGA", col.names = c ("Year", "Total number of projects","Total days", "Average days per project","Average number of projects per constituency","Average days per constituency "),digits = 1)%>% kable_styling(bootstrap_options = "striped")

```

## Constituency avg.

```{r}


 dyn_nrega %>% group_by(dyn_cum_2_text) %>%
   summarise(sum = sum(workdays), count = n_distinct(constituency_no),mean_proj_con = n()/count, mean_con = sum/count, mean_workers_con = sum(worked)/count, mean_disbursed = sum(disbursed_all)/count) %>% select(dyn_cum_2_text,mean_proj_con, mean_con,,mean_workers_con,mean_disbursed ) %>%

  kable(caption = "NREGA summary stats wrt constituency type", col.names = c("Caste group","Average number of projects", "Average days ",  "Average number of poeple", "Average money disbursed"),digits = 1)%>% kable_styling(bootstrap_options = "striped")

```

# Pol consequences

## UP CV {.tabset}

This is carried out using AE election booth level data from 2007, 2012, 2017 UP elections

```{r}
raphael <- fread("~/work/cpr/UP/up-dynasties/dyn_other_data/rafael-dataset.csv", stringsAsFactors = FALSE)


 raphael_up <- raphael %>% select(year, constituency_no, position, votes = totalvotes, partynew, partypercent) %>% filter(year>= 2009)
 
 # 
 # raphael_up %>% group_by(year, constituency_no) %>% mutate(total_votes = sum(votes))
 # 
```

```{r}

ps_17 <- fread("~/work/cpr/data/raphael/upvidhansabha2017.csv")

```

```{r}
dyn <- dyn %>% group_by(election_type, year, constituency_no) %>% mutate(dyn_vs_nondyn = ifelse(any(dyn_cum_2==1) & any(dyn_cum_2==0),1,0), dyn_w_vs_nondyn = ifelse(dyn_vs_nondyn==1 & position==1 &dyn_cum_2==1,1,0))
  
  

 
 dyn_ae <- dyn %>% filter(election_type=="AE" & position %in% c(1,2))
 
dyn_ae<- dyn_ae %>% mutate(margin_cat = cut(margin_percentage, breaks = c(0,1,3,5,7,10,15,20, Inf), labels = c("1","3","5","7","10","15","20","21")))
                  
                  
 
dyn_raphael <- merge(dyn_ae, raphael_up, by = c("year", "constituency_no","position"), allow.cartesian = TRUE)


library(DescTools)



cv <- dyn_raphael%>%group_by(year, constituency_no,position) %>% summarise(cv =CoefVar(partypercent, na.rm = TRUE)) 


dyn_cv <- inner_join(dyn_ae, cv, by =c( "year", "constituency_no","position"))
```

### CV density graphs

```{r}
ggplot(filter(dyn_cv %>% filter(position==1) ), aes( cv,fill =fam_type))+
  geom_density()+
  xlim(0,3)+
  theme_light()
  
```

### Linear regression

```{r results = "asis"}

dyn_cv$dynast <- ifelse(dyn_cv$fam_type=="Stable",1,0)

library(lfe)

fit.up <- felm(cv~dynast+margin_percentage+vote_share_percentage+enop+incumbent+log(electors)+turnout_percentage|constituency_name+year|0|constituency_name, data=subset( dyn_cv %>% filter(position ==1)))




addlines <- list(c('Fixed effects',"Year and Constituency"), c("Clustered SE" ,"Constituency"))





 #drop <- c("caste_uc", "caste_obc", "caste_sc", "caste_muslim","(Intercept)","Constant","mov_assets_ratio:assets")
library(stargazer)

stargazer(fit.up, type = "html", add.lines = addlines)

```

```{r}
rdd <- dyn_cv%>% ungroup() %>% filter(dyn_vs_nondyn==1&margin_percentage<=5 &position%in% c(1,2))  %>% mutate(mv = ifelse(dynast==0,-margin_percentage, margin_percentage)) %>% select(year,constituency_no,position,dynast,margin_percentage,mv,cv)

```

### close elections [5 PC] break up

```{r}


rdd %>% filter(position ==1) %>% group_by(dynast) %>% summarise(count = n()) %>% kable() %>% kable_styling(full_width = F)


```

### rdd graph

```{r}
ggplot(rdd %>% filter(cv<2.5 & position ==1), aes(mv,cv , color = factor(dynast)))+
  geom_point()+
    geom_smooth(method="lm", se= FALSE)+
  geom_vline(xintercept = 0)+
    scale_color_discrete(labels = c("non-dynast winner", "dynast winner"))+
  #guides(color = FALSE)+
  ylim(0,1)+
   labs(x = "Margin of victory", y = "co-efficient of variation")+
  theme(legend.position = "bottom", legend.title = element_blank())
  

```

### RDD model

```{r results="asis"}


fit.rdd <- felm(cv~factor(dynast), data = subset(rdd %>% filter(cv<2.5& position ==1)))

# fit <- felm(cv~factor(dynast)+ position, data = subset(rdd %>% filter(cv<2.5& position ==1)))


stargazer(fit.rdd ,type = "html", covariate.labels = c("Stable", "Constatnt"))




```
