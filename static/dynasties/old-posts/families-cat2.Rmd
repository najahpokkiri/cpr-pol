---
title: "Families"
author: ""
date: "2020-02-07"
params:
  orig_date: "Original Publish Date: 21 July, 2020"
  update_date: !r paste("Updated on:", format(Sys.time(), '%I:%m  %p -- %d %B, %Y'))
output:
  html_document:
    theme: readable
    toc: TRUE
    toc_float: TRUE
    toc_depth: 5
    number_sections: TRUE
    fig_width: 6            
editor_options: 
  chunk_output_type: inline

---

---

### Document History

`r params$orig_date`

`r params$update_date`

---

```{r set up, warning=FALSE, include=FALSE, message= FALSE}

knitr::opts_chunk$set(cache = FALSE,echo = FALSE, message=FALSE, warning = FALSE,fig.width = 16/2, fig.height = 9/2)


library(tidyverse)
library(data.table)
library(knitr)
library(kableExtra)
library(scales)
library(gridExtra)
library(stargazer)
library(ggbump)
library(patchwork)
`%!in%` = Negate(`%in%`)

select <- dplyr::select
```

In this post we further analyse the families. We categorised them into two - declining and rising. We track down all the families started in 1970s till 2007. Then we assess their performance in the elections held after 2007. This includes 3 General elections and 2 Assembly elections. If they have one at least one election in these 5 elections we call them rising dynasties and rest of them as declining dynasties.

---

The following table shows the difference the longevity of these two groups






```{r file config}
dyn <- read.csv("D:/cpr/UP/up-dynasties/dyn_other_data/dyn_all.csv")

dyn_ae_ge <- dyn %>% filter(election_type %in% c("AE", "GE") & family_id != "")

dyn_ae_ge <- dyn_ae_ge %>% mutate(land_decile = ntile(land,10),n_mem = n_distinct(rel_id_uniq))


dyn_ae_ge <- dyn_ae_ge  %>% group_by(election_id) %>% mutate(term_duration= max(term_duration)) %>% ungroup()

dyn_ae_ge <- dyn_ae_ge %>% group_by(family_id) %>% mutate(n_mem = n_distinct(rel_id_uniq),max_year = max(year), min_year = min(year),life_span = max_year-min_year+term_duration)

   dyn_ae_ge <- dyn_ae_ge %>% group_by(family_id) %>% mutate(n_el_w =n_distinct(election_id[position==1]), n_el_c = n_distinct(election_id),
                                                             n_el_w_pat_ae_ge = length(year[relative_id==1 & position ==1 &  dyn_cum_2 ==0]))
   
   
  
gender <- dyn_ae_ge  %>% filter(relative_id==1) %>% select(family_id,mem1_gender =sex) %>% distinct(family_id, .keep_all = TRUE)

# gender_tot <- dyn_ae_ge  %>% filter(relative_id==1) %>% select(family_id,mem1_gender =sex, dyn_tot_2) %>% distinct(family_id, .keep_all = TRUE)

dyn_ae_ge <- left_join(dyn_ae_ge, gender, by = "family_id")


  
dyn_ae_ge  <- dyn_ae_ge  %>% group_by(family_id) %>% mutate(n_el_w_pat_ae_ge = length(year[relative_id==1 & position ==1 &  dyn_cum_2 ==0]))


dyn_ae <- dyn %>% filter(election_type =="AE")



dyn_ae <- dyn_ae %>% group_by(con_id_uniq)%>%  mutate(conid_n = n())



dyn_ae <- dyn_ae %>% mutate(delim = case_when(grepl("x00",con_id_uniq, ignore.case = TRUE)~"diss/new",
                                              grepl("0000",con_id_uniq, ignore.case = TRUE)~"diss/new",
                                              TRUE~"old"))




res <- dyn_ae %>% filter(year %in% c(2007,2012)& delim=="old") %>% distinct(year,con_id_uniq, .keep_all= TRUE) %>% select(year,con_id_uniq, constituency_type)


res_12<- res %>% filter(year==2012)

res_07<- res %>% filter(year==2007)

res_07_12 <- merge(res_07, res_12, by = "con_id_uniq")

delim_change <- res_07_12 %>% mutate(delim_cat = paste0(res_07_12$constituency_type.x,res_07_12$constituency_type.y), delim_change = ifelse(delim_cat %in% c("GENSC","SCGEN"),1,0)) %>% select(con_id_uniq, delim_change)

dyn_ae_ge <- left_join(dyn_ae_ge, delim_change, by = "con_id_uniq")

dyn_ae_ge  <- dyn_ae_ge %>% mutate(delim_change=ifelse(is.na(delim_change) & election_type=="AE", 1, delim_change))

```





```{r}


dyn_indus <- read.csv("D:/cpr/UP/up-dynasties/ae_ge_indus.csv")

dyn_indus <- dyn_indus %>% filter(ï..election_type %in% c("AE", "GE"))


dyn_indus <- dyn_indus %>% mutate(indus_2 = ifelse(indus_2>0,indus_2,0), indus_3 = ifelse(indus_3>0,indus_2,0),indus_4 = ifelse(indus_4>0,indus_4,0)) %>% select(ï..election_type,year, pid, indus_2, indus_3, indus_4)

names(dyn_indus)[1] <- "election_type"

dyn_ae_ge <- left_join(dyn_ae_ge, dyn_indus, by = c("election_type", "year", "pid"))

dyn_ae_ge <- dyn_ae_ge %>% mutate(indus_2_c = ifelse(indus_2>0,1,0),indus_3_c = ifelse(indus_3>0,1,0), indus_4_c = ifelse(indus_4>0,1,0), indus_count = indus_2_c+indus_3_c+ indus_4_c)



cabinet <- read.csv("D:/cpr/UP/up-dynasties/dyn_other_data/up_cabinet_01.07.20.csv")

#glimpse(cabinet)

names(cabinet) <- tolower(names(cabinet))

names(cabinet) <- make.unique(names(cabinet))

cabinet <- cabinet %>% rename(year = election_year_1)





cabinet$rel_id_unique <- as.numeric(cabinet$rel_id_unique)

cabinet <- cabinet %>% filter(rel_id_unique >0 )

#cabinet %>% filter(is.na())


cabinet <- cabinet %>% mutate(pre_90 = case_when(dplyr::between(year, 1977,1990)~ 1,
                             TRUE ~0), post_90 =case_when(dplyr::between(year, 1990,2017)~ 1,
                             TRUE ~0) )


#table(cabinet$post_90)


dyn_cabinet <-  cabinet  %>% filter(year!= "" & family_id >0 & family_id != "UK") %>% group_by(family_id) %>%summarise(n_sc_minster = n(), minister_dur = sum(term_months, na.rm = TRUE), pre_90_n = sum(pre_90), post_90_n = sum(post_90))

dyn_cabinet$min_dur_yr <- round(dyn_cabinet$minister_dur/12,2)





dyn_ae_ge <- merge(dyn_ae_ge,dyn_cabinet, by ="family_id", all.x =TRUE )
```


```{r}
# tab <- dyn_ae_ge_fam %>% group_by(family_id) %>% arrange(year) %>%  filter(dyn_cum ==1 &min(year)) %>% distinct(family_id, .keep_all = TRUE) %>% group_by(year) %>% summarise(count = n()) %>% kable()
dyn_ae_ge <- dyn_ae_ge %>% mutate(decade = cut(year, breaks = c(1970,1980,1990,2000,2010,2020), labels = c(1970,1980,1990,2000,2010), include.lowest = TRUE))
dyn_ae_ge$decade <-  year(as.Date(ISOdate(dyn_ae_ge$decade, 1, 1)))


# 
 dyn_ae_ge<- dyn_ae_ge %>% group_by(family_id) %>% mutate( max_year = max(year)) 
# 
# 
# dyn_ae_ge$life_span <- dyn_ae_ge$max_year - dyn_ae_ge$

```

```{r}
## Involvemnt



# 
# inv <- read.csv("D:/cpr/UP/up-dynasties/ae_ge_lb_who_is_who.csv")
# 
# inv <- inv  %>% dplyr::select(family_id,association_inv,org_inv, poitical_inv )
# 
# dyn_ae_ge <- merge(dyn_ae_ge,inv, by ="family_id", allow.cartesian = TRUE, all.x =TRUE )

```




<!-- ## 2nd category -->

```{r}

## life span
dyn_ae_ge_fam <- dyn_ae_ge  %>% filter(dyn_tot_2 == 1)


fam_tab <- rbind(dyn_ae_ge_fam %>% group_by(family_id) %>% filter( dyn_cum_2==0 ) %>% slice(which.max(year))%>% select(year, family_id,dyn_cum_2),

dyn_ae_ge_fam %>% group_by(family_id) %>% filter(dyn_cum_2==1  ) %>% slice(which.min(year)) %>% select(year, family_id,dyn_cum_2 )) %>%pivot_wider(values_from = year, names_from= dyn_cum_2) 



fam_tab <- fam_tab %>% mutate(`0` = ifelse(is.na(`0`), `1`,`0`), diff = `1`-`0`)



dyn_ae_ge_fam <- inner_join(dyn_ae_ge_fam, fam_tab, by = "family_id")


dyn_ae_ge_fam$life_span <- dyn_ae_ge_fam$max_year - dyn_ae_ge_fam$`0`

```


```{r}
dyn_ae_ge_fam  <- dyn_ae_ge_fam %>% mutate(id = paste0(family_id, relative_id, rel_id_rep))

dyn_ae_ge_fam <- dyn_ae_ge_fam %>%group_by(family_id)%>% mutate(n_pre_08 = n_distinct(id[year<= 2007]), n_post_08 = n_distinct(id[year>2007]))





```




```{r}
dyn_ae_ge_fam <- dyn_ae_ge_fam %>% mutate(success_cat = case_when(n_pre_08 >=2 & n_post_08==0 ~"Declining",
                                                                  n_pre_08>=2 & n_post_08 >0 ~"Stable",
                                                                  n_pre_08 <=1 & n_post_08 >=1 ~"Rising",
                                             TRUE~"OTHERS"))


dyn_ae_ge_fam_out <- dyn_ae_ge_fam %>% distinct(family_id, .keep_all = TRUE) %>% select(family_id, success_cat)


#write.csv(dyn_ae_ge_fam_out, "D:/cpr/UP/up-dynasties/dyn_other_data/fam_cvat_list.csv")


# dyn_ae_ge_fam <- dyn_ae_ge_fam  %>%
#    mutate(across(c("district_name"), ~ifelse(.=="", NA, as.character(.))))
# 
# dyn_ae_ge_fam$district_name <- replace_na(dyn_ae_ge_fam$district_name , "ZNA")

dyn_ae_ge_fam_uniq <- dyn_ae_ge_fam  %>% group_by(family_id)%>% arrange(election_id)%>% distinct(family_id, .keep_all = TRUE)


#table(dyn_ae_ge_fam_uniq$success_cat)

#dyn_ae_ge_fam_uniq  %>%filter(n_el_w>0) %>%  group_by(success_cat) %>% summarise(count = n())
```



```{r}
inv <- read.csv("D:/cpr/UP/up-dynasties/dyn_other_data/upwhoiswho.csv")

inv$position <- as.numeric(inv$position)

inv <- inv %>% select(election_type, year,constituency_no, position, org_inv, association_inv,poitical_inv )


# 
# inv <- inv  %>% dplyr::select(family_id,association_inv,org_inv, poitical_inv )
# 
# dyn_ae_ge <- merge(dyn_ae_ge,inv, by ="family_id", allow.cartesian = TRUE, all.x =TRUE )





dyn_ae_ge_fam <- left_join(dyn_ae_ge_fam, inv, by = c("election_type","year","constituency_no","position"))

dyn_ae_ge_fam <- dyn_ae_ge_fam %>% group_by(family_id) %>% mutate(org_inv_b =ifelse( sum(!is.na (org_inv) )>0,1,0),
                                          asoc_inv_b =  ifelse(sum(!is.na (association_inv))>0,1,0),
                                          pol_inv_b =  ifelse(sum(!is.na (poitical_inv))>0,1,0))
```


```{r}
dyn_ae_ge_fam$ind_cout_new = dyn_ae_ge_fam$ind_c1+dyn_ae_ge_fam$ind_c2+dyn_ae_ge_fam$ind_c3+dyn_ae_ge_fam$ind_c4+dyn_ae_ge_fam$ind_c5+dyn_ae_ge_fam$ind_c6+dyn_ae_ge_fam$ind_c7

dyn_ae_ge_fam  <- dyn_ae_ge_fam  %>% group_by(family_id)%>% 
  mutate(n_el_w_ge = sum(ifelse(position==1& election_type =="GE",1,0)),
         n_el_c_ge = sum(ifelse( election_type =="GE",1,0)),
         
         n_el_w_ae = sum(ifelse(position==1& election_type =="AE",1,0)),
         n_el_c_ae = sum(ifelse( election_type =="AE",1,0)),
         n_el_w= sum(ifelse(position==1,1,0)),
         n_el_c =n(),
         minister_dur= replace_na(minister_dur,0),
         minister = ifelse(minister_dur>0,1,0)) %>% ungroup()

dyn_ae_ge_fam$land_cat <- cut(replace_na(as.numeric(dyn_ae_ge_fam$land),0), breaks = c(0,1,100,500,Inf), include.lowest =TRUE, labels = c( "0","1-100","100-500","500-1000"))

dyn_ae_ge_fam$edu <- as.numeric(paste(dyn_ae_ge_fam$school, dyn_ae_ge_fam$college, sep = ""))


dyn_ae_ge_fam$edu_cat <- ifelse(dyn_ae_ge_fam$edu ==10,1,ifelse(dyn_ae_ge_fam$edu ==1,2,ifelse(dyn_ae_ge_fam$edu ==11,3,0)))
dyn_ae_ge_fam$edu_cat <- case_when(dyn_ae_ge_fam$edu ==10 ~"School",
                                        dyn_ae_ge_fam$edu ==1~"College",
                                        dyn_ae_ge_fam$edu ==11~"Both",
                                        TRUE ~"None"

                                        )

fam_df <- dyn_ae_ge_fam %>% group_by(family_id) %>% mutate(PCs = paste(unique(constituency_name[election_type=="GE"]),collapse = " , "),
                                                           Districts = paste(unique(district_name),collapse = " , "),
                                                           ACs = paste(unique(constituency_name[election_type=="AE"]),collapse = " , "),
                                                 members = paste(unique(relative_id),collapse = " , "),
                                                 parties = paste(unique(party),collapse = " , ")) %>% 
  arrange(-year) %>% 
  distinct(family_id, .keep_all = TRUE) %>% select(family_id, Districts,ACs,PCs,parties, caste_name, members ,n_mem,first_member = patriarch_name,entry_year = min_year,latest_election= election_id,latest_candidate =candidate_name, latest_constiteuncy = constituency_name ,latest_party = party, latest_position = position,success_cat,
                                                   `Elections contested`= n_el_c, `Elections won`= n_el_w,`Elections contested AE`=n_el_c_ae,`Elections won AE`= n_el_w_ae, `Elections contested GE`=n_el_c_ge,`Elections won GE`=n_el_w_ge,
                                                   land = land_cat, `Petrol Pumps` = ind_c1,`Construction & Transport`=ind_c2,`Brick klin and Sand mining` = ind_c3,`Agri business` =ind_c4,`Shops and showrooms`=ind_c5,`Small Business`=ind_c6,
                                                   edu_own = edu_cat,minister,org_inv_b, asoc_inv_b,pol_inv_b,
                                                     )



library(openxlsx)
#openxlsx::write.xlsx(fam_df, "D:/cpr/UP/up-dynasties/dyn_other_data/fam_df.xlsx")


```



# Summary Stats

## Elite types{.tabset}

### Definitions


![](D:/cpr/UP/up-dynasties/dyn_other_data/def_2_elite.png)

<!-- Eventhough we have 300 families in total, in this analysis has come down to 189. This is because, we are tracking families which are active before 2007. Then we asses how they have performed in last one decade or so to asses their performance. Criteria to be successful is that they have won one or more elections after 2007. -->

### Break-up of elite categories

```{r}


dyn_ae_ge_fam_uniq %>% ungroup() %>%group_by(success_cat) %>% summarise(count = n()) %>% kable() %>% kable_styling(full_width = F)

```

---

### turncoats and same party

```{r}

dyn_ae_ge_fam %>% group_by(election_type,success_cat) %>% summarise(turncoat = mean(turncoat), same_party = mean(same_party, na.rm = TRUE)) %>% kable(digits =2)

#table(dyn_ae_ge_fam$turncoat)

```


### delim change


```{r}

dyn_ae %>% filter(year>2009)%>% distinct(con_id_uniq, .keep_all = TRUE) %>%  group_by(delim, constituency_type) %>% summarise(count = n()) %>% group_by(delim)%>%mutate(total =sum(count)) 
```



### years to be a  family

```{r}


# dyn_ae_ge_fam %>% group_by(family_id) %>% filter( dyn_cum_2==0 ) %>% slice(which.max(year))%>% select(year, family_id,dyn_cum_2)


fam_tab <- rbind(dyn_ae_ge_fam %>% group_by(family_id) %>% filter( dyn_cum_2==0 ) %>% slice(which.max(year))%>% select(year, family_id,dyn_cum_2),

dyn_ae_ge_fam %>% group_by(family_id) %>% filter(dyn_cum_2==1  ) %>% slice(which.min(year)) %>% select(year, family_id,dyn_cum_2 )) %>%pivot_wider(values_from = year, names_from= dyn_cum_2) 




```



```{r}


fam_tab <- rbind(dyn_ae_ge_fam %>% group_by(family_id) %>% filter( dyn_cum_2==0 ) %>% slice(which.max(year))%>% select(year, family_id,dyn_cum_2),

dyn_ae_ge_fam %>% group_by(family_id) %>% filter(dyn_cum_2==1  ) %>% slice(which.min(year)) %>% select(year, family_id,dyn_cum_2 )) %>%pivot_wider(values_from = year, names_from= dyn_cum_2) 


# 
# fam_tab %>% mutate(entry = `0`==`1`) %>% group_by(entry) %>% tally()


# mean(fam_tab$diff)

fam_tab <- fam_tab %>% mutate(`0` = ifelse(is.na(`0`), `1`,`0`), diff = `1`-`0`)
# 
# fam_tab %>% filter(diff==0)

# fam_tab %>% mutate(lag_group = cut(breaks= c()))


medx <- median(fam_tab$diff)
meanx <- mean(fam_tab$diff)



year_entry <- ggplot(fam_tab %>% filter(diff>=0), aes(diff))+
  geom_density(size = .7, color = 'black')+
  labs(subtitle = "Years to second member entry", x = "Years")+
  #xlim(0,45)
  #ylim(.0,.15)+
  geom_vline(xintercept = medx, color = "red")+
  geom_vline(xintercept = meanx, color = "blue")+
    geom_text(aes(x=(medx-.7), label="Median", y=0.01), colour="red", size =4, angle = 90) +
  geom_text(aes(x=(meanx +.7), label="Mean", y = 0.01), colour="blue", size = 4, angle = 90)+
 theme_minimal()+
  theme(
        plot.background = element_blank(),
        plot.subtitle = element_text(
                                  margin = margin(t = 0, r = 0, b = 20, l = 0)),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line.x = element_line(),
        axis.ticks.y = element_line()
        )



# dyn_ae_ge_fam %>% select(year, dyn_cum_2, relative_id) %>% group_by(family_id, year) %>% summarise(val = sum(dyn_cum_2)/n())
```




<!-- ### relative -->
<!-- ```{r} -->
<!-- dyn <- read.csv("D:/cpr/UP/up-dynasties/dyn_other_data/dyn_family.csv") -->

<!-- dyn_ae_ge <- dyn %>% filter(election_type %in% c("AE", "GE")) -->



<!-- dyn_ae_ge_fam %>% group_by(family_id) %>% filter( dyn_cum_2==1 ) %>% slice(which.min(year))%>% select(year, family_id,dyn_cum_2, relative_id) %>% filter(relative_id==1) -->

<!--  %>%pivot_wider(values_from = year, names_from= dyn_cum_2)  -->



<!-- dyn_ae_ge_fam %>% filter(dyn_cum_2==1) %>% distinct(family_id, .keep_all = TRUE)%>% group_by(level) %>% summarise(count = n()) -->

<!-- ``` -->


---

## Viz & summary {.tabset}


### A note on the life span metric


  Life span is a metric that measures the years that a family or politicains have been active in politcs. Since our dynasty data data starts from 1974 and ends with politicinas who are in term till 2024, this duration of period will start from 2/3/5/6 and end at 50 years. So within this period, the maximum life span that a family can have is 50 years. 
  
In simple words, this metric checks if a politician or a family was active ina certain year and adds up that year. We binary value is given to every year that is 1 for someone's presence and 0 otherwise. Here we have to note that, we do not consider how many members are present at a time rather we just consider that the family was active in that particular year. 

We define active in politics as being either runner-up or winner that election. Few examples:

- Politician A contested in 1974, 2002 and his son contested in 2017. The life span of this family would be 15 years. See that we add a value of one for each year they are in power.

- A politician and his wife contested together in 2012 and later on his wife resigned from assembly and contested in 2014 Loksabha election. In this case, this family's life span would be 7 years

 **This metric also have some flaws, some of them are;**
 
- this does not diffrentiate between a winner and runner-up

- this does not compensate for the years in which multiple members are cotesting together.






### Ownership of edu categories wrt elite categories


```{r}
dyn_ae_ge_fam_uniq$edu <- as.numeric(paste(dyn_ae_ge_fam_uniq$school, dyn_ae_ge_fam_uniq$college, sep = ""))


dyn_ae_ge_fam_uniq$edu_cat <- ifelse(dyn_ae_ge_fam_uniq$edu ==10,1,ifelse(dyn_ae_ge_fam_uniq$edu ==1,2,ifelse(dyn_ae_ge_fam_uniq$edu ==11,3,0)))
# 
dyn_ae_ge_fam_uniq$edu_cat <- case_when(dyn_ae_ge_fam_uniq$edu ==10 ~1,
                                        dyn_ae_ge_fam_uniq$edu ==1~2,
                                        dyn_ae_ge_fam_uniq$edu ==11~3,
                                        TRUE ~0

                                        )

  dyn_ae_ge_fam_uniq %>% group_by(success_cat, edu_cat) %>% summarise(count = n()) %>%
    group_by(success_cat) %>% mutate(sum = sum(count), pc = count/sum) %>%
    ggplot(aes(success_cat,pc, fill = factor(edu_cat), label = round(pc,2)))+

    geom_bar(position = "stack", stat = "identity")+
     geom_text(size = 2.5, position = position_stack(vjust = 0.5))


  

  
  




edu_tab <- dyn_ae_ge_fam_uniq %>%  filter(!is.na(edu)) %>% group_by(success_cat,edu) %>% summarise(count = n())  %>% group_by(success_cat) %>% mutate(sum = sum(count),prop= count/sum) %>% filter(edu!= 0) %>%  arrange(edu, -prop) 

#edu_tab$id=rep(c(1:3),3)

edu_tab$success_cat <- factor(edu_tab$success_cat , levels = c("Stable","Rising", "Declining"))


ggplot(edu_tab , aes(x= reorder(as.factor(edu),-prop), prop )) +   
  geom_bar(aes(fill = as.factor(success_cat)), position = "dodge", stat="identity")+
  theme_minimal()+
  scale_x_discrete(labels=(c( "School" ,"College","Both")))+
  #scale_fill_manual (labels = c("Stable", "Rising", "Declining"))+
  labs(title = "Ownership of educational institutions wrt success", 
       x = "", y = "Proportion") +
  theme(legend.position = "top",plot.title = element_text(hjust = 0.5))+
  theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"),
        plot.title = element_text(hjust = 0.5, size = 18, family = "serif", 
                                  margin = margin(t = 0, r = 0, b = 20, l = 0)), 
        text = element_text(color = "gray20",family = "serif"),
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text = element_text(face = "italic", size = 14),
        axis.title.x = element_text(vjust = -1, size = 16),
        axis.title.y = element_text(vjust = 2, size =16),
        axis.ticks.y = element_blank(),
        axis.line= element_line(color = "gray40", size = .5),
        axis.line.y = element_blank(),
        panel.grid.major = element_line(color = "gray50", size = .5),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()
          
  ) 

```

### Land wrt elite cat.


we were using boxplot for this earlier, then we switched to box plot since the barplot was not showing any visible difference.

```{r}
dyn_ae_ge_fam_uniq$land <- as.numeric(dyn_ae_ge_fam_uniq$land)

dyn_ae_ge_fam_uniq$land <- replace_na(dyn_ae_ge_fam_uniq$land,0)

dyn_ae_ge_fam_uniq$land <- ifelse(dyn_ae_ge_fam_uniq$land>1000,1000,dyn_ae_ge_fam_uniq$land)


# dyn_ae_ge_fam_uniq$land_quartile <- as.numeric(cut(dyn_ae_ge_fam_uniq$land, breaks = c(0,1,100,250,500,Inf), include.lowest =TRUE, labels = c("0","1","2","3","4")))

dyn_ae_ge_fam_uniq$land_cat <- cut(dyn_ae_ge_fam_uniq$land, breaks = c(0,1,100,250,500,Inf), include.lowest =TRUE, labels = c( "very small", "small", "medium", "large", "very large"))


  dyn_ae_ge_fam_uniq %>% group_by(success_cat, land_cat) %>% summarise(count = n()) %>%
    group_by(success_cat) %>% mutate(sum = sum(count), pc = count/sum) %>%
    ggplot(aes(success_cat,pc, fill = land_cat, label = round(pc,2)))+

    geom_bar(position = "stack", stat = "identity")+
     geom_text(size = 2.5, position = position_stack(vjust = 0.5))+
    theme_light()+
        theme_minimal()+
    labs(title = "Land holdings wrt success  ",x = "", y = "Proportion", fill = "") +
    theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"))+
  theme(plot.background = element_blank(),
        axis.line.x = element_line(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_blank()
       )


#   geom_histogram(binwidth = 50, color = "steelblue")+
#   facet_wrap(~success_cat) %

# ggplot(dyn_ae_ge_fam_uniq %>% filter(land<600), aes(success_cat,land))+
#   geom_boxplot()+
#   
#     geom_boxplot(outlier.shape = NA)+
#  # ylim(0,1000)+
#   theme_minimal()
# 
# land <- dyn_ae_ge_fam_uniq %>% filter(land<600) 
# 
# ggplot(dyn_ae_ge_fam_uniq %>% filter(land<600), aes(land, fill = success_cat))+
#   #stat_density(trim = .5)
#   geom_density(alpha = .5 )
#   geom_boxplot()+
#     geom_boxplot(outlier.shape = NA)+
#  # ylim(0,1000)+
#   theme_minimal()
```

---


```{r}
dyn_ae_ge_fam_uniq %>% group_by(success_cat) %>% summarise(mean(land, na.rm = TRUE, trim = .05)) %>% kable() %>% kable_styling(full_width = F)



```



---



### Industries {.tabset}

#### family-cat


```{r}





# 
# cbind(dyn_ae_ge_fam_uniq %>% ungroup() %>% filter(success_cat=="Stable")%>%   summarise_at( c("ind_c1","ind_c2","ind_c3","ind_c4","ind_c5","ind_c6","ind_c7"),~mean(., na.rm = TRUE)) %>% transpose(),
#       dyn_ae_ge_fam_uniq %>% ungroup() %>% filter(success_cat=="Rising")%>%   summarise_at( c("ind_c1","ind_c2","ind_c3","ind_c4","ind_c5","ind_c6","ind_c7"),~mean(., na.rm = TRUE)) %>% transpose(),
#       dyn_ae_ge_fam_uniq %>% ungroup() %>% filter(success_cat=="Declining")%>%   summarise_at( c("ind_c1","ind_c2","ind_c3","ind_c4","ind_c5","ind_c6","ind_c7"),~mean(., na.rm = TRUE)) %>% transpose()) %>% cbind(Industries)%>%setNames(make.names(names(.), unique = TRUE)) %>% as.tibble() %>%  rename( "Stable"  =1:1, "Rising" =2:2, "Declining" = 3:3) %>% select(4:4, everything()) %>% kable(digits = 2, col.names = c("Industries","% of owners among Stable fam","% of owners among Rising fam","% of owners among Declining fam")) %>% kable_styling(full_width = F)

  

#dyn_ae_ge_fam_uniq %>% select(indus_1, indus_2, indus_3)    


```



```{r}
dyn_ae_ge_fam_uniq <-dyn_ae_ge_fam_uniq %>% mutate(ind_rt = case_when(ind_2 == 0 ~ "0", ind_2 %in% c(1,5)~ "rent-thick",
                                  TRUE~ "non-rent-thick"))

#dyn_ae_ge_fam_uniq$indus_1

dyn_ae_ge_fam_uniq$indus_2 <- replace_na(dyn_ae_ge_fam_uniq$indus_2 ,0)

dyn_ae_ge_fam_uniq<- dyn_ae_ge_fam_uniq  %>% mutate(indus_rt = case_when(ind_2 == 0 ~ "0", ind_2 %in% c(1,3,7,2,4,5)~ "rent-thick",
                                  TRUE~ "non-rent-thick"))





dyn_ae_ge_fam_uniq $dyn_tot_2_text <- ifelse(dyn_ae_ge_fam_uniq $dyn_tot_2==1, "Family", "Non-family")



dyn_ae_ge_fam_uniq %>%  group_by(success_cat) %>% summarise(mean(indus_count)) %>% kable(caption = "Industry ownership", col.names = c("Politician's identity", "Average number of  ownersip"), digits = 2) %>% kable_styling(bootstrap_options = "striped")
```


---

```{r}

library(cowplot)
ggplot(dyn_ae_ge_fam_uniq,aes(indus_count, fill = success_cat))+
  geom_density( adjust =2, alpha = .5)+
  ylim(0,.5)+
  labs(title = "Industry distribution among family catagories", x= "Count")+
  theme_minimal_hgrid()+
  theme(legend.position = "bottom",
        legend.title = element_blank())


```

#### rent

```{r}
dyn_ae_ge_fam_uniq$indus_2 <- replace_na(dyn_ae_ge_fam_uniq$indus_2 ,0)

dyn_ae_ge_fam_uniq<- dyn_ae_ge_fam_uniq %>% mutate(indus_rt = case_when(indus_2 == 0 ~ "0", ind_2 %in% c(1,3,7,2,4,5)~ "rent-thick",
                                  TRUE~ "non-rent-thick"))


dyn_ae_ge_fam_uniq %>% filter(indus_rt != "0") %>% group_by(success_cat, indus_rt) %>% summarise(count = n()) %>% group_by(success_cat) %>% mutate(sum = sum(count), prop = count/sum) %>% select(success_cat, indus_rt, prop) %>% kable(captioni = "industry ownership wrt rent extraction type", col.names = c("Politician's identity","rent-type", "Proportion"), digits = 2) %>% kable_styling(bootstrap_options = "striped")
```

---

```{r}
rt <- dyn_ae_ge_fam_uniq %>% filter(indus_rt != "0") %>% group_by(success_cat, indus_rt) %>% summarise(count = n()) %>% group_by(success_cat) %>% mutate(sum = sum(count), prop = count/sum) %>% select(1:2, 5:5)



ggplot(rt,aes(x = success_cat, y = prop, fill = indus_rt, label = round(prop,2)))+
  geom_bar(position = "stack", stat= "identity")+
      geom_text(size = 2.5, position = position_stack(vjust = 0.5))+
    colorspace::scale_fill_discrete_qualitative(palette= "dark3" )+
  coord_fixed(ratio =4)+
    theme_minimal()+
labs(title = "Industry composition among family Catagoreis ",x = "", y = "Proportion of industry")+
    theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"))+
  theme(plot.background = element_blank(),
        axis.line.x = element_line(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_blank(),
        legend.title= element_blank()
  ) 

```


---


### variable sumamry

```{r}

dyn_ae_ge_fam_uniq$minister_dur <- dyn_ae_ge_fam_uniq$minister_dur %>% replace_na(0)

dyn_ae_ge_fam_uniq$land <- as.numeric(dyn_ae_ge_fam_uniq$land)

dyn_ae_ge_fam_uniq$school <- as.numeric(dyn_ae_ge_fam_uniq$school)%>% replace_na(0)

dyn_ae_ge_fam_uniq$college<- as.numeric(dyn_ae_ge_fam_uniq$college)%>% replace_na(0)

dyn_ae_ge_fam_uniq$n_sc_minster <- dyn_ae_ge_fam_uniq$n_sc_minster%>% replace_na(0)

dyn_ae_ge_fam_uniq %>% group_by(success_cat) %>% summarise(mean(land, na.rm = TRUE),mean(indus_count),mean(n_sc_minster), mean(minister_dur), mean(school), mean(college)) %>% kable(col.names = c("Success","land", "industires", "N_minister", "Minister duration (months)", "school", "college"), digits = 2) %>% kable_styling(bootstrap_options = "striped")

#dyn_ae_ge_fam_uniq %>% filter(success_diff_cat == "Stable") 
```


---



## Life span {.tabset}


### wrt success cats

```{r}
fam_life <-  dyn_ae_ge_fam  %>% 
   group_by(family_id) %>% 
   distinct(year, .keep_all = TRUE) %>%
  select(family_id,election_type, year, position, term_duration) %>%
  arrange(family_id,year) %>%
   mutate(year_diff = year- lag(year, default = 0),
         # year_diff = ifelse(year_diff>lag(term_duration),0,year_diff),
          year_diff_1 = lead(year_diff,default = 0),
         year_diff_1 = ifelse(year_diff_1==0|year_diff_1>5|year_diff_1<0 ,term_duration, year_diff_1)) %>%
   group_by(family_id) %>% 
   summarise(fam_life = sum(year_diff_1))


dyn_ae_ge_fam_uniq <- dyn_ae_ge_fam  %>% group_by(family_id)%>% arrange(election_id)%>% distinct(family_id, .keep_all = TRUE)

 dyn_ae_ge_fam_uniq$edu <- as.numeric(paste( dyn_ae_ge_fam_uniq$school,  dyn_ae_ge_fam_uniq$college, sep = ""))


 dyn_ae_ge_fam_uniq$edu_cat <- ifelse( dyn_ae_ge_fam_uniq$edu ==10,1,ifelse( dyn_ae_ge_fam_uniq$edu ==1,2,ifelse( dyn_ae_ge_fam_uniq ==11,3,0)))
# 
 dyn_ae_ge_fam_uniq$edu_cat <- case_when( dyn_ae_ge_fam_uniq$edu ==10 ~"Only School",
                                         dyn_ae_ge_fam_uniq$edu ==1~"Only College",
                                         dyn_ae_ge_fam_uniq$edu ==11~"Both School & College",
                                        TRUE ~"None"

                                        )

edu <- as.numeric(case_when( dyn_ae_ge_fam_uniq$edu_cat =="Only School" ~"1",
                                         dyn_ae_ge_fam_uniq$edu_cat =="Only College" ~"2",
                                         dyn_ae_ge_fam_uniq$edu_cat =="Both School & College" ~"3",
                                        TRUE ~"0"

                                       ))

                            
                             dyn_ae_ge_fam_uniq <- dyn_ae_ge_fam_uniq %>%  
  mutate(edu_log = ifelse(edu_cat=="None",0,1)) %>%
   rowwise() %>% 
  mutate(ind_all = sum(ind_c1, ind_c2,ind_c3, ind_c4, ind_c5),
         ind_edu = sum(ind_all+edu_log)) %>% ungroup() 
                                  







 
 fam_span2 <- inner_join(dyn_ae_ge_fam_uniq,fam_life , by = "family_id" )
 
```

---

```{r}
fam_span2%>%  group_by(success_cat) %>% summarise(mean(fam_life)) %>% kable(caption = "Average life span", digits = 0, col.names = c("Success", "Life span")) %>% kable_styling(full_width = F)
```



### life span graphs

```{r}
fam_ls_w <- ggplot(fam_span2)+
  geom_density(aes(x=fam_life, y = ..density..),size = 1, color = 'black')+
  geom_vline(aes(xintercept = median(fam_span2$fam_life), color = "median"))+
  geom_vline(aes(xintercept = mean(fam_span2$fam_life), color = "mean",show.legend  =TRUE))+
   scale_color_manual(name = "stats", values = c(median = "red", mean = "blue"))+
 scale_y_continuous(limits = c(0,.07),
  labels = scales::number_format(accuracy = 0.01))+
 theme_bw()+
  
  labs(subtitle = "Life span of families", x= "Years", y = "Density")





## after second mme

fam_life_2 <-  dyn_ae_ge_fam %>%
   group_by(family_id) %>% 
  filter(dyn_cum_2 ==1) %>% 
   distinct(year, .keep_all = TRUE) %>%
  select(family_id,election_type, year, position, term_duration) %>%
  
  arrange(family_id,year) %>%
   mutate(year_diff = year- lag(year, default = 0),
         # year_diff = ifelse(year_diff>lag(term_duration),0,year_diff),
          year_diff_1 = lead(year_diff,default = 0),
         year_diff_1 = ifelse(year_diff_1==0|year_diff_1>5|year_diff_1<0 ,term_duration, year_diff_1)) %>%
   group_by(family_id) %>% 
   summarise(fam_life2 = sum(year_diff_1), min_fam_year= min(year))
##
# fam_span3 <- inner_join(dyn_ae_ge_fam_uniq ,fam_life_2, by = "family_id")
# 
# 
# fam_ls_wo <- ggplot(fam_span3)+
#   geom_density(aes(x=fam_life2, y = ..density..),size = 1, color = 'black')+
#   geom_vline(aes(xintercept = median(fam_span3$fam_life2), color = "median"))+
#   geom_vline(aes(xintercept = mean(fam_span3$fam_life2), color = "mean",show.legend  =TRUE))+
#    scale_color_manual(name = "statistics", values = c(median = "red", mean = "blue"))+
# scale_y_continuous(limits = c(0,.07),
#   labels = scales::number_format(accuracy = 0.01))+
#  theme_bw()+
#   labs(subtitle = "Life span of families  \n after second member entry", y = "", x= "Years")

## non-fam


 dyn_ae_ge$fam_rel_uniq_id <- paste(dyn_ae_ge$family_id, dyn_ae_ge$rel_id_uniq, sep = "")
 
dyn_ae_ge <- dyn_ae_ge %>% group_by(fam_rel_uniq_id) %>% mutate(n_elections_won = n_distinct(election_id[position ==1])) %>% ungroup(fam_rel_uniq_id)

dyn_non_fam_w <- dyn_ae_ge %>% filter(dyn_tot_2==0 &n_elections_won >=1)%>% group_by(family_id) %>% mutate(max_year = max(year), min_year = min(year)) 

non_fam_life <- dyn_non_fam_w %>% 
   group_by(family_id) %>% 
   distinct(year, .keep_all = TRUE) %>%
  select(family_id,election_type, year, position, term_duration) %>%
  arrange(family_id,year) %>%
   mutate(year_diff = year- lag(year, default = 0),
         # year_diff = ifelse(year_diff>lag(term_duration),0,year_diff),
          year_diff_1 = lead(year_diff,default = 0),
         year_diff_1 = ifelse(year_diff_1==0|year_diff_1>5|year_diff_1<0 ,term_duration, year_diff_1)) %>%
   group_by(family_id) %>% 
   summarise(non_fam_life = sum(year_diff_1))
# dyn_ae_ge_fam_uniq <- dyn_ae_ge_fam  %>% group_by(family_id)%>% arrange(election_id)%>% distinct(family_id, .keep_all = TRUE)


non_fam_span <- inner_join(dyn_non_fam_w , non_fam_life, by = "family_id")




# medx <- median(dyn_non_fam_w$life_span)
# meanx <- mean(dyn_non_fam_w$life_span)

# dyn_non_fam_w %>% filter(life_span>42)


ind_ls <-  ggplot(non_fam_span )+
  geom_density(aes(x=non_fam_life, y = ..density..),size = 1, color = 'black')+
   labs(subtitle = "Life span of non-families \n who have atleast one", x= "Years", y = "")+
  xlim(0,50)+
  ylim(.0,.07)+
  geom_vline(aes(xintercept = median(non_fam_span $non_fam_life), color = "median"))+
  geom_vline(aes(xintercept = mean(non_fam_span $non_fam_life), color = "mean",show.legend  =TRUE))+
   scale_color_manual(name = "stats", values = c(median = "red", mean = "blue"))+
  scale_y_continuous(limits = c(0,.07),
  labels = scales::number_format(accuracy = 0.01))+
 theme_bw()

## years to second member entry


fam_life_3 <- inner_join(fam_life, fam_life_2, by = "family_id") %>% mutate(diff = fam_life- fam_life2)



# year_entry <- ggplot(fam_life_3, aes(diff))+
#   geom_density(size = 1, color = 'black')+
#   labs(subtitle = "Years to second member entry", x = "Years",y = "Density")+
#   #xlim(0,45)
#   ylim(.0,.07)+
#   geom_vline(aes(xintercept =  median(fam_life_3$diff), color = "median"))+
#   geom_vline(aes(xintercept =  mean(fam_life_3$diff), color = "mean",show.legend  =TRUE))+
#    scale_color_manual(name = "statistics", values = c(median = "red", mean = "blue"))+
#   scale_y_continuous(limits = c(0,.07),
#   labels = scales::number_format(accuracy = 0.01))+
#  theme_bw()

library(ggpubr)

ggpubr::ggarrange(fam_ls_w, ind_ls, year_entry,fam_ls_wo ,common.legend = TRUE, legend = "bottom", align = "hv")


ggpubr::ggarrange(fam_ls_w, ind_ls ,common.legend = TRUE, legend = "bottom", align = "hv")


# inner_join(dyn_ae_ge, fam_life_3, by = "family_id") %>% write.csv("D:/cpr/UP/up-dynasties/dyn_other_data/fam_life_test.csv")


```


```{r}


first_member <- dyn_ae_ge_fam %>% group_by(family_id) %>% filter(year== min(year)) %>% arrange(family_id, relative_id) %>% distinct(family_id, .keep_all = TRUE) %>% select(family_id, first_member = relative_id) %>% mutate(first_member = ifelse(is.na(first_member),4,first_member))

dyn_entry <- dyn_ae_ge_fam %>% filter(dyn_cum_2 ==1
                         ) %>% group_by(family_id)%>% mutate(dyn_year= min(year))  %>%filter(year==dyn_year) %>% group_by(family_id) %>% mutate(same_entry = ifelse(any(relative_id ==first_member),1,0)) %>%  select(family_id,year, dyn_year, same_entry)%>% 
  distinct(family_id, .keep_all =TRUE) 

ind_exit <- dyn_ae_ge_fam %>% filter(dyn_cum_2 ==0
                         ) %>% group_by(family_id)%>% mutate(ind_year= max(year))  %>%filter(year==ind_year) %>% group_by(family_id) %>% mutate(same_entry = ifelse(any(relative_id ==1),1,0)) %>% 
  distinct(family_id, .keep_all =TRUE) %>% rowwise() %>% mutate(year = year+term_duration)%>%  select(family_id,year)

dyn_entry_exit <- right_join(ind_exit, dyn_entry, by = "family_id") %>% 
 mutate(entry_years = year.y - year.x,
        entry_years = ifelse(is.na(entry_years) |same_entry ==1|entry_years<=0 , 0,entry_years))


 year_entry <- ggplot(dyn_entry_exit, aes(entry_years))+
  geom_density(size = 1, color = 'black')+
  labs(subtitle = "Years to second member entry", x = "Years",y = "Density")+
  #xlim(0,45)
  ylim(.0,.25)+
  geom_vline(aes(xintercept =  median(dyn_entry_exit$entry_years), color = "median"))+
  geom_vline(aes(xintercept =  mean(dyn_entry_exit$entry_years), color = "mean",show.legend  =TRUE))+
   scale_color_manual(name = "stats", values = c(median = "red", mean = "blue"))+
  #scale_y_continuous(limits = c(0,.07),
  #labels = scales::number_format(accuracy = 0.01))+
 theme_bw()
 
 dyn_ae_ge_fam <- inner_join(dyn_ae_ge_fam, first_member, by = "family_id")

# dyn_ae_ge_fam %>% filter(dyn_cum_2 ==1
#                          ) %>% group_by(family_id)%>% mutate(dyn_year= min(year))  %>%filter(year==dyn_year) %>% group_by(family_id) %>% mutate(same_entry = ifelse(any(relative_id ==first_member),1,0)) %>%  select(family_id,year, dyn_year, same_entry) %>% 
#   group_by(family_id) %>% mutate(count = n()) %>% filter(same_entry==1 & count ==1)


fam_life_3g <- inner_join(dyn_entry_exit ,fam_life, by = "family_id") %>% 
  mutate(fam_life_3g = fam_life- entry_years)

median <- median(fam_life_3g$fam_life_3g)

mean <- mean(fam_life_3g$fam_life_3g)

fam_ls_wo <- ggplot(fam_life_3g)+
  geom_density(aes(x=fam_life_3g, y = ..density..),size = 1, color = 'black')+
  geom_vline(aes(xintercept = median, color = "median"))+
  geom_vline(aes(xintercept = mean, color = "mean",show.legend  =TRUE))+
   scale_color_manual(name = "stats", values = c(median = "red", mean = "blue"))+
#scale_y_continuous(limits = c(0,.07),
  #labels = scales::number_format(accuracy = 0.01))+
 theme_bw()+
  labs(subtitle = "Life span of families  exluding years took for the second member entry", y = "", x= "Years")

fam_life_3g %>% filter(fam_life_3g <0)
 
```


## caste  {.tabset}


### caste composition


```{r}
dyn_ae_ge$caste_groups <- factor(dyn_ae_ge$caste_groups, levels = c("Upper Caste","Yadav","Non-Yadav OBC","Dalit" , "Muslim"  ,"Others" ))


dyn_ae_ge %>% filter(dyn_cum_2 ==1) %>% distinct(family_id, .keep_all = TRUE)%>% group_by(caste_groups) %>% summarise(count = n(), prop = count/322 *100)%>% mutate(caste = "caste") %>% 
  ggplot(aes(caste, prop, fill = caste_groups, label = round(prop,0)))+
    geom_col()+
      geom_text(size = 2.5, position = position_stack(vjust = 0.5))+

    colorspace::scale_fill_discrete_qualitative(palette= "dark3" )+

    theme_minimal()+
  theme(aspect.ratio=4/2)+
labs(title = "Caste composition of families ",x = "", y = "", fill = "Caste Groups")+
    theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"))+
  theme(plot.background = element_blank(),
        axis.line.x = element_line(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_blank()
  ) 



  
```




###  elite categories

```{r}
# dyn_lb  <- dyn_lb %>% mutate(level_log = ifelse(level == "LB",FALSE,TRUE))
# 
# dyn_lb_uniq <- dyn_lb %>% arrange (-year) %>%  distinct(family_id, .keep_all = TRUE)
# 
# count_tot  <-  dim(dyn_lb_uniq %>% filter(dyn_tot ==1))[1]
# dyn_lb_uniq %>% filter(dyn_tot ==1) %>% group_by(level_log) %>% summarise(prop = n()/count_tot) %>% kable(caption = "Family linkages", col.names = c("Connection", "Proportion"), digits = 2) %>% kable_styling(bootstrap_options = "striped")


dyn_ae_ge_fam_uniq$caste_groups <- factor(dyn_ae_ge_fam_uniq$caste_groups, levels = c("Upper Caste","Yadav","Non-Yadav OBC","Dalit" , "Muslim"  ,"Others" ))



dyn_ae_ge_fam_uniq %>% filter(caste_groups!= "NA") %>% group_by(success_cat, caste_groups) %>% summarise( count = n()) %>% group_by(success_cat) %>% mutate(sum = sum(count), prop = count/sum) %>% select(success_cat, caste_groups, prop) %>% 
  ggplot(aes(factor(success_cat), prop, fill = caste_groups,label = round(prop,2)))+
   geom_bar(stat="identity", position = "stack")+
    geom_text(size = 2.5, position = position_stack(vjust = 0.5))+ 
  colorspace::scale_fill_discrete_qualitative(palette= "dark3" )+

  coord_fixed(ratio =5)+
    theme_minimal()+
      
    labs(title = "Caste composition among families wrt success  ",x = "", y = "Proportion", fill = "") +
    theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"))+
  theme(plot.background = element_blank(),
        axis.line.x = element_line(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_blank()
  ) 



```


### economic diversification

```{r}

dyn_ae_ge_fam_uniq$caste_groups <- factor(dyn_ae_ge_fam_uniq$caste_groups, levels = c("Upper Caste","Yadav","Non-Yadav OBC","Dalit" , "Muslim"  ,"Others" ))


dyn_ae_ge_fam_uniq %>% filter(caste_groups!= "NA" & caste_groups!= "Others") %>% group_by( caste_groups,ind_edu) %>% summarise( count = n()) %>% group_by(caste_groups) %>% mutate(sum = sum(count), prop = count/sum) %>% select(ind_edu, caste_groups, prop) %>% 
  ggplot(aes(factor(caste_groups), prop, fill = factor(ind_edu),label = round(prop,2)))+
   geom_bar(stat="identity", position = "stack")+
    geom_text(size = 2.5, position = position_stack(vjust = 0.5))+ 
  colorspace::scale_fill_discrete_qualitative(palette= "dark3" )+
  coord_fixed(ratio =5)+
    theme_minimal()+
    #scale_x_discrete(labels =(c ("Dalit","Muslim", "Non-Yadav \n OBC","Upper \n Caste","Yadav"    )))+
      
    labs(title = "Economic diversification wrt caste groups  ",x = "", y = "Proportion", fill = "") +
    theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"))+
  theme(plot.background = element_blank(),
        axis.line.x = element_line(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_blank()
       )


```

### Land

```{r}

dyn_ae_ge_fam_uniq$caste_groups <- factor(dyn_ae_ge_fam_uniq$caste_groups, levels = c("Upper Caste","Yadav","Non-Yadav OBC","Dalit" , "Muslim"  ,"Others" ))

dyn_ae_ge_fam_uniq %>% filter(caste_groups!= "Others")%>% group_by(caste_groups, land_cat) %>% summarise(count = n()) %>%
    group_by(caste_groups) %>% mutate(sum = sum(count), pc = count/sum) %>%
    ggplot(aes(caste_groups,pc, fill = land_cat, label = round(pc,2)))+

    geom_bar(position = "stack", stat = "identity")+
     geom_text(size = 2.5, position = position_stack(vjust = 0.5))+
      theme_minimal()+
  #theme(aspect.ratio=2)+
  scale_fill_discrete(labels = c( "very small", "small", "medium", "large", "very large"))+
    #scale_x_discrete(labels =(c ("Dalit","Muslim", "Non-Yadav \n OBC","Upper \n Caste","Yadav"    )))+
      
    labs(title = "land holdings wrt caste groups  ",x = "", y = "Proportion", fill = "") +
    theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"))+
  theme(plot.background = element_blank(),
        axis.line.x = element_line(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_blank()
       )
```


### Life span wrt caste




---

```{r}

 
fam_span2%>% group_by(caste_groups) %>% 
  summarise(mean = mean(fam_life),
            median =median(fam_life)) %>% kable(digits = 0) %>% 
  kable_styling(full_width = F)


```


---

```{r}
ggplot(fam_span2 %>% filter(caste_groups!= "Others"),aes(x = reorder(as.factor(caste_groups),-fam_life, median), fam_life)) +
  geom_boxplot(outlier.shape = NA)+
 # scale_x_discrete(labels=(c("Non - Family", "Family")))+
  #coord_cartesian(ylim = ylim1*1.05)+
  theme_minimal()+
  labs(title = "Family life span wrt caste groups ",x = "", y = "Life span \n (in years)") +

  theme(plot.margin = unit(c(.5,.5,.5,.5), "cm"),
        plot.background = element_blank(),
        plot.title = element_text(family = "serif",hjust = 0.5, size = 20,
                                  margin= margin(0,0,20,0)),
        text = element_text(color = "gray20", family = "serif"),
        legend.title = element_blank(),
        legend.text = element_text(size = 15),
        axis.text = element_text(face = "italic", size = 13),
        axis.title = element_text(vjust = -1, size = 16),
        axis.ticks = element_blank()
  )



```

---

```{r}
ggplot(dyn_ae_ge_fam_uniq %>% filter(caste_groups!= "Others"),aes(life_span, fill = factor(caste_groups)))+
  geom_density(alpha =.5 )+
  theme(legend.position = "bottom")


```



---



<!-- # Family new analyses -->

<!-- ## Stats {.tabset} -->


<!-- ```{r} -->

<!-- dyn_ae_ge %>%group_by(family_id) %>% filter(dyn_cum_2==1) %>% arrange(year) %>% filter(year == min(year)) %>% distinct(family_id, .keep_all = TRUE) %>% select(family_id, year) %>% group_by(year) %>% summarise(count = n()) %>% mutate(cumsum= cumsum(count), pc = cumsum/322*100) %>%  -->
<!--   ggplot(aes(year, pc))+ -->
<!--   geom_area(fill = "steelblue")+ -->
<!--   theme_bw()+ -->
<!--   #scale_y_continuous(labels = percent, limits = c(0,1)) -->
<!--   labs(title = "Cumulative formation of families ",x = "Year", y = "Families (%)") -->

<!-- ``` -->


<!-- ### contested and won -->


<!-- ```{r} -->
<!-- dyn_ae_ge_fam <- dyn_ae_ge_fam %>% mutate(year_cat =case_when(year>= 1970 & year<= 1988 ~"74-88", -->
<!--                         year>=1989& year<= 1999 ~"89-99", -->
<!--                         year>= 2000 & year<= 2008 ~"00-08", -->
<!--                         year>= 2009 & year<= 2019 ~"09-19", -->
<!--                         TRUE~ "?")) -->


<!-- dyn_ae_ge_fam$year_cat <- factor(dyn_ae_ge_fam$year_cat , levels = c("74-88", "89-99", "00-08", "09-19")) -->

<!-- dyn_ae_ge_fam %>%group_by(family_id) %>% filter(dyn_cum_2==1) %>% arrange(year) %>% filter(year == min(year)) %>% distinct(family_id, .keep_all = TRUE) %>% select(family_id, year_cat) %>%  group_by(year_cat)%>% summarise(count = n()) %>% mutate(cum_sum = cumsum(count)) -->

<!-- dyn_ae_ge_fam  <- dyn_ae_ge_fam  %>% group_by(family_id)%>% mutate(n_el_w = sum(ifelse(position==1,1,0)), n_el_c = n() ) -->

<!-- # elections contested -->

<!-- dyn_ae_ge_fam %>% filter(dyn_cum_2==1 ) %>% arrange(year) %>% filter(year == max(year)) %>% distinct(family_id, .keep_all = TRUE) %>%group_by(n_el_c) %>% tally() -->


<!-- # elections won -->

<!-- dyn_ae_ge_fam %>% filter(dyn_cum_2==1 ) %>% arrange(year) %>% filter(year == max(year)) %>% distinct(family_id, .keep_all = TRUE) %>%group_by(n_el_w) %>% tally() -->

<!-- ## elections won ae-ge -->

<!-- dyn_ae_ge_fam  <- dyn_ae_ge_fam  %>% group_by(family_id, election_type)%>% mutate(n_el_w_ge = sum(ifelse(position==1& election_type =="GE",1,0)),n_el_w_ae = sum(ifelse(position==1& election_type =="AE",1,0)) ) -->

<!-- dyn_ae_ge_fam %>%group_by(family_id) %>% filter(dyn_cum_2==1) %>% arrange(year) %>% filter(year == max(year) ) %>% distinct(family_id, .keep_all = TRUE) %>% select(family_id, year_cat) %>%  group_by(year_cat)%>% summarise(count = n()) %>% mutate(cum_sum = cumsum(count)) -->


<!-- dyn_ae_ge_fam %>% filter(dyn_cum_2==1 ) %>% arrange(year) %>% filter(year == max(year)) %>% distinct(family_id, .keep_all = TRUE) %>%group_by(n_el_w_ge) %>% tally() -->



<!-- ``` -->

<!-- ### orgs -->


```{r}
# inv <- read.csv("D:/cpr/UP/up-dynasties/dyn_other_data/upwhoiswho.csv")
# 
# inv$position <- as.numeric(inv$position)
# 
# inv <- inv %>% select(election_type, year,constituency_no, position, org_inv, association_inv,poitical_inv )
# 
# 
# # 
# # inv <- inv  %>% dplyr::select(family_id,association_inv,org_inv, poitical_inv )
# # 
# # dyn_ae_ge <- merge(dyn_ae_ge,inv, by ="family_id", allow.cartesian = TRUE, all.x =TRUE )
# 
# 
# 
# 
# 
# dyn_ae_ge_fam <- left_join(dyn_ae_ge_fam, inv, by = c("election_type","year","constituency_no","position"))
# 
# inv_df <- dyn_ae_ge_fam %>% group_by(family_id) %>% summarise(org_inv_n = sum(!is.na (org_inv) ),
#                                           asoc_inv_n =  sum(!is.na (association_inv)),
#                                           pol_inv_n =  sum(!is.na (poitical_inv)))


```



# Regressions {.tabset}

## All famileis


This is a multinomial logit model that regresses three success categories. Rising families are the refrence ones. Results do not have any constituency variable here since this is regressed at family level.




```{r}

library(lfe)
library(nnet)

df <- dyn_ae_ge_fam_uniq

#dyn_ae_ge_fam_uniq <- dyn_ae_ge_fam_uniq %>% filter(n_el_w>=1)
#success <- dyn_ae_ge_fam_uniq$success_diff_cat

# fam_tab <- fam_tab %>% mutate(`0` = ifelse(is.na(`0`), `1`,`0`), diff = `1`-`0`)
#
# dyn_ae_ge_fam_uniq <- inner_join(fam_tab,dyn_ae_ge_fam_uniq, by = "family_id")


second_mem_dur <- dyn_ae_ge_fam_uniq$diff



industry <- dyn_ae_ge_fam_uniq$indus_count %>% replace_na(0)

# industry_rent_thick <- dyn_ae_ge_fam_uniq$indus_rt %>% replace_na(0)
#
# industry_non_rent_thick <- dyn_ae_ge_fam_uniq$indus_nrt %>% replace_na(0)

caste_uc <- ifelse(dyn_ae_ge_fam_uniq$caste_groups == "Upper Caste", 1,0)


caste_yadav <- ifelse(dyn_ae_ge_fam_uniq$caste_groups == "Yadav", 1,0)

caste_muslim <- ifelse(dyn_ae_ge_fam_uniq$caste_groups == "Muslim", 1,0)

caste_dalit <- ifelse(dyn_ae_ge_fam_uniq$caste_groups == "Dalit", 1,0)

caste_non_yadav_obc <- ifelse(dyn_ae_ge_fam_uniq$caste_groups == "Non-Yadav OBC", 1,0)


turncoat <- dyn_ae_ge_fam_uniq$turncoat


N_minister <- dyn_ae_ge_fam_uniq$n_sc_minster%>% replace_na(0)

minister_duration <- dyn_ae_ge_fam_uniq$minister_dur %>% replace_na(0)

n_mem <- dyn_ae_ge_fam_uniq$n_mem


minister_duration <- minister_duration/n_mem

mem1_female <-  if_else(dyn_ae_ge_fam_uniq$mem1_gender=="F",1,0,missing = 0)


n_elections_w <-  dyn_ae_ge_fam_uniq$n_el_w_pat_ae_ge



minister <-ifelse(dyn_ae_ge_fam_uniq$min_dur_yr>0,1,0)%>% replace_na(0)


post_2002 <- ifelse(dyn_ae_ge_fam_uniq$year >=2002,1,0)



#n_elections_w<- as.numeric(dyn_ae_ge_fam_uniq$n_el_w)


 dyn_ae_ge_fam_uniq$edu <- as.numeric(paste( dyn_ae_ge_fam_uniq$school,  dyn_ae_ge_fam_uniq$college, sep = ""))


 dyn_ae_ge_fam_uniq$edu_cat <- ifelse( dyn_ae_ge_fam_uniq$edu ==10,1,ifelse( dyn_ae_ge_fam_uniq$edu ==1,2,ifelse( dyn_ae_ge_fam_uniq ==11,3,0)))
# 
 dyn_ae_ge_fam_uniq$edu_cat <- case_when( dyn_ae_ge_fam_uniq$edu ==10 ~"Only School",
                                         dyn_ae_ge_fam_uniq$edu ==1~"Only College",
                                         dyn_ae_ge_fam_uniq$edu ==11~"Both School & College",
                                        TRUE ~"None"

                                        )

edu <- as.numeric(case_when( dyn_ae_ge_fam_uniq$edu_cat =="Only School" ~"1",
                                         dyn_ae_ge_fam_uniq$edu_cat =="Only College" ~"2",
                                         dyn_ae_ge_fam_uniq$edu_cat =="Both School & College" ~"3",
                                        TRUE ~"0"

                                       ))

                            
                             dyn_ae_ge_fam_uniq <- dyn_ae_ge_fam_uniq %>%  
  mutate(edu_log = ifelse(edu_cat=="None",0,1)) %>%
   rowwise() %>% 
  mutate(ind_all = sum(ind_c1, ind_c2,ind_c3, ind_c4, ind_c5),
         ind_edu = sum(ind_all+edu_log)) %>% ungroup() 
                                  





ind_edu <- dyn_ae_ge_fam_uniq$ind_edu




dyn_ae_ge_fam_uniq<- dyn_ae_ge_fam_uniq %>% mutate(land = as.numeric(land)
                                            )


 land <- as.numeric(dyn_ae_ge_fam_uniq$land) %>% replace_na(0)





land <- as.numeric(cut(land, breaks = c(0,1,100,250,500,Inf), include.lowest =TRUE, labels = c("0","1","2","3","4")))

  

linkage <- ifelse(dyn_ae_ge_fam_uniq$level %in% c("AE", "GE"),0,1)

linkage_up <- ifelse(dyn_ae_ge_fam_uniq$level%in% c("GE-AE", "GE-AE-LB"),1,0)

linkage_down <- ifelse(dyn_ae_ge_fam_uniq$level %in% c("AE-LB", "GE-AE-LB", "GE-LB"),1,0)

#ml$prog2 <- relevel(ml$prog, ref = "academic")

# dyn_ae_ge_fam_uniq$success_cat <- as.factor(dyn_ae_ge_fam_uniq$success__cat)

Rising <- ifelse(dyn_ae_ge_fam_uniq$success_cat=="Rising",1,0)

Declining <- ifelse(dyn_ae_ge_fam_uniq$success_cat=="Declining",1,0)

Stable<- ifelse(dyn_ae_ge_fam_uniq$success_cat=="Stable",1,0)

success_cat <- dyn_ae_ge_fam_uniq$success_cat

delim_change <- dyn_ae_ge_fam_uniq$delim_change

family_id <- dyn_ae_ge_fam_uniq$family_id


constituency <- dyn_ae_ge_fam_uniq$constituency_name


election_type <-  dyn_ae_ge_fam_uniq$election_type


caste_groups <- dyn_ae_ge_fam_uniq$caste_groups


#success_rate <- dyn_ae_ge_fam_uniq$success_diff
```




### Multinom. ref. - Stable {.tabset}


```{r}




df <- tibble(family_id,constituency,success_cat, caste_uc, caste_yadav,caste_non_yadav_obc , caste_dalit , caste_muslim ,minister_duration ,industry , land , linkage,linkage_down, minister, edu, second_mem_dur, delim_change, election_type, caste_groups, ind_edu, mem1_female, n_elections_w)


fam_df <- df



mean <- df %>% group_by(success_cat)%>% summarise_at( c("linkage_down" , "minister_duration","industry" , "land" , "second_mem_dur"),~mean(., na.rm = TRUE))

min <- df %>%  group_by(success_cat)%>% summarise_at(  c("linkage_down" , "minister_duration","industry" , "land" , "second_mem_dur"),~min(., na.rm = TRUE))

max <- df %>% group_by(success_cat)%>% summarise_at(  c("linkage_down" , "minister_duration","industry" , "land" , "second_mem_dur"),~max(., na.rm = TRUE))

unique_n<- df %>%  group_by(success_cat)%>% summarise_at(  c("linkage_down" , "minister_duration","industry" , "land" , "second_mem_dur"),list(n = "n_distinct"))

n<- df %>%  group_by(success_cat)%>% summarise_at(  c("linkage_down" , "minister_duration","industry" , "land" , "second_mem_dur"),list(n = "length"))


sd<- df %>% group_by(success_cat)%>%  summarise_at(  c("linkage_down" , "minister_duration","industry" , "land" , "second_mem_dur"),list(sd= "sd"), na.rm = TRUE)

stat <-as.data.frame(c("Length","Length","Length", "Unique-N","Unique-N","Unique-N","Mean","Mean","Mean", "SD","SD","SD","Min","Min","Min", "Max", "Max", "Max")) %>% rename("stat"=1:1)




vals <- data.table::rbindlist(list(n,unique_n,mean, sd,min, max), use.names = FALSE)


# cbind(stat, vals) %>% kable(digits = 2, col.names = c("Measure", "Elite catagory", "Political diversification","Minister duration(Months)","Economic diversification","Land ownership(Deciles)", "Years for second member"), caption = "Summary of family data") %>% kable_styling(full_width = F)


```



<!-- #### With second mem. -->






<!-- ```{r message = FALSE, warning = FALSE, echo = FALSE} -->


<!-- success_cat<-factor( success_cat,levels = c( "Stable","Rising","Declining")) -->

<!-- library("nnet") -->



<!-- fit.multinom <- multinom(success_cat~  caste_uc+ caste_yadav+caste_non_yadav_obc + caste_dalit + caste_muslim +minister_duration +industry  + land + linkage_down+ second_mem_dur) -->
<!-- #  -->
<!-- # stargazer(fit.multinom, type = "text") -->
<!-- ``` -->

<!-- ```{r, results= "asis"} -->
<!-- stargazer(fit.multinom, type="html", keep = c("linkage_down","minister_duration","industry",  "land", "second_mem_dur"), order = c("linkage_down","minister_duration","industry",  "land", "second_mem_dur"),add.lines = list (c("Caste control", "Yes","Yes","Yes")),covariate.labels = c( "Political diversification","Minister duration", "Economic diversification", "Land ownership", "Years took for the second member entry")) -->

<!-- ``` -->


#### Without second mem. {.tabset}


##### Declining ref.


```{r message = FALSE, warning = FALSE, echo = FALSE}


success_cat<-factor( success_cat,levels = c( "Declining","Stable","Rising"))



fit.multinom <- multinom(success_cat~  caste_uc+ caste_yadav+caste_non_yadav_obc + caste_dalit + caste_muslim +minister_duration +ind_edu +  land + linkage + n_elections_w + mem1_female)
```

```{r, results= "asis"}


stargazer(fit.multinom, type="html", keep = c("linkage","success_cat","minister","ind_edu", "land","n_elections_w","mem1_female"),order = c("linkage","success_cat","minister","ind_edu",  "land", "n_elections_w","mem1_female"),add.lines = list (c("Caste control", "Yes","Yes","Yes")),covariate.labels = c( "Political diversification","Minister", "Economic diversification", "Land ownership", "Elections won by founder","Female founder"))
```


##### Stable ref.


```{r message = FALSE, warning = FALSE, echo = FALSE}


success_cat<-factor( success_cat,levels = c( "Stable","Rising","Declining"))



fit.multinom <- multinom(success_cat~  caste_uc+ caste_yadav+caste_non_yadav_obc + caste_dalit + caste_muslim +minister_duration +ind_edu +  land + linkage)
```

```{r, results= "asis"}


stargazer(fit.multinom, type="html", keep = c("linkage","success_cat","minister","ind_edu", "land", "edu"),order = c("linkage","success_cat","minister","ind_edu",  "land"),add.lines = list (c("Caste control", "Yes","Yes","Yes")),covariate.labels = c( "Political diversification","Minister", "Economic diversification", "Land ownership"))
```




##### Rising ref.


```{r message = FALSE, warning = FALSE, echo = FALSE}


success_cat<-factor( success_cat,levels = c( "Rising","Declining","Stable"))



fit.multinom <- multinom(success_cat~  caste_uc+ caste_yadav+caste_non_yadav_obc + caste_dalit + caste_muslim +minister_duration +ind_edu +  land + linkage)
```

```{r, results= "asis"}


stargazer(fit.multinom, type="html", keep = c("linkage","success_cat","minister","indu_edu", "land"),order = c("linkage","success_cat","minister","ind_edu",  "land"),add.lines = list (c("Caste control", "Yes","Yes","Yes")),covariate.labels = c( "Political diversification","Minister", "Economic diversification", "Land ownership"))
```


---



#### Stable v/s rising - post 09


```{r}


adr <- read.csv("D:/cpr/UP/up-dynasties/dyn_other_data/adr_candidatelevel.csv", stringsAsFactors = FALSE)

names(adr)[1] <- "position"

names(adr) <- tolower(names(adr))

adr <- adr %>% dplyr::select( -c(constituency_id,state,         assembly_no,              
  month,              poll_no,           
  delimid,            position,          
  candidate,          sex,               
  party,              votes,             
  candidate_type,     valid_votes,       
  electors,           constituency_name, 
  constituency_type,  sub_region,  pid,      
  n_cand,             turnout_percentage,
  vote_share_percentage,     deposit_lost,      
  margin,             margin_percentage, 
  
  enop,              
                  max_poll_no,       
  last_poll,          contested,         
  last_party,         last_constituency_name,                     
  same_constituency,  same_party,        
  no_terms,           turncoat,          
  incumbent,          recontest )  )


adr <- adr %>% filter(position_tcpd %in% c(1,2))

adr <- adr %>% rename( position = position_tcpd)


dyn_ae_ge <- merge(adr,dyn_ae_ge, by = c("year", "constituency_no", "position"),all.y = TRUE)
 

 
dyn_ae_ge <- dyn_ae_ge %>% distinct(election_type, year, constituency_no, position, .keep_all =TRUE)



dyn_ae_ge $total_assets <- as.numeric(dyn_ae_ge$total_assets)



### GE 2009:19



dyn_ae_ge  <- dyn_ae_ge  %>% group_by(family_id) %>% mutate(n_el_w_pat_ge_09_19 = length(year[relative_id==1 & position ==1 &  dyn_cum_2 ==0 & year <2009 & election_type == "GE"]))

dyn_ae_ge_09_19  <- dyn_ae_ge %>% filter(year >2008) 




fam_st_rs <- dyn_ae_ge_fam_uniq %>% filter(success_cat!= "Declining")


dyn_ae_ge_09_19 <- dyn_ae_ge_09_19 %>% group_by(family_id) %>% mutate(asset_avg = mean(total_assets,na.rm = TRUE), serious_crime_avg =mean(serious_crime,na.rm = TRUE))


st_rs_adr <-  dyn_ae_ge_09_19 %>% distinct(family_id, .keep_all = TRUE) %>% select(family_id, asset_avg, serious_crime_avg)


fam_st_rs_adr <- inner_join(fam_st_rs, st_rs_adr, by = "family_id")

```



```{r}


#dyn_ae_ge_fam_uniq <-fam_st_rs_adr %>% filter(n_el_w>=1)
#success <-fam_st_rs_adr$success_diff_cat

# fam_tab <- fam_tab %>% mutate(`0` = ifelse(is.na(`0`), `1`,`0`), diff = `1`-`0`)
#
#fam_st_rs_adr <- inner_join(fam_tab,dyn_ae_ge_fam_uniq, by = "family_id")


second_mem_dur <-fam_st_rs_adr$diff



industry <-fam_st_rs_adr$indus_count %>% replace_na(0)

# industry_rent_thick <-fam_st_rs_adr$indus_rt %>% replace_na(0)
#
# industry_non_rent_thick <-fam_st_rs_adr$indus_nrt %>% replace_na(0)

caste_uc <- ifelse(fam_st_rs_adr$caste_groups == "Upper Caste", 1,0)


caste_yadav <- ifelse(fam_st_rs_adr$caste_groups == "Yadav", 1,0)

caste_muslim <- ifelse(fam_st_rs_adr$caste_groups == "Muslim", 1,0)

caste_dalit <- ifelse(fam_st_rs_adr$caste_groups == "Dalit", 1,0)

caste_non_yadav_obc <- ifelse(fam_st_rs_adr$caste_groups == "Non-Yadav OBC", 1,0)


turncoat <-fam_st_rs_adr$turncoat


N_minister <-fam_st_rs_adr$n_sc_minster%>% replace_na(0)

minister_duration <-fam_st_rs_adr$minister_dur %>% replace_na(0)

n_mem <-fam_st_rs_adr$n_mem


minister_duration <- minister_duration/n_mem



minister <-ifelse(fam_st_rs_adr$min_dur_yr>0,1,0)%>% replace_na(0)


post_2002 <- ifelse(fam_st_rs_adr$year >=2002,1,0)



#n_elections_w<- as.numeric(fam_st_rs_adr$n_el_w)
fam_st_rs_adr$edu <- as.numeric(paste(fam_st_rs_adr$school, fam_st_rs_adr$college, sep = ""))


fam_st_rs_adr$edu_cat <- ifelse(fam_st_rs_adr$edu ==10,1,ifelse(fam_st_rs_adr$edu ==1,2,ifelse(fam_st_rs_adr ==11,3,0)))
# 
fam_st_rs_adr$edu_cat <- case_when(fam_st_rs_adr$edu ==10 ~"Only School",
                                        fam_st_rs_adr$edu ==1~"Only College",
                                        fam_st_rs_adr$edu ==11~"Both School & College",
                                        TRUE ~"None"

                                        )

edu <- as.numeric(case_when(fam_st_rs_adr$edu_cat =="Only School" ~"1",
                                        fam_st_rs_adr$edu_cat =="Only College" ~"2",
                                        fam_st_rs_adr$edu_cat =="Both School & College" ~"3",
                                        TRUE ~"0"

                                       ))


                             fam_st_rs_adr <- fam_st_rs_adr %>%  
  mutate(edu_log = ifelse(edu_cat=="None",0,1)) %>%
   rowwise() %>% 
  mutate(ind_all = sum(ind_c1, ind_c2,ind_c3, ind_c4, ind_c5),
         ind_edu = sum(ind_all+edu_log)) %>% ungroup() 
                                  


industry <-fam_st_rs_adr$indus_count %>% replace_na(0) 

#industry <- industry+school_college

ind_edu <- fam_st_rs_adr$ind_edu




fam_st_rs_adr<-fam_st_rs_adr %>% mutate(land = as.numeric(land)
                                            )


 land <- as.numeric(fam_st_rs_adr$land) %>% replace_na(0)





land <- as.numeric(cut(land, breaks = c(0,1,100,250,500,Inf), include.lowest =TRUE, labels = c("0","1","2","3","4")))

  

linkage <- ifelse(fam_st_rs_adr$level %in% c("AE", "GE"),0,1)

linkage_up <- ifelse(fam_st_rs_adr$level%in% c("GE-AE", "GE-AE-LB"),1,0)

linkage_down <- ifelse(fam_st_rs_adr$level %in% c("AE-LB", "GE-AE-LB", "GE-LB"),1,0)

#ml$prog2 <- relevel(ml$prog, ref = "academic")

#fam_st_rs_adr$success_cat <- as.factor(fam_st_rs_adr$success__cat)

Rising <- ifelse(fam_st_rs_adr$success_cat=="Rising",1,0)

Declining <- ifelse(fam_st_rs_adr$success_cat=="Declining",1,0)

Stable<- ifelse(fam_st_rs_adr$success_cat=="Stable",1,0)

success_cat <-fam_st_rs_adr$success_cat

delim_change <-fam_st_rs_adr$delim_change


asset_avg <- fam_st_rs_adr$asset_avg

serious_crime_avg <- fam_st_rs_adr$serious_crime_avg

stable <- ifelse(fam_st_rs_adr$success_cat=="Stable",1,0)

rising <- ifelse(fam_st_rs_adr$success_cat=="Rising",1,0)

```



```{r}
df <- tibble( caste_uc, caste_yadav,caste_non_yadav_obc , caste_dalit , caste_muslim ,minister_duration ,industry , land , linkage,linkage_down, minister, edu, second_mem_dur, delim_change, serious_crime_avg, asset_avg, rising, stable, ind_edu)

df_cor <- tibble(asset_avg  , serious_crime_avg,  land, industry, edu, linkage)
# 
# 
# 
# corr <- cor(df_cor, use = "complete.obs")
# # 
# corrplot::corrplot(corr, method = "circle")
```



```{r message = FALSE, warning = FALSE, echo = FALSE}



fit.ols<- felm(rising~  caste_uc+ caste_yadav+caste_non_yadav_obc + caste_dalit + caste_muslim +minister_duration +ind_edu +  land + linkage+serious_crime_avg +log(asset_avg) , data = df)

fit.ols1<- felm(stable~  caste_uc+ caste_yadav+caste_non_yadav_obc + caste_dalit + caste_muslim +minister_duration +ind_edu +  land + linkage+serious_crime_avg +log(asset_avg) , data = df)
```

```{r, results= "asis"}


stargazer(fit.ols,fit.ols1, type="html", keep = c("linkage","success_cat","minister","ind_edu", "land", "serious_crime_avg","asset_avg"),order = c("linkage","success_cat","minister","ind_edu",  "land", "serious_crime_avg","asset_avg"),add.lines = list (c("Caste control", "Yes","Yes")),covariate.labels = c( "Political diversification","Minister", "Economic diversification", "Land ownership", "Asset","Crime"))


```

---

#### summary

```{r}
cbind(stat, vals) %>% kable(digits = 2, col.names = c("Measure", "Elite catagory", "Political diversification","Minister duration(Months)","Economic diversification","Land ownership(Deciles)", "Years for second member"), caption = "Summary of family data") %>% kable_styling(full_width = F)

```

---



## Won elections




```{r}

library(lfe)
library(nnet)

df <- dyn_ae_ge_fam_uniq

dyn_ae_ge_fam_uniq <- dyn_ae_ge_fam_uniq %>% filter(n_el_w>=1)
#success <- dyn_ae_ge_fam_uniq$success_diff_cat
# fam_tab <- fam_tab %>% mutate(`0` = ifelse(is.na(`0`), `1`,`0`), diff = `1`-`0`)
#
# dyn_ae_ge_fam_uniq <- inner_join(fam_tab,dyn_ae_ge_fam_uniq, by = "family_id")


second_mem_dur <- dyn_ae_ge_fam_uniq$diff



industry <- dyn_ae_ge_fam_uniq$indus_count %>% replace_na(0)

# industry_rent_thick <- dyn_ae_ge_fam_uniq$indus_rt %>% replace_na(0)
#
# industry_non_rent_thick <- dyn_ae_ge_fam_uniq$indus_nrt %>% replace_na(0)

caste_uc <- ifelse(dyn_ae_ge_fam_uniq$caste_groups == "Upper Caste", 1,0)


caste_yadav <- ifelse(dyn_ae_ge_fam_uniq$caste_groups == "Yadav", 1,0)

caste_muslim <- ifelse(dyn_ae_ge_fam_uniq$caste_groups == "Muslim", 1,0)

caste_dalit <- ifelse(dyn_ae_ge_fam_uniq$caste_groups == "Dalit", 1,0)

caste_non_yadav_obc <- ifelse(dyn_ae_ge_fam_uniq$caste_groups == "Non-Yadav OBC", 1,0)


turncoat <- dyn_ae_ge_fam_uniq$turncoat


N_minister <- dyn_ae_ge_fam_uniq$n_sc_minster%>% replace_na(0)

minister_duration <- dyn_ae_ge_fam_uniq$minister_dur %>% replace_na(0)

n_mem <- dyn_ae_ge_fam_uniq$n_mem


minister_duration <- minister_duration/n_mem



minister <-ifelse(dyn_ae_ge_fam_uniq$min_dur_yr>0,1,0)%>% replace_na(0)


post_2002 <- ifelse(dyn_ae_ge_fam_uniq$year >=2002,1,0)



#n_elections_w<- as.numeric(dyn_ae_ge_fam_uniq$n_el_w)
 dyn_ae_ge_fam_uniq$edu <- as.numeric(paste( dyn_ae_ge_fam_uniq$school,  dyn_ae_ge_fam_uniq$college, sep = ""))


 dyn_ae_ge_fam_uniq$edu_cat <- ifelse( dyn_ae_ge_fam_uniq$edu ==10,1,ifelse( dyn_ae_ge_fam_uniq$edu ==1,2,ifelse( dyn_ae_ge_fam_uniq ==11,3,0)))
# 
 dyn_ae_ge_fam_uniq$edu_cat <- case_when( dyn_ae_ge_fam_uniq$edu ==10 ~"Only School",
                                         dyn_ae_ge_fam_uniq$edu ==1~"Only College",
                                         dyn_ae_ge_fam_uniq$edu ==11~"Both School & College",
                                        TRUE ~"None"

                                        )

edu <- as.numeric(case_when( dyn_ae_ge_fam_uniq$edu_cat =="Only School" ~"1",
                                         dyn_ae_ge_fam_uniq$edu_cat =="Only College" ~"2",
                                         dyn_ae_ge_fam_uniq$edu_cat =="Both School & College" ~"3",
                                        TRUE ~"0"

                                       ))
                            
                             dyn_ae_ge_fam_uniq <- dyn_ae_ge_fam_uniq %>%  
  mutate(edu_log = ifelse(edu_cat=="None",0,1)) %>%
   rowwise() %>% 
  mutate(ind_all = sum(ind_c1, ind_c2,ind_c3, ind_c4, ind_c5),
         ind_edu = sum(ind_all+edu_log)) %>% ungroup() 
                                  


industry <- dyn_ae_ge_fam_uniq$indus_count %>% replace_na(0)

ind_edu <- dyn_ae_ge_fam_uniq$ind_edu



industry <- dyn_ae_ge_fam_uniq$indus_count %>% replace_na(0) 

#industry <- industry+school_college




dyn_ae_ge_fam_uniq<- dyn_ae_ge_fam_uniq %>% mutate(land = as.numeric(land)
                                            )


 land <- as.numeric(dyn_ae_ge_fam_uniq$land) %>% replace_na(0)





land <- as.numeric(cut(land, breaks = c(0,1,100,250,500,Inf), include.lowest =TRUE, labels = c("0","1","2","3","4")))

  

linkage <- ifelse(dyn_ae_ge_fam_uniq$level %in% c("AE", "GE"),0,1)

linkage_up <- ifelse(dyn_ae_ge_fam_uniq$level%in% c("GE-AE", "GE-AE-LB"),1,0)

linkage_down <- ifelse(dyn_ae_ge_fam_uniq$level %in% c("AE-LB", "GE-AE-LB", "GE-LB"),1,0)

#ml$prog2 <- relevel(ml$prog, ref = "academic")

# dyn_ae_ge_fam_uniq$success_cat <- as.factor(dyn_ae_ge_fam_uniq$success__cat)

Rising <- ifelse(dyn_ae_ge_fam_uniq$success_cat=="Rising",1,0)

Declining <- ifelse(dyn_ae_ge_fam_uniq$success_cat=="Declining",1,0)

Stable<- ifelse(dyn_ae_ge_fam_uniq$success_cat=="Stable",1,0)

success_cat <- dyn_ae_ge_fam_uniq$success_cat

delim_change <- dyn_ae_ge_fam_uniq$delim_change





#success_rate <- dyn_ae_ge_fam_uniq$success_diff
```




### Multinom. ref. - Stable {.tabset}


```{r}




df <- tibble(success_cat, caste_uc, caste_yadav,caste_non_yadav_obc , caste_dalit , caste_muslim ,minister_duration ,industry , land , linkage,linkage_down, minister, edu, second_mem_dur, delim_change, ind_edu)



mean <- df %>% group_by(success_cat)%>% summarise_at( c("linkage_down" , "minister_duration","industry" , "land" , "second_mem_dur"),~mean(., na.rm = TRUE))

min <- df %>%  group_by(success_cat)%>% summarise_at(  c("linkage_down" , "minister_duration","industry" , "land" , "second_mem_dur"),~min(., na.rm = TRUE))

max <- df %>% group_by(success_cat)%>% summarise_at(  c("linkage_down" , "minister_duration","industry" , "land" , "second_mem_dur"),~max(., na.rm = TRUE))

unique_n<- df %>%  group_by(success_cat)%>% summarise_at(  c("linkage_down" , "minister_duration","industry" , "land" , "second_mem_dur"),list(n = "n_distinct"))

n<- df %>%  group_by(success_cat)%>% summarise_at(  c("linkage_down" , "minister_duration","industry" , "land" , "second_mem_dur"),list(n = "length"))


sd<- df %>% group_by(success_cat)%>%  summarise_at(  c("linkage_down" , "minister_duration","industry" , "land" , "second_mem_dur"),list(sd= "sd"), na.rm = TRUE)

stat <-as.data.frame(c("Length","Length","Length", "Unique-N","Unique-N","Unique-N","Mean","Mean","Mean", "SD","SD","SD","Min","Min","Min", "Max", "Max", "Max")) %>% rename("stat"=1:1)




vals <- data.table::rbindlist(list(n,unique_n,mean, sd,min, max), use.names = FALSE)


# cbind(stat, vals) %>% kable(digits = 2, col.names = c("Measure", "Elite catagory", "Political diversification","Minister duration(Months)","Economic diversification","Land ownership(Deciles)", "Years for second member"), caption = "Summary of family data") %>% kable_styling(full_width = F)


```



<!-- #### With second mem. -->






<!-- ```{r message = FALSE, warning = FALSE, echo = FALSE} -->


<!-- success_cat<-factor( success_cat,levels = c( "Stable","Rising","Declining")) -->

<!-- library("nnet") -->



<!-- fit.multinom <- multinom(success_cat~  caste_uc+ caste_yadav+caste_non_yadav_obc + caste_dalit + caste_muslim +minister_duration +industry  + land + linkage_down+ second_mem_dur) -->
<!-- #  -->
<!-- # stargazer(fit.multinom, type = "text") -->
<!-- ``` -->

<!-- ```{r, results= "asis"} -->
<!-- stargazer(fit.multinom, type="html", keep = c("linkage_down","minister_duration","industry",  "land", "second_mem_dur"), order = c("linkage_down","minister_duration","industry",  "land", "second_mem_dur"),add.lines = list (c("Caste control", "Yes","Yes","Yes")),covariate.labels = c( "Political diversification","Minister duration", "Economic diversification", "Land ownership", "Years took for the second member entry")) -->

<!-- ``` -->




#### Declining ref.


```{r message = FALSE, warning = FALSE, echo = FALSE}


success_cat<-factor( success_cat,levels = c( "Declining","Stable","Rising"))



fit.multinom <- multinom(success_cat~  caste_uc+ caste_yadav+caste_non_yadav_obc + caste_dalit + caste_muslim +minister_duration +ind_edu +  land + linkage)
```

```{r, results= "asis"}


stargazer(fit.multinom, type="html", keep = c("linkage","success_cat","minister","ind_edu", "land"),order = c("linkage","success_cat","minister","ind_edu",  "land"),add.lines = list (c("Caste control", "Yes","Yes","Yes")),covariate.labels = c( "Political diversification","Minister", "Economic diversification", "Land ownership"))
```


#### Stable ref.


```{r message = FALSE, warning = FALSE, echo = FALSE}


success_cat<-factor( success_cat,levels = c( "Stable","Rising","Declining"))



fit.multinom <- multinom(success_cat~  caste_uc+ caste_yadav+caste_non_yadav_obc + caste_dalit + caste_muslim +minister_duration +ind_edu +  land + linkage)
```

```{r, results= "asis"}


stargazer(fit.multinom, type="html", keep = c("linkage","success_cat","minister","ind_edu", "land"),order = c("linkage","success_cat","minister","ind_edu",  "land"),add.lines = list (c("Caste control", "Yes","Yes","Yes")),covariate.labels = c( "Political diversification","Minister", "Economic diversification", "Land ownership"))
```




#### Rising ref.


```{r message = FALSE, warning = FALSE, echo = FALSE}


success_cat<-factor( success_cat,levels = c( "Rising","Declining","Stable"))



fit.multinom <- multinom(success_cat~  caste_uc+ caste_yadav+caste_non_yadav_obc + caste_dalit + caste_muslim +minister_duration +ind_edu +  land + linkage)
```

```{r, results= "asis"}


stargazer(fit.multinom, type="html", keep = c("linkage","success_cat","minister","ind_edu", "land"),order = c("linkage","success_cat","minister","ind_edu",  "land"),add.lines = list (c("Caste control", "Yes","Yes","Yes")),covariate.labels = c( "Political diversification","Minister", "Economic diversification", "Land ownership"))
```

---





<!-- ## families -  -->


<!-- ```{r} -->

<!-- fam_list_70 <- dyn_ae_ge_fam %>% ungroup()%>%  filter(success_cat!= "Rising" & year<2001  )%>% arrange(year)%>% distinct(family_id,.keep_all =TRUE) %>% select(year,constituency_no, constituency_name, success_cat) -->


<!-- cen <- read.csv("D:/cpr/UP/up-dynasties/dyn_other_data/francesca/UPdata.csv") -->


<!-- names(cen) <- tolower(names(cen)) -->


<!-- cen_70 <- cen %>% select(ac_number_1976, plit71,p_w71) -->


<!-- cen_fam <- inner_join(fam_list_70, cen_70,by = c("constituency_no"= "ac_number_1976")) -->


<!-- cen_fam %>% group_by(success_cat) %>% summarise(mean(plit71), mean(p_w71)) -->

<!-- ## no difference literate and worker population in 1917 when we compare stable to declining -->



<!-- ``` -->


<!-- ### night lights -->

<!-- ```{r} -->
<!-- fam_list_93 <- dyn_ae_ge_fam %>% ungroup()%>%  filter(success_cat!= "Rising" &year>1992  )%>% arrange(year)%>% distinct(family_id,.keep_all =TRUE) %>% select(year,constituency_no, constituency_name, success_cat) -->

<!-- nl <- read.csv("D:/projects & works/CPR_Verma/dyn_dev.csv") -->

<!-- nl <- nl %>% filter(position==1) %>% select(year, ac07_id,term_growth, annual_growth)   -->

<!-- nl_93 <- nl %>% filter(year == 1993) -->








<!-- nl_fam <- inner_join(nl_93, fam_list_93, by = c( "ac07_id" = "constituency_no")) -->

<!-- nl_fam %>% group_by(success_cat) %>% summarise(mean(term_growth), mean(annual_growth)) -->

<!-- ``` -->


<!-- ## lomg term -->


<!-- ```{r} -->
<!-- dyn_ae_ge_fam %>%filter( success_cat != "Rising") %>% select(year, constituency_no,con_id_uniq, position, family_id, success_cat) %>% group_by(family_id,con_id_uniq) %>% summarise(n()) %>% group_by(family_id) %>% summarise(count = n()) %>% arrange(count) %>% filter(count ==1 ) -->


<!-- dyn_ae_ge_fam_w <- dyn_ae_ge_fam %>% filter(position ==1& success_cat!= "Rising") -->



<!-- nl_fam_all <- inner_join(nl, dyn_ae_ge_fam_w, by = c("year", "ac07_id" = "constituency_no")) -->

<!-- nl_fam_all %>% group_by(success_cat) %>% summarise(count = n(),mean(term_growth), mean(annual_growth)) -->


<!-- ggplot(nl_fam_all, aes(y=term_growth, x=success_cat))+ -->
<!--   geom_point() -->


<!-- model <- lm(term_growth ~success_cat+ factor(year)+factor(ac07_id),data = nl_fam_all) -->

<!-- summary(model) -->



<!-- nl_fam_all %>%  group_by(success_cat) %>% summarise(n(), n_distinct(family_id)) -->

<!-- ``` -->


<!-- ## duration -->

<!-- family duration = sum of all the assembly duration of the year in which the members have contested -->

<!-- ```{r} -->



<!-- dyn_ae_ge_fam %>% group_by(family_id) %>%distinct(year, .keep_all = TRUE) %>%  summarise(family_duration = sum(term_duration)) %>%  -->
<!--   ggplot(aes(family_duration))+ -->
<!--   geom_histogram(binwidth = 5,  color = "steelblue") -->



<!-- dyn_ae_ge_fam %>% group_by(family_id, success_cat) %>% summarise(family_duration = sum(term_duration)) %>% filter(family_duration<100) %>%  -->

<!--   ggplot(aes(family_duration, fill = success_cat))+ -->
<!--   geom_histogram(binwidth = 5, alpha = .7) -->


<!-- dyn_ae_ge_fam %>%ungroup() %>% arrange(year) %>%   distinct(election_type, year) %>% kable() -->



<!--  dyn_ae_ge_fam %>% -->
<!--    group_by(family_id) %>%  -->
<!--    distinct(year, .keep_all = TRUE) %>% -->
<!--   select(family_id,election_type, year, position, term_duration) %>% -->
<!--   arrange(family_id,year) %>% -->
<!--    mutate(year_diff = year- lag(year, default = 0), -->
<!--          # year_diff = ifelse(year_diff>lag(term_duration),0,year_diff), -->
<!--           year_diff_1 = lead(year_diff,default = 0), -->
<!--          year_diff_1 = ifelse(year_diff_1==0|year_diff_1>5|year_diff_1<0 ,term_duration, year_diff_1)) %>% -->
<!--    filter(family_id == "f0015702") -->


<!--   ## contest -->


<!--  dyn_ae_ge_fam %>%  -->
<!--    group_by(family_id) %>%  -->
<!--    distinct(year, .keep_all = TRUE) %>% -->
<!--   arrange(family_id,year) %>%  -->
<!--    mutate(year_diff = year- lag(year, default = 0), -->
<!--          # year_diff = ifelse(year_diff>lag(term_duration),0,year_diff), -->
<!--           year_diff_1 = lead(year_diff,default = 0), -->
<!--          year_diff_1 = ifelse(year_diff_1==0|year_diff_1>5|year_diff_1<0 ,term_duration, year_diff_1)) %>%  -->
<!--   ungroup() %>%  -->
<!--     group_by(family_id) %>% -->
<!--  summarise(family_duration = sum(year_diff_1)) %>%   -->

<!--   ggplot(aes(family_duration))+ -->

<!--   geom_histogram(binwidth = 5,  color = "steelblue") -->





<!--  ## winning -->

<!--   dyn_ae_ge_fam %>%  -->
<!--     filter(position==1) %>%  -->
<!--    group_by(family_id) %>%  -->
<!--    distinct(year, .keep_all = TRUE) %>% -->
<!--   arrange(family_id,year) %>%  -->
<!--    mutate(year_diff = year- lag(year, default = 0), -->
<!--          # year_diff = ifelse(year_diff>lag(term_duration),0,year_diff), -->
<!--           year_diff_1 = lead(year_diff,default = 0), -->
<!--          year_diff_1 = ifelse(year_diff_1==0|year_diff_1>5|year_diff_1<0 ,term_duration, year_diff_1)) %>%  -->
<!--   ungroup() %>%  -->
<!--     group_by(family_id) %>% -->
<!--  summarise(family_duration = sum(year_diff_1)) %>%   -->

<!--   ggplot(aes(family_duration))+ -->

<!--   geom_histogram(binwidth = 5,  color = "steelblue") -->




<!-- ``` -->


<!-- ## succes cat -->

<!-- ```{r} -->

<!--  ## succes cats - contest -->


<!--   dyn_ae_ge_fam %>%  -->
<!--    group_by(family_id) %>%  -->
<!--    distinct(year, .keep_all = TRUE) %>% -->
<!--   arrange(family_id,year) %>%  -->
<!--    mutate(year_diff = year- lag(year, default = 0), -->
<!--          # year_diff = ifelse(year_diff>lag(term_duration),0,year_diff), -->
<!--           year_diff_1 = lead(year_diff,default = 0), -->
<!--          year_diff_1 = ifelse(year_diff_1==0|year_diff_1>5|year_diff_1<0 ,term_duration, year_diff_1)) %>%  -->
<!--   ungroup() %>%  -->
<!--     group_by(family_id, success_cat) %>% -->
<!--  summarise(family_duration = sum(year_diff_1)) %>%   -->

<!--   ggplot(aes(family_duration, fill = success_cat))+ -->
<!--   geom_histogram() -->


<!-- ``` -->


<!-- # Political variables {.tabset} -->

<!-- ```{r} -->

<!--  dur_list_c <- dyn_ae_ge_fam %>%  -->
<!--    group_by(family_id) %>%  -->
<!--    distinct(year, .keep_all = TRUE) %>% -->
<!--   arrange(family_id,year) %>%  -->
<!--    mutate(year_diff = year- lag(year, default = 0), -->
<!--          # year_diff = ifelse(year_diff>lag(term_duration),0,year_diff), -->
<!--           year_diff_1 = lead(year_diff,default = 0), -->
<!--          year_diff_c = ifelse(year_diff_1==0|year_diff_1>5|year_diff_1<0 ,term_duration, year_diff_1)) %>% -->
<!--   select(family_id, year, year_diff_c) %>%  -->
<!--   group_by(family_id) %>%  -->
<!--   mutate(cum_dur_c = cumsum(lag(year_diff_c, default = 0))) %>% ungroup() -->


<!-- ## won -->

<!-- dur_list_w <- dyn_ae_ge_fam %>%  -->
<!--   filter(position ==1) %>%  -->
<!--    group_by(family_id) %>%  -->
<!--    distinct(year, .keep_all = TRUE) %>% -->
<!--   arrange(family_id,year) %>%  -->
<!--    mutate(year_diff = year- lag(year, default = 0), -->
<!--          # year_diff = ifelse(year_diff>lag(term_duration),0,year_diff), -->
<!--           year_diff_1 = lead(year_diff,default = 0), -->
<!--          year_diff_w = ifelse(year_diff_1==0|year_diff_1>5|year_diff_1<0 ,term_duration, year_diff_1)) %>% -->
<!--   select(family_id, year, year_diff_w) %>%  -->
<!--   group_by(family_id) %>%  -->
<!--   mutate(cum_dur_w = cumsum(lag(year_diff_w, default = 0))) %>% ungroup() -->

<!-- dyn_fam_dur <- left_join(dyn_ae_ge_fam, dur_list_c,by = c("family_id","year") ) -->

<!-- dyn_fam_dur <- left_join(dyn_fam_dur, dur_list_w,by = c("family_id","year") ) -->

<!-- library(patchwork) -->

<!-- ``` -->


<!-- ## margin -->

<!-- ```{r} -->

<!-- mv_c <- ggplot(dyn_fam_dur %>%filter(position ==1& margin_percentage<60), aes(cum_dur_c, margin_percentage))+ -->
<!--   geom_point()+ -->
<!--   geom_smooth(method = "lm", se= FALSE)+ -->
<!--   labs(x = "life duration - contestded")+ -->
<!--   theme_light() -->

<!-- mv_w <- ggplot(dyn_fam_dur %>%filter(position ==1& margin_percentage<60), aes(cum_dur_w, margin_percentage))+ -->
<!--   geom_point()+ -->
<!--   geom_smooth(method = "lm", se= FALSE)+ -->
<!--   labs(x = "life duration - won")+ -->
<!--   theme_light() -->

<!-- mv_c+mv_w +plot_annotation(title = "Margin percentage as a function of cumulative years in politics") -->

<!-- ``` -->


<!-- ## vote share percentage -->

<!-- ```{r} -->
<!-- vs_c <- ggplot(dyn_fam_dur %>%filter( margin_percentage<60 ), aes(cum_dur_c,vote_share_percentage))+ -->
<!--   geom_point()+ -->
<!--   geom_smooth(method = "lm", se= FALSE)+ -->
<!--   labs(x = "life duration - contestded")+ -->
<!--   theme_light() -->

<!-- vs_w <- ggplot(dyn_fam_dur %>%filter(margin_percentage<60), aes(cum_dur_w, vote_share_percentage))+ -->
<!--   geom_point()+ -->
<!--   geom_smooth(method = "lm", se= FALSE)+ -->
<!--   labs(x = "life duration - won")+ -->
<!--   theme_light() -->

<!-- vs_c+vs_w +plot_annotation(title = "Vote share percentage as a function of cumulative years in politics", -->
<!--                            subtitle = "Winners & Runner ups") -->
<!-- ``` -->

<!-- # census varaibles -->


<!-- ```{r} -->

<!-- cen <- read.csv("D:/cpr/UP/up-dynasties/dyn_other_data/francesca/UPdata.csv") -->


<!-- names(cen) <- tolower(names(cen)) -->


<!-- cen_70 <- cen %>% select(ac_number_1976, plit71,p_w71) -->


<!-- cen_fam <- inner_join(dyn_fam_dur, cen_70,by = c("constituency_no"= "ac_number_1976")) -->

<!-- dyn_yr_list <- dyn_fam_dur %>% group_by(con_id_uniq) %>% mutate(tot_dyn_year = sum(year_diff_w, na.rm = TRUE)) %>%  group_by(con_id_uniq)%>%  filter(year ==min(year)& !is.na(con_id_uniq)& con_id_uniq!= ""& year<2000) %>% distinct(year, .keep_all = TRUE) %>% select(constituency_no, tot_dyn_year) -->



<!-- cen_fam <- inner_join(dyn_yr_list ,cen_70,by = c("constituency_no"= "ac_number_1976")) -->


<!-- ggplot(cen_fam, aes(tot_dyn_year,plit71))+ -->
<!--   geom_point()+ -->
<!--   geom_smooth(method = "lm", se= FALSE)+ -->
<!--   labs(x = "years ruled by a  dynasts in an AC", y = "Literacy - 1970")+ -->
<!--   theme_light() -->



<!-- ``` -->



<!-- ```{r} -->


<!-- cen <- read.csv("D:/cpr/UP/up-dynasties/dyn_other_data/francesca/UPdata.csv") -->


<!-- names(cen) <- tolower(names(cen)) -->


<!-- cen_70 <- cen %>% select(ac_number_1976, plit71,p_w71,sc_percent71_true,pfemale,plit,pnonw,pmain,pmarg,p_elecvd01,p_medicvd01,p_al) -->


<!-- dyn_ae <- dyn_ae %>%  group_by(year, constituency_no) %>% mutate(dynast_1_2 =ifelse(any( position %in% c(1,2)) & any( dyn_cum_2==1),1,0)) %>%ungroup() -->

<!-- dyn_dur <- dyn_ae %>% filter(year<2002& position==1) %>% group_by(constituency_no) %>% summarise(dyn_dur=sum(term_duration[dyn_cum_2==1]), dyn_dur_c = sum(term_duration[dynast_1_2==1])) -->




<!-- cen_fam <- inner_join(dyn_dur ,cen_70,by = c("constituency_no"= "ac_number_1976")) -->


<!-- ggplot(cen_fam, aes(dyn_dur,plit71))+ -->
<!--   geom_point()+ -->
<!--   geom_smooth(method = "lm", se= FALSE)+ -->
<!--   labs(x = "years ruled by a  dynasts in an AC", y = "Literacy - 1970")+ -->
<!--   theme_light() -->


<!-- cen_fam$dyn_rule <- ifelse(cen_fam$dyn_dur>0,1,0) -->

<!-- cen_fam$dyn_c <- ifelse(cen_fam$dyn_dur_c>0,1,0) -->

<!-- # cen_fam %>% group_by(dyn_rule) %>% summarise(across(2:13, mean)) %>% data.table::melt(1:1) %>% pivot_wider(names_from = 1:1, values_from = 3:3) %>% kable(digits = 1, col.names = c("Mean of census variable","Dynast rule", "No dynast rule")) %>% kable_styling(full_width = F) -->



<!-- ##boxplot -->

<!-- cen_fam <- cen_fam %>% mutate(dyn_rule_cat = case_when(dyn_dur_c==0 ~"0", -->
<!--                                             dyn_dur_c >0 & dyn_dur_c<6~"1-5", -->
<!--                                             dyn_dur_c>=6~"6+", -->
<!--                                             TRUE ~"X")) -->

<!-- ggplot(cen_fam, aes(dyn_rule_cat, plit))+ -->
<!--   geom_boxplot()+ -->
<!--   ylim(0,50) -->

<!-- cen_fam <- cen_fam %>% mutate(dyn_rule_cat_1 = case_when(dyn_dur_c==0 ~"0", -->
<!--                                             dyn_dur_c >0 & dyn_dur_c<11~"1-5", -->
<!--                                             dyn_dur_c>=11~"11+", -->
<!--                                             TRUE ~"X")) -->


<!-- cen_fam %>% group_by(dyn_rule_cat_1) %>% summarise(mean(plit)) -->

<!-- ggplot(cen_fam, aes(dyn_rule_cat_1, plit))+ -->
<!--   geom_boxplot()+ -->
<!--   ylim(0,50) -->



<!-- ``` -->



<!-- I created a binary variable that that tell us whether atleast a dynast has won or not in constituency in lat 30 year (1970-2001). MAong 403, there were 85 constituencies in which atleast a dynast has won. Then I took the average of all census variable for both th year 1971 and 2001. -->


<!-- ```{r} -->

<!-- cen_fam_long <- cen_fam %>% filter(dyn_dur_c>0) -->



<!-- ggplot(cen_fam_long, aes(dyn_dur_c))+ -->
<!--   geom_histogram(binwidth = 5, color = "steelblue")+ -->
<!--   xlim(0,40) -->


<!-- cen_fam_long$dyn_rule_long <- ifelse(cen_fam_long$dyn_dur>median(cen_fam_long$dyn_dur),1,0) -->


<!-- # cen_fam_long %>% group_by(dyn_rule_long) %>% summarise(across(2:13, mean)) %>% data.table::melt(1:1) %>% pivot_wider(names_from = 1:1, values_from = 3:3) %>% kable(digits = 1, col.names = c("Mean of census variable","Dynast rule - below median", " dynast rule - above median")) %>% kable_styling(full_width = F) -->

<!-- ggplot(cen_fam_long, aes(plit, dyn_dur))+ -->
<!--   geom_point()+ -->
<!--   geom_smooth(method = "lm", se = FALSE) -->

<!-- ``` -->



<!-- after that , I focused on those constituencies in which atleast one dynast has won (85). hsitogram of length of dynast rule among these 85 is attached. I categorised them into above and below median(6). So 24 of them were above and 61 were below. then took the mean again -->


<!-- 1. Map with binary variable - dynasty/no-dynasty  -->
<!-- 2. Map withmultiple categories - long dynasty, mid-dynasty, no-dynasty. -->

# survival analysis {.tabset}

```{r}
library(survival)
library(survminer)

dyn_life <- dyn_ae_ge %>% filter(dyn_tot_2==1)%>% group_by(family_id) %>%  mutate(fam_life_c=sum(term_duration), fam_life_w = sum(term_duration[position ==1])) %>% arrange(-year) %>% distinct(family_id, .keep_all= TRUE) %>% select(family_id, year, fam_life_c, fam_life_w) %>% ungroup() %>% mutate(cen= ifelse(year>2012,1,0))


fam_life <-  dyn_ae_ge_fam %>%filter(success_cat!= "Rising") %>% 
   group_by(family_id) %>% 
   distinct(year, .keep_all = TRUE) %>%
  select(family_id,election_type, year, position, term_duration) %>%
  arrange(family_id,year) %>%
   mutate(year_diff = year- lag(year, default = 0),
         # year_diff = ifelse(year_diff>lag(term_duration),0,year_diff),
          year_diff_1 = lead(year_diff,default = 0),
         year_diff_1 = ifelse(year_diff_1==0|year_diff_1>5|year_diff_1<0 ,term_duration, year_diff_1)) %>%
   group_by(family_id) %>% 
   summarise(fam_life = sum(year_diff_1))



 
 
 fam_year <-  dyn_ae_ge_fam %>% group_by(family_id) %>% summarise(max_year = max(year), min_year = min(year),
                                                                  max_year_2 = lag(max(year)))
 
 fam <- right_join(fam_year,fam_life , by = "family_id" )
 
 
 fam <- fam %>% mutate(max_10 = max_year+10,
                dead= ifelse(max_10<2018,2,1),
                cen = ifelse(min_year>2008,1,0),
                dead1 = ifelse(max_year>2012,1,0),
                dead2 = ifelse(max_year>2003,1,0),
 )
 
 
 fam <- fam %>% mutate(decade = cut(min_year, breaks = c(1970,1990,2020), labels = c("Pre-90","Post-90"), right = FALSE))
 
 
 
 
 
 
 fam_df1 <- inner_join(fam, fam_df, by = "family_id")
 
 
 
 
 
sub_reg <- read.csv( "D:/cpr/UP/up-dynasties/dyn_other_data/sub_reg_all.csv")

fam_df1 <- left_join(fam_df1, sub_reg, by =c("election_type","constituency"="constituency_name"))
 
 f1 <- survfit(Surv(fam_life, dead) ~ 1, data = fam)

```






```{r}
## fam life 2



fam_life_2 <-  dyn_ae_ge_fam %>%
   group_by(family_id) %>% 
  filter(dyn_cum_2 ==1) %>% 
   distinct(year, .keep_all = TRUE) %>%
  select(family_id,election_type, year, position, term_duration) %>%
  
  arrange(family_id,year) %>%
   mutate(year_diff = year- lag(year, default = 0),
         # year_diff = ifelse(year_diff>lag(term_duration),0,year_diff),
          year_diff_1 = lead(year_diff,default = 0),
         year_diff_1 = ifelse(year_diff_1==0|year_diff_1>5|year_diff_1<0 ,term_duration, year_diff_1)) %>%
   group_by(family_id) %>% 
   summarise(fam_life2 = sum(year_diff_1), min_fam_year= min(year))

fam_df1 <- inner_join(fam_df1, fam_life_2, by = "family_id")


 

```

## Base survival plots {.tabset}



### all entities

```{r}


ent_life <-  dyn_ae_ge %>%
   group_by(family_id) %>% 
   distinct(year, .keep_all = TRUE) %>%
  select(family_id,election_type, year, position, term_duration) %>%
  arrange(family_id,year) %>%
   mutate(year_diff = year- lag(year, default = 0),
         # year_diff = ifelse(year_diff>lag(term_duration),0,year_diff),
          year_diff_1 = lead(year_diff,default = 0),
         year_diff_1 = ifelse(year_diff_1==0|year_diff_1>5|year_diff_1<0 ,term_duration, year_diff_1)) %>%
   group_by(family_id) %>% 
   summarise(fam_life = sum(year_diff_1),
             n_el_w = sum(ifelse(position==1,1,0)))

 
ent_year <-  dyn_ae_ge%>% group_by(family_id) %>% summarise(max_year = max(year), min_year = min(year),
                                                                  max_year_2 = lag(max(year)))
 
 ent <- right_join(ent_year,ent_life , by = "family_id" )


ent <- ent %>% mutate(
                dead= ifelse(max_year<2008,2,1))

# ent <-  ent%>% mutate(min_decade = year(as.Date(ISOdate(cut(min_year, breaks = c(1970,1989,1999,2010,2020), labels = c(1970,1980,1990,2010), include.lowest = TRUE, right = FALSE), 1, 1))))


ent <- ent %>% mutate(min_decade = cut(min_year, breaks = c(1970,1988,2000,2010,2020), labels = c("74-88","89-99","00-09","Post 2010"), right = FALSE))



                
ent$decade <- ent$min_decade

ggsurvplot(survfit(Surv(fam_life,dead) ~decade , data = ent), 
           title = "Survival of entities in elections",
     xlab = "Years", 
     ylab = "Overall survival probability",
     risk.table = TRUE,
      risk.table.col = "strata",
ggtheme = theme_light(), # customize plot and risk table with a theme.
          risk.table.y.text.col = T,# colour risk table text annotations.
          risk.table.height = 0.3, # the height of the risk table
          risk.table.y.text = FALSE,# show bars instead of names in text annotations
                                    # in legend of risk table

)

```


### won

```{r}


ent$decade <- ent$min_decade

ggsurvplot(survfit(Surv(fam_life,dead) ~decade , data = subset(ent %>% filter(n_el_w>0))), 
           title = "Survival of winning entities in elections",
     xlab = "Years", 
     ylab = "Overall survival probability",
     risk.table = TRUE,
      risk.table.col = "strata",
ggtheme = theme_light(), # customize plot and risk table with a theme.
          risk.table.y.text.col = T,# colour risk table text annotations.
          risk.table.height = 0.3, # the height of the risk table
          risk.table.y.text = FALSE,# show bars instead of names in text annotations
                                    # in legend of risk table

)

```





### all fam

```{r}

splots1 <- list()
splots1[[1]] <- ggsurvplot(survfit(Surv(fam_life, dead) ~1 , data = fam), 
     xlab = "Years", 
     ylab = "Overall survival probability",
     title = "Survival of all families",
          risk.table = TRUE,
      risk.table.col = "strata",
ggtheme = theme_light(), # customize plot and risk table with a theme.
          risk.table.y.text.col = T,# colour risk table text annotations.
          risk.table.height = 0.3, # the height of the risk table
          risk.table.y.text = FALSE
           

)
```




```{r}




splots1[[2]] <- ggsurvplot(survfit(Surv(fam_life,dead) ~decade , data = fam), 
           title = "",
     xlab = "Years", 
     ylab = "",
     risk.table = TRUE,
      risk.table.col = "strata",
ggtheme = theme_light(), # customize plot and risk table with a theme.
          risk.table.y.text.col = T,# colour risk table text annotations.
          risk.table.height = 0.3, # the height of the risk table
          risk.table.y.text = FALSE,
 legend.labs =
    c("Pre-90", "Post-90")
           

)



arrange_ggsurvplots(splots1, print = TRUE,
  ncol = 2, nrow = 1, risk.table.height = 0.25)


```
### after became fam 

```{r}


splots2 <- list()

splots2[[1]] <- ggsurvplot(survfit(Surv(fam_life2,dead) ~1 , data = fam_df1), 
           title = "Survival of families",
           subtitle = "Once after they become a family",
     xlab = "Years", 
     ylab = "Overall survival probability",
     risk.table = TRUE,
      risk.table.col = "strata",
ggtheme = theme_light(), # customize plot and risk table with a theme.
          risk.table.y.text.col = T,# colour risk table text annotations.
          risk.table.height = 0.3, # the height of the risk table
          risk.table.y.text = FALSE
           

)


 fam_df1 <- fam_df1 %>% mutate(decade_after = cut(min_fam_year, breaks = c(1970,1990,2020), labels = c("Pre-90","Post-90"), right = FALSE))
 
 
splots2[[2]] <-  ggsurvplot(survfit(Surv(fam_life2,dead) ~decade_after , data = fam_df1), 
           title = "",
           subtitle = "",
     xlab = "Years", 
     ylab = "",
     risk.table = TRUE,
      risk.table.col = "strata",
ggtheme = theme_light(), # customize plot and risk table with a theme.
          risk.table.y.text.col = T,# colour risk table text annotations.
          risk.table.height = 0.3, # the height of the risk table
          risk.table.y.text = FALSE,
 legend.labs =
    c("Pre-90", "Post-90")
           

)
 
 
 
arrange_ggsurvplots(splots2, print = TRUE,
  ncol = 2, nrow = 1, risk.table.height = 0.25)

 
```




<!-- ### sub-region -->

<!-- ```{r} -->

<!-- ggsurvplot(survfit(Surv(fam_life, dead) ~sub_region , data = fam_df1),  -->
<!--      xlab = "Years",  -->
<!--      ylab = "Overall survival probability") -->

<!-- ``` -->

### education


```{r}

ggsurvplot(survfit(Surv(fam_life, dead) ~edu , data = fam_df1), 
     xlab = "Years", 
     ylab = "Overall survival probability",
     ggtheme = theme_light(),
     title = "Survival of political families wrt caste")

```


<!-- ### econ diverse -->

<!-- ```{r} -->
<!-- ggsurvplot(survfit(Surv(fam_life, dead) ~ industry, data = fam_df1),  -->
<!--      xlab = "Years",  -->
<!--      ylab = "Overall survival probability") -->




<!-- ``` -->

---

```{r}
s_econ1 <- ggsurvplot(survfit(Surv(fam_life, dead) ~industry , data = subset(fam_df1 %>% filter(decade == "Pre-90" ))), 
            title = "Survival of political families wrt economic diversification",
     xlab = "Years", 
     ylab = "Overall survival probability",
     ggtheme = theme_light(),
     subtitle = "Pre-90")

 s_econ2 <- ggsurvplot(survfit(Surv(fam_life, dead) ~industry , data = subset(fam_df1 %>% filter(decade == "Post-90" ))), 
    title = "",
     xlab = "Years", 
     ylab = "",
     ggtheme = theme_light(),
     subtitle = "Post-90")
 
 
 s_econ1$plot+s_econ2$plot

```



### land

```{r}
ggsurvplot(survfit(Surv(fam_life, dead) ~ land, data = fam_df1), 
     xlab = "Years", 
     ylab = "Overall survival probability",
     
     
            title = "Survival of political families wrt economic diversification",
     subtitle = "Land measured in bhigas",
     ggtheme = theme_light(),
      legend.labs = c("No land","Below 100","101-250","251-500", "Above 500"),
     legend = "bottom")
```

### caste

```{r}
# 
 # ggsurvplot(survfit(Surv(fam_life, dead) ~caste_groups , data = fam_df1), 
 #            title = "Survival of political families wrt caste",
 #     xlab = "Years", 
 #     ylab = "Overall survival probability",
 #     ggtheme = theme_light())


 fam_df1 <-  fam_df1 %>% mutate(caste = case_when(as.character(caste_groups )%in% c("Non-Yadav OBC","Yadav")~"OBC",
                                                  TRUE ~as.character(caste_groups )))
  
  
   ggsurvplot(survfit(Surv(fam_life, dead) ~caste , data = subset(fam_df1 %>%filter(caste!= "Others") )), 
     xlab = "Years", 
     ylab = "Overall survival probability",
     ggtheme = theme_light(),
     title = "Survival of political families wrt caste")
```


---



```{r}
## pos and pre
   
   dc1 <- ggsurvplot(survfit(Surv(fam_life, dead) ~caste , data = subset(fam_df1 %>% filter(decade == "Pre-90" &caste!= "Others"))), 
            title = "Survival of political families wrt caste",
     xlab = "Years", 
     ylab = "Overall survival probability",
     ggtheme = theme_light(),
     subtitle = "Pre-90", legend= "bottom")

dc2<- ggsurvplot(survfit(Surv(fam_life, dead) ~caste , data = subset(fam_df1 %>% filter(decade == "Post-90" &caste!= "Others"))), 
                 title = "",
     xlab = "Years", 
     ylab = "",
     ggtheme = theme_light(),
     subtitle = "Post-90",
     legend= "none")


dc1$plot +dc2$plot 




```

<!-- ### pol diversifcation -->

<!-- ```{r} -->

<!--  ggsurvplot(survfit(Surv(fam_life, dead) ~linkage , data = fam_df1),  -->
<!--      xlab = "Years",  -->
<!--      ylab = "Overall survival probability") -->



<!--  ggsurvplot(survfit(Surv(fam_life, dead) ~linkage , data = subset(fam_df1 %>% filter(decade == "Pre-90" ))),  -->
<!--             title = "Survival of political families wrt political diversification", -->
<!--      xlab = "Years",  -->
<!--      ylab = "Overall survival probability", -->
<!--      ggtheme = theme_light(), -->
<!--      subtitle = "Pre-90") -->

<!--  ggsurvplot(survfit(Surv(fam_life, dead) ~linkage , data = subset(fam_df1 %>% filter(decade == "Post-90" ))),  -->
<!--     title = "Survival of political families wrt political diversification", -->
<!--      xlab = "Years",  -->
<!--      ylab = "Overall survival probability", -->
<!--      ggtheme = theme_light(), -->
<!--      subtitle = "Post-90") -->
<!-- ``` -->


### Econ diversification grid

 combination of education and industry


```{r}
## school

edu_dummy <- dyn_ae_ge_fam %>% filter(success_cat != "Rising")%>% distinct(family_id, .keep_all = TRUE) %>% 
  mutate(edu_log = ifelse(edu_cat=="None",0,1)) %>%
   rowwise() %>% 
  mutate(ind_all = sum(ind_c1, ind_c2,ind_c3, ind_c4, ind_c5),
         ind_edu = sum(indus_count+edu_log)) %>% ungroup() %>% 
            
  
  select(family_id, ind_edu) %>% 
  mutate(ind_edu_cat = case_when(ind_edu %in% c(0,1)~"Low",
                                 ind_edu %in% c(2,3)~"Medium",
                                 ind_edu==4 ~"High",
                                 TRUE~"x"))


# ggplot(edu_dummy, aes(ind_edu))+
#   geom_histogram(binwidth  = 1, color = "steelblue")+
#         theme(aspect.ratio=16/9)



fam_df1 <- inner_join(fam_df1, edu_dummy, by = "family_id")

fam_df1$ind_edu_cat <- factor(fam_df1$ind_edu_cat, levels = c("Low","Medium","High") )




 ggind_edu_all <- ggsurvplot(survfit(Surv(fam_life, dead) ~ind_edu_cat , data = fam_df1), 
     xlab = "", 
     #ylab = "Overall survival probability",
     ggtheme = theme_light(),
     subtitle = "All families",
     #title = "Survival of political families wrt economic diversification",
     legend.labs = c("Low","Medium","High"))
 
 ### decades
 


 
    pre_80<- ggsurvplot(survfit(Surv(fam_life, dead) ~ind_edu_cat , data = subset(fam_df1 %>% filter(min_year<1980))), 
     xlab = "", 
     ylab = "",
     ggtheme = theme_light(),
     #title = "Survival of political families wrt economic diversification",
     subtitle = "Pre-1980",
     legend.labs = c("Low","Medium","High"))
    
      pre_90 <- ggsurvplot(survfit(Surv(fam_life, dead) ~ind_edu_cat , data = subset(fam_df1 %>% filter(min_year<1990))), 
     xlab = "Years", 
    
     ggtheme = theme_light(),
     #title = "Survival of political families wrt economic diversification",
     subtitle = "Pre-1990",
     legend.labs = c("Low","Medium","High"),
      )
  
  pre_99 <- ggsurvplot(survfit(Surv(fam_life, dead) ~ind_edu_cat , data = subset(fam_df1 %>% filter(min_year<1999))), 
     xlab = "Years", 
     ylab = "",
     ggtheme = theme_light(),
     #title = "Survival of political families wrt economic diversification",
     subtitle = "Pre-1999",
     legend.labs = c("Low","Medium","High"))
   
   
##
  
   ggind_edu_all$plot+pre_80$plot+ pre_90$plot+pre_99$plot+
    plot_annotation(
    title = "Survival of political families wrt economic diversification"
  )+
    plot_layout(guides = "collect") & theme(legend.position = "bottom")
    
    

   


```


### pol diversification grid


```{r}


 pol_div_all <- ggsurvplot(survfit(Surv(fam_life, dead) ~linkage , data = fam_df1), 
     xlab = "", 
     #ylab = "Overall survival probability",
     ggtheme = theme_light(),
     subtitle = "All families",
     #title = "Survival of political families wrt economic diversification",
  legend.labs = c("Pol diversification - NO", "Pol diversification - YES"))
 
 ### decades
 


 
    pre_80<- ggsurvplot(survfit(Surv(fam_life, dead) ~linkage , data = subset(fam_df1 %>% filter(min_year<1980))), 
     xlab = "", 
     ylab = "",
     ggtheme = theme_light(),
     #title = "Survival of political families wrt economic diversification",
     subtitle = "Pre-1980",
     legend.labs = c("Pol diversification - NO", "Pol diversification - YES"))
    
      pre_90 <- ggsurvplot(survfit(Surv(fam_life, dead) ~linkage , data = subset(fam_df1 %>% filter(min_year<1990))), 
     xlab = "Years", 
    
     ggtheme = theme_light(),
     #title = "Survival of political families wrt economic diversification",
     subtitle = "Pre-1990",
     legend.labs = c("Pol diversification - NO", "Pol diversification - YES"))
  
  pre_99 <- ggsurvplot(survfit(Surv(fam_life, dead) ~linkage , data = subset(fam_df1 %>% filter(min_year<1999))), 
     xlab = "Years", 
     ylab = "",
     ggtheme = theme_light(),
     #title = "Survival of political families wrt economic diversification",
     subtitle = "Pre-1999",
     legend.labs = c("Pol diversification - NO", "Pol diversification - YES"))
   
   
  
   pol_div_all$plot+pre_80$plot+ pre_90$plot+pre_99$plot+
    plot_annotation(
    title = "Survival of political families wrt political diversification"
  )+
    plot_layout(guides = "collect") & theme(legend.position = "bottom")
    
```




<!-- #### sub-region - breakup -->

<!-- ```{r} -->

<!-- dc1 <- ggsurvplot(survfit(Surv(fam_life, dead) ~sub_region , data = subset(fam_df1 %>% filter(decade == "Pre-90"))),  -->
<!--      xlab = "Years",  -->
<!--      ylab = "Overall survival probability", -->
<!--      subtitle = "Pre-90") -->





<!-- ``` -->








## coax -proportional hazard regression {.tabset}





### main model

```{r results= "asis"}


fam_df1 <- inner_join(fam, fam_df, by = "family_id")

fit.surv <- coxph(Surv(fam_life, dead) ~ linkage +minister + industry + land + edu + caste_uc + caste_yadav + caste_non_yadav_obc+caste_dalit+caste_muslim , data = fam_df1)




stargazer(fit.surv, type="html",dep.var.labels = "Family life span", keep = c("linkage","minister","industry", "land", "edu"),order = c("linkage","success_cat","minister","industry",  "land", "edu"),add.lines = list (c("Caste control", "Yes")),covariate.labels = c( "Political diversification","Minister", "Economic diversification", "Land ownership", "Educational inst.ownership"), title = "Coax hazard regression")






```


```{r}
# fit.surv1 <- coxph(Surv(fam_diff_decade, dead) ~ linkage +minister + industry + land + edu + caste_uc + caste_yadav + caste_non_yadav_obc+caste_dalit+caste_muslim + factor(min_decade) , data = fam_df1)
# 
# 
# 
# fit.surv2 <- coxph(Surv(fam_diff_decade, dead) ~ linkage +minister + industry + land + edu + caste_uc + caste_yadav + caste_non_yadav_obc+caste_dalit+caste_muslim + factor(min_decade) , data = subset(fam_df1 %>% filter(min_decade>1970)))
# 
# fit.surv3 <- coxph(Surv(fam_diff_decade, dead) ~ linkage +minister + industry + land + edu + caste_uc + caste_yadav + caste_non_yadav_obc+caste_dalit+caste_muslim + factor(min_decade) , data = subset(fam_df1 %>% filter(min_decade>1980)))
# 
# fit.surv3 <- coxph(Surv(fam_diff_decade, dead) ~ linkage +minister + industry + land + edu + caste_uc + caste_yadav + caste_non_yadav_obc+caste_dalit+caste_muslim + factor(min_decade) , data = subset(fam_df1 %>% filter(min_decade>1990)))
# 
# 
# 
# stargazer(fit.surv1, fit.surv2,fit.surv3,
#           type="text", keep = c("linkage","minister","industry", "land", "edu"),order = c("linkage","success_cat","minister","industry",  "land", "edu"),add.lines = list (c("Caste control", "Yes","Yes")),covariate.labels = c( "Political diversification","Minister", "Economic diversification", "Land ownership", "Educational inst.ownership"), title = "Coax hazard regression")

```

### year entry sensitivity


```{r results = "asis"}
fit.surv1 <- coxph(Surv(fam_life, dead) ~ linkage +minister + industry + land + edu + caste_uc + caste_yadav + caste_non_yadav_obc+caste_dalit+caste_muslim + factor(decade) , data = fam_df1)



fit.surv2 <- coxph(Surv(fam_life, dead) ~ linkage +minister + industry + land + edu + caste_uc + caste_yadav + caste_non_yadav_obc+caste_dalit+caste_muslim + factor(decade) , data = subset(fam_df1 %>% filter(min_year>1979)))

fit.surv3 <- coxph(Surv(fam_life, dead) ~ linkage +minister + industry + land + edu + caste_uc + caste_yadav + caste_non_yadav_obc+caste_dalit+caste_muslim + factor(decade) , data = subset(fam_df1 %>% filter(min_year>1985)))




stargazer(fit.surv1, fit.surv2, fit.surv3,dep.var.labels = "Family life span",
          type="html", keep = c("linkage","minister","industry", "land", "edu"),order = c("linkage","success_cat","minister","industry",  "land", "edu"),add.lines = list (c("Start","All","Post 80","Post 90"),c("Caste control", "Yes","Yes", "Yes"), c("Decade control","Yes","Yes", "Yes")),covariate.labels = c( "Political diversification","Minister", "Economic diversification", "Land ownership", "Educational inst.ownership"), title = "Coax hazard regression")
```


### Censoring sensitivity

```{r}

dyn_life <- dyn_ae_ge %>% filter(dyn_tot_2==1)%>% group_by(family_id) %>%  mutate(fam_life_c=sum(term_duration), fam_life_w = sum(term_duration[position ==1])) %>% arrange(-year) %>% distinct(family_id, .keep_all= TRUE) %>% select(family_id, year, fam_life_c, fam_life_w) %>% ungroup() %>% mutate(cen= ifelse(year>2012,1,0))


fam_life_all <-  dyn_ae_ge_fam %>%
   group_by(family_id) %>% 
   distinct(year, .keep_all = TRUE) %>%
  select(family_id,election_type, year, position, term_duration) %>%
  arrange(family_id,year) %>%
   mutate(year_diff = year- lag(year, default = 0),
         # year_diff = ifelse(year_diff>lag(term_duration),0,year_diff),
          year_diff_1 = lead(year_diff,default = 0),
         year_diff_1 = ifelse(year_diff_1==0|year_diff_1>5|year_diff_1<0 ,term_duration, year_diff_1)) %>%
   group_by(family_id) %>% 
   summarise(fam_life = sum(year_diff_1))




 
 
 # fam_year <-  dyn_ae_ge_fam %>% group_by(family_id) %>% summarise(max_year = max(year), min_year = min(year),
 #                                                                  max_year_2 = lag(max(year)))


fam_all <- inner_join(fam_life_all,fam_life_2, by = "family_id")
 
 fam_all <- right_join(fam_year,fam_all , by = "family_id" )
 
 
 
 
 
 
 
 fam_all <- fam_all %>% mutate(
                
                dead_10 = ifelse(max_year>2008,1,2),
                dead_5 = ifelse(max_year>2012,1,2),
                dead_15 = ifelse(max_year>2004,1,2)
 )
 
 
 fam_all <- fam_all %>% mutate(decade = cut(min_year, breaks = c(1970,1990,2020), labels = c("Pre-90","Post-90"), right = FALSE))
 
 
 edu_dummy1 <- dyn_ae_ge_fam %>% distinct(family_id, .keep_all = TRUE) %>% 
  mutate(edu_log = ifelse(edu_cat=="None",0,1)) %>%
   rowwise() %>% 
  mutate(ind_all = sum(ind_c1, ind_c2,ind_c3, ind_c4, ind_c5),
         ind_edu = sum(indus_count+edu_log)) %>% ungroup() %>% 
            
  
  select(family_id, ind_edu) %>% 
  mutate(ind_edu_cat = case_when(ind_edu %in% c(0,1)~"Low",
                                 ind_edu %in% c(2,3)~"Medium",
                                 ind_edu==4 ~"High",
                                 TRUE~"x"))

 
  fam_df2 <- inner_join(fam_all, fam_df, by = "family_id")
  
  fam_df2 <- inner_join(fam_df2, edu_dummy1, by = "family_id")
 
 
```


```{r}
# subset(fam_df2 %>% filter(min_fam_year<2005)) %>% group_by(dead_15) %>% tally()
# 
# 
# subset(fam_df2 %>% filter(min_fam_year<2013)) %>% group_by(dead_5) %>% tally()
# 
# 
# 
# subset(fam_df2 %>% filter(min_fam_year<2009)) %>% group_by(dead_10) %>% tally()
```


- In this section we provide three different cut off to assess whether  a family is dead or not. for eg: If a family is not has to been contesting in las x years we would consider them as dead. The number of families included in the model also change according to the cut-off because we can only include the family that has formed  on or before the cut off years. The break up looks like this:


| Cut off | 5 years | 10 years | 15 years |
|---------|---------|----------|----------|
| alive   | 128     | 110      | 97       |
| dead    | 130     | 90       | 66       |
| total   | 258     | 200      | 163      |




```{r results = "asis"}

fam_df2 <- fam_df2 %>% select(-ind_edu.x, ind_edu = ind_edu.y)


dead.surv1 <- coxph(Surv(fam_life, dead_10) ~ linkage +minister + ind_edu+ land + caste_uc + caste_yadav + caste_non_yadav_obc+caste_dalit+caste_muslim + factor(decade)  , data = subset(fam_df2 %>% filter(min_fam_year<2009)))



dead.surv2 <- coxph(Surv(fam_life, dead_5) ~ linkage +minister + ind_edu+land +  caste_uc + caste_yadav + caste_non_yadav_obc+caste_dalit+caste_muslim  + factor(decade) ,  data = subset(fam_df2 %>% filter(min_fam_year<2013)))

dead.surv3 <- coxph(Surv(fam_life, dead_15) ~ linkage +minister + ind_edu + land + caste_uc + caste_yadav + caste_non_yadav_obc+caste_dalit+caste_muslim + factor(decade)  ,data = subset(fam_df2 %>% filter(min_fam_year<2005)))




stargazer(dead.surv1, dead.surv3, dead.surv2,dep.var.labels = c("Family life span","Family life span","Family life span"),
          type="html", keep = c("linkage","minister","ind_edu", "land"),order = c("linkage","success_cat","minister","ind_edu",  "land"),add.lines = list (c("Years","last 10 years","last 5 years","last 15 years"),c("Caste control", "Yes","Yes", "Yes"), c("Decade control","Yes","Yes", "Yes")),covariate.labels = c( "Political diversification","Minister", "Economic diversification", "Land ownership"), title = "cox hazard proportional model")



```






















