---
title: "WB"
author: "Najah"
date: "2/03/2021"
params:
  orig_date: 'Original Publish Date: 02 March, 2020'
  update_date: !r paste("Updated on:", format(Sys.time(), '%d %B, %Y'))
output:
  html_document:
    theme: flatly
    toc: TRUE
    toc_float: TRUE
    toc_depth: 3
    number_sections: false
    fig_width: 6            
editor_options: 
  chunk_output_type: inline
---

```{r set up, warning=FALSE, include=FALSE, message= FALSE }

knitr::opts_chunk$set(cache = TRUE,echo = FALSE, message=FALSE, warning = FALSE,fig.width = 16/2, fig.height = 9/2)

library(data.table)
library(tidyverse)
library(kableExtra)
library(cowplot)

`%!in%` = Negate(`%in%`)

select <- dplyr::select
```



```{r}

## reading pc files

ac_19 <- readxl::read_xls("D:/cpr/data/GE_PC_AC-main/2019_AC_PC.xls")

ac_14 <-  readxl::read_xlsx("D:/cpr/data/GE_PC_AC-main/2014_AC_PC.xlsx")

#ac_19 <- ac_19 %>% group_by(`State-UT Code & Name`, `AC NO`) %>% mutate(ac_votes=(sum(`VOTES SECURED EVM`, na.rm = TRUE)))

## not filtering nota and ind now since that is needed to calculate votes

wb_19 <- ac_19 %>% filter(`State-UT Code & Name` == "West Bengal" ) %>% ungroup()

## changing to CPIM to CPM

wb_19 <- wb_19 %>% mutate(PARTY = ifelse(PARTY == "CPIM","CPM",PARTY))




wb_14 <- ac_14 %>% filter(`State-UT Code & Name` == "West Bengal" )

wb_14_19 <- rbindlist(list(wb_14,wb_19), use.names = FALSE)

names(wb_14_19) <- tolower(names(wb_14_19))

## changing variable names to append with ac


wb_14_19 <- wb_14_19 %>% rename(state_name = `state-ut code & name`, pc_no = pcno, pc_name = `pc name`, constituency_no = `ac no`, constituency_name = `ac name`, electors = `total electors in ac`, candidate = `candidate name`,votes = `votessecured evm`)


## creating new vote share variable



wb_14_19<- wb_14_19 %>% group_by(year, constituency_no) %>% mutate(election_type = "GE",valid_votes=sum(votes, na.rm = TRUE), vote_share_percentage =( votes/valid_votes)*100,
                                                                   turnout_percentage = (valid_votes/electors)*100) %>% ungroup()

 wb_14_19  <- wb_14_19  %>% group_by(year, constituency_no) %>%  mutate(position = order(order(vote_share_percentage, decreasing=TRUE))) %>% ungroup()
 
 
# pc_ac_wb <- wb_14_19 %>%  ungroup() %>% filter(position==1 & year ==2019) %>% select(pc_no, pc_name,  constituency_no,constituency_name)

#write.csv(pc_ac_wb, "D:/cpr/elections/wb/pc_ac.csv")

## Q - does valid votes include NOTA too?
## adding position


 
 
 ### victory margin but only for first
 

#  
 wb_14_19 <- wb_14_19 %>% arrange(year, constituency_no,-position)%>% group_by(year, constituency_no) %>% mutate( margin_percentage = vote_share_percentage-lag(vote_share_percentage, default = 0))
# 
# wb_14_19 %>% group_by(year, constituency_no)%>% mutate(victory_margin = margin(position==1))
 
 
## reading ac files
 
 wb_ac <- read_csv("D:/cpr/data/tcpd/states/West_Bengal_2020.csv")

names(wb_ac) <- tolower(names(wb_ac))

wb_11_16 <- wb_ac %>% filter(year %in% c(2011,2016) & poll_no ==0)


wb_16 <- wb_11_16 %>% filter(year==2016)

wb_el <- rbindlist(list(wb_14_19, wb_11_16), use.names = TRUE, fill = TRUE)

wb_el <- wb_el %>% mutate(front = case_when(party %in% c("CPM", "CPI", "RSP", "AIFB") ~"LF",
                                   TRUE ~party))
wb_el <- wb_el %>% ungroup()

#& PARTY != "IND" & PARTY!= "NOTA"

#unique(wb_14$PARTY)


#wb_el %>% filter(year == 2019 & position %in% c(1,2)) %>% group_by(party) %>% summarise(n())


```

# Prelim analysis{.tabset}



## Party vote share


```{r}

wb_el <- wb_el  %>% group_by(year) %>% mutate(total_votes_state = sum(votes))

wb_el %>% group_by(year, front) %>% summarise(vs = (sum(votes)/total_votes_state)*100) %>% filter(front %in% c("AITC"  , "BJP",   "INC" , "LF"  )) %>% 
  ggplot(aes(factor(year), vs,group=front, color = front))+
  #geom_bar(stat= "identity", position= "dodge")
  geom_point()+
  geom_line(size = 1)+
  scale_color_manual(values = c("BJP" = "orange",
                                "INC" = "steelblue", 
                                "LF" = "red",
                                "AITC" = "darkgreen")) +
  labs(title = "Vote share of the major parties in the state", y = "Percentage of votes", x = "Year", color = "Party")+
  ylim(0,50)+
  theme_minimal_hgrid()+
  theme(legend.position = "bottom",
        text = element_text(family="serif"),
                            )
        



```

## Seats


```{r}


# wb_el %>% filter(position==1)%>%  group_by(year, front) %>% summarise(count = n()) %>% 
#   ggplot(aes(factor(year), count, fill =front))+
#   geom_bar(stat= "identity", position= "dodge")+
#   facet_wrap(~election_type)
  
wb_el %>% filter(position==1)%>%  group_by(year, front) %>% summarise(count = n())%>% filter(front %in% c("AITC"  , "BJP",   "INC" , "LF"  )) %>% 
  ggplot(aes(factor(year), count, group =front, color = front))+
  #geom_bar(stat= "identity", position= "dodge")
  geom_point()+
  geom_line(size = 1)+
  scale_color_manual(values = c("BJP" = "orange",
                                "INC" = "steelblue", 
                                "LF" = "red",
                                "AITC" = "darkgreen")) +
  ylim(0,250)+
  labs(title = "Seat share of the major parties in the state", y = "Number of seats", x = "Year", color = "front")+
  theme_minimal_hgrid()+
  theme(legend.position = "bottom",
        text = element_text(family="serif"),
                            )
```


## Turnout


```{r}

wb_el %>% group_by(year) %>% summarise(turnout = mean(turnout_percentage)) %>% 
  ggplot(aes(factor(year), turnout, group= 1))+
  geom_point()+
  geom_line(size =1)+
  ylim(70,90)+
  labs(title = "Turnout percentage in the state", y = "Tunrout percentage", x = "Year")+
  theme_minimal_hgrid()+
  theme(legend.position = "bottom",
        text = element_text(family="serif"),
                            )

```

---

## Strike rate


```{r}

wb_el %>% group_by(election_type,front) %>% summarise(contested = n(), won = sum(position==1)) %>%filter(front %in% c("AITC"  , "BJP",   "INC" , "LF"  ))  %>% mutate(strike_rate = (won/contested)*100) %>% 
  ggplot(aes( factor(front, level = c("AITC", "INC", "LF", "BJP")),strike_rate, fill =election_type))+

  geom_bar(stat="identity", position="dodge")+
  labs(title = "Strike rate of parties in the state", y = "Strike rate (%)", x = "Parties", fill = "Election")+
  colorspace::scale_fill_discrete_qualitative(palette= "Dark 2")+
  ylim(0,80)+
  theme_minimal_hgrid()+
  theme(legend.position = "bottom",
        text = element_text(family="serif"),
                            )


```

## Victory margin

![](D:/cpr/misc/analysis/margin_wb.png)

```{r}

# wb_el %>% filter(position==1) %>% group_by(election_type,party) %>% summarise(margin= mean(margin_percentage)) %>% 
#   filter(party %in% c("AITC"  , "BJP",   "INC" , "CPM"  )) %>% 
#     ggplot(aes( factor(party, level = c( "INC","AITC" ,"BJP","CPM")),margin, fill =election_type))+
# 
#   geom_bar(stat="identity", position="dodge")+
#   labs(title = "Margin percentage of parties in the state", y = "Margin (%)", x = "Parties", fill = "Election")+
#   colorspace::scale_fill_discrete_qualitative(palette= "Dark 2")+
#   ylim(0,15)+
#   theme_minimal_hgrid()+
#   theme(legend.position = "bottom",
#         text = element_text(family="serif"))
#  
        
        
# wb_el %>% filter(position==1) %>% group_by(election_type,year,front) %>% summarise(margin= mean(margin_percentage)) %>% 
#   filter(front %in% c("AITC"  , "BJP",   "INC" , "LF"  )) %>% 
#     ggplot(aes(factor(year), margin, group =front, color = front))+
#   #geom_bar(stat= "identity", position= "dodge")
#   geom_point()+
#   geom_line(size = 1)+
#   scale_color_manual(values = c("BJP" = "orange",
#                                 "INC" = "steelblue", 
#                                 "LF" = "red",
#                                 "AITC" = "darkgreen")) +
#   ylim(0,20)+
#   labs(title = "Vicory vargin percentage of  major parties in the state", y = "Margin(%)", x = "Year", color = "front")+
#   theme_minimal_hgrid()+
#   theme(legend.position = "bottom",
#         text = element_text(family="serif"),
#                             )


  

```


<!-- ## BJP vote share trends -->

<!-- where is it gaining from -->

<!-- ```{r} -->
<!-- ##2019 -->

<!-- bjp_19 <- wb_el %>% filter(year ==2019 & front == "BJP") %>% select(constituency_no, vote_share_percentage) %>% rename(BJP = vote_share_percentage) -->

<!-- inc_19 <- wb_el %>% filter(year ==2019 & front == "INC") %>% select(constituency_no, vote_share_percentage) %>% rename(INC = vote_share_percentage) -->

<!-- aitc_19 <- wb_el %>% filter(year ==2019 & front == "AITC") %>% select(constituency_no, vote_share_percentage) %>% rename(AITC = vote_share_percentage) -->
<!-- LF_19 <- wb_el %>% filter(year ==2019 & front == "LF") %>% select( constituency_no, vote_share_percentage) %>%  rename(LF = vote_share_percentage) -->

<!-- vs_reg <- full_join(bjp_19, aitc_19, by='constituency_no') %>% -->
<!--                 left_join(., inc_19, by='constituency_no') %>%  -->
<!--   left_join(., LF_19, by='constituency_no')  -->

<!-- ##2016 -->


<!-- bjp_16 <- wb_el %>% filter( year ==2016 &front == "BJP") %>% select(constituency_no, vote_share_percentage) %>% rename(BJP_16 = vote_share_percentage) -->

<!-- inc_16 <- wb_el%>% filter(year ==2016 &front == "INC") %>% select(constituency_no, vote_share_percentage) %>% rename(INC_16 = vote_share_percentage) -->

<!-- aitc_16 <-wb_el %>% filter(year ==2016 & front == "AITC") %>% select(constituency_no, vote_share_percentage) %>% rename(AITC_16 = vote_share_percentage) -->
<!-- LF_16 <- wb_el %>% filter(year ==2016 & front == "LF") %>% select( constituency_no, vote_share_percentage) %>%  rename(LF_16 = vote_share_percentage) -->

<!-- vs_reg <- full_join(bjp_19, aitc_19, by='constituency_no') %>% -->
<!--                 left_join(., inc_19, by='constituency_no') %>%  -->
<!--   left_join(., LF_19, by='constituency_no')  -->

<!-- vs_reg_16 <- full_join(aitc_16, bjp_16, by='constituency_no') %>% -->
<!--                 left_join(., LF_16, by='constituency_no') %>%  -->
<!--   left_join(., inc_16, by='constituency_no')  -->


<!-- vs_change <- full_join(vs_reg, vs_reg_16, by ='constituency_no' ) -->


<!-- vs_change <- vs_change %>% mutate(aitc_delta = AITC-AITC_16, bjp_delta = BJP-BJP_16, -->
<!--                      inc_delta = INC -INC_16, -->
<!--                      lf_delta = LF-LF_16) -->
<!-- ``` -->


<!-- ## Model -->


<!-- I ran a simple regression model with vote share change of parties in each constituencies in 2019 wrt 2016 election. The dependent variable is BJP's vote share change. It seems that CPM is paying a huge price for BJPs rising dominance. CPM is losing 1.7 percentage point votes as BJP gains one percentage point votes. -->

<!-- ```{r} -->

<!-- ## model -->


<!-- m1 <- lm(data = vs_change, bjp_delta ~ aitc_delta + inc_delta + lf_delta) -->

<!-- library(stargazer) -->


<!-- stargazer(m1, type = "html") -->
<!-- ``` -->














# Spatial distribution{.tabset}


## Seats won



```{r results = 'hide'}
library(sf)

ac_shp <- st_read("D:/cpr/data/shape-file/maps-master/assembly-constituencies/India_AC.shp",quiet = TRUE)



ac_wb <- ac_shp %>% filter(ST_NAME == "WEST BENGAL")

party_19 <-  wb_el %>% ungroup()%>% filter(year ==2019& position==1) %>% select(constituency_no, party) 

party_19_ac <- inner_join(ac_wb, party_19, by = c("AC_NO"= "constituency_no"))
```


```{r results = 'hide'}
ggplot(party_19_ac)+
  geom_sf(aes(fill= party), lwd = .8)+
  scale_fill_manual(values = c("BJP" = "orange",
                                "INC" = "steelblue", 
                                "AITC" = "darkgreen"))+
    theme_map()+
    labs(title ="Constituencies won by Party", subtitle = "2019 WB elections")+
    theme(text = element_text(family = "serif"))


```

## Vote share distribution

```{r}

# 
# ggplot(ac_wb)+
#   geom_sf()

bjp_19 <- wb_el %>% filter( year ==2019 &front == "BJP") %>% select(constituency_no, front,vote_share_percentage) %>% rename(BJP_19 = vote_share_percentage) 


bjp_ac <- inner_join(ac_wb, bjp_19, by = c("AC_NO"= "constituency_no"))


ggplot(bjp_ac)+
  geom_sf(aes(fill= BJP_19))+
  theme_map()+
   colorspace::scale_fill_continuous_sequential(palette = "Oranges")



```



# BJP vote share


BJP's vote share in constituencies won by following parties -

Second column indicates the vote share recieved by the party in the constituencies it has won. Second column indicates BJP's vote share from the same set of constituencies.

```{r}
bjp_19 <- wb_el %>% filter( year ==2019 &front == "BJP") %>% select(constituency_no, front,vote_share_percentage) %>% rename(BJP_19 = vote_share_percentage) 

winner_19 <- wb_el %>% filter( year ==2019 &position==1) %>% select(constituency_no,front, vote_share_percentage) %>% rename(winner_19 = vote_share_percentage, front_19= front)


winner_16 <-  wb_el %>% filter( year ==2016 &position==1) %>% select(constituency_no,front, vote_share_percentage) %>% rename(winner_16 = vote_share_percentage, front_16 = front)

front_16_19 <- full_join(winner_16, winner_19, by = "constituency_no") %>% 
  left_join(.,bjp_19, by = "constituency_no")
```

**2019**




```{r}
front_16_19 %>% group_by(front_19) %>% summarise(mean_winner_vote_share = mean(winner_19, na.rm = TRUE),mean_bjp_vote_share = mean(BJP_19, na.rm = TRUE)) %>% filter(front_19 %!in% c("GOJAM", "IND")) %>% 
  rename( winner_16= front_19) %>% kable()%>% kable_styling(bootstrap_options = "striped")
```


**2016**


```{r}
front_16_19 %>% group_by(front_16) %>% summarise(mean_winner_vote_share = mean(winner_16, na.rm = TRUE),mean_bjp_vote_share = mean(BJP_19, na.rm = TRUE)) %>% filter(front_16 %!in% c("GOJAM", "IND")) %>% 
  rename( winner_16= front_16) %>% kable()%>% kable_styling(bootstrap_options = "striped")


```



#  Women Turnout{.tabset}




Scraped women turnout data from west bengal sec annual reports. No success in finding female turnout for other years yet- . lmk if you know any.


## AE 16

```{r}



wb_16 <- wb_16 %>% ungroup()
fe_to <- read.csv("D:/cpr/elections/wb/female_TO_16.csv")

wb_16<- wb_16 %>% mutate(front = case_when(party %in% c("CPM", "CPI", "RSP", "AIFB") ~"LF",
                                   TRUE ~party))

wb_16_fe <- inner_join(wb_16, fe_to, by = c("constituency_no" = "ac.no"))

wb_16_fe_aitc <- wb_16_fe %>% filter(party=="AITC")

wb_16_fe_3 <- wb_16_fe %>% filter(front%in%c("BJP",  "AITC"))

# ggplot(wb_16_fe_aitc, aes(female_turnout, vote_share_percentage))+
#   geom_point()

ggplot(wb_16_fe_3, aes(female_turnout, vote_share_percentage, color = front))+
  geom_point(alpha=0.5)+
  geom_smooth()+
  scale_color_manual(values = c("BJP" = "orange",
                                
                                "AITC" = "darkgreen")) +
  labs(title = "Female turnout v/s Vote share of the major parties in the state", y = "Vote share(%)",subtitle = "2016 WB Assembly election", x = "Turnout (%)", color = "Party")+
  ylim(0,80)+
  theme_minimal_grid()+
  theme(legend.position = "bottom",
        text = element_text(family="serif"),
                            )

```




pranav's piece on [women electors](https://www.livemint.com/Politics/PyQ7hlxIkiyXlsUqq7JbOL/The-growing-importance-of-women-as-an-electoral-constituency.html)



##  GE 19


```{r}
wb_19_to <- read.csv("D:/cpr/elections/wb/turnout_wb_19.csv")


ge <- fread("D:/cpr/data/tcpd/TCPD_GE_all.csv")


ge %>% filter(State_Name=="Assam" & Year ==2019 & Position==1 & Party == "BJP") %>% summarise(mean(Margin_Percentage))

wb_ge_19 <- ge %>% filter(Year ==2019 & State_Name =="West_Bengal" & Party %in% c("BJP", "AITC"))



wb_ge_to <- inner_join(wb_ge_19, wb_19_to, by = c("Constituency_No"= "pc_no"))

ggplot(wb_ge_to, aes(FEMALE.1, Vote_Share_Percentage, color = Party))+
  geom_point(alpha=0.8)+
  geom_smooth()+
  scale_color_manual(values = c("BJP" = "orange",
                                
                                "AITC" = "darkgreen")) +
  labs(title = "Female turnout v/s Vote share of the major parties in the state", y = "Vote share(%)",subtitle = "2019 WB General election", x = "Turnout (%)", color = "Party")+
  lims(x = c(65,90), y= c(10,65))+
  theme_minimal_grid()+
  theme(legend.position = "bottom",
        text = element_text(family="serif"),
                            )


```


---


# Reserved constiteuncies


```{r}
wb_el <- wb_el %>% ungroup()



res <- wb_el %>% filter(year==2016 & position==1) %>% select(constituency_no, constituency_type) %>% rename(reservation=constituency_type )

table(res$reservation)
```

## Party vote share{.tabset}







### SC and ST seperate

```{r}
wb_el_res <- inner_join(wb_el, res, by= "constituency_no")

wb_el_res %>% filter(year %in% c(2016,2019)) %>% group_by(year,reservation, party) %>% summarise(vs = mean(vote_share_percentage)) %>% filter(party %in% c("BJP","AITC")) %>% 
  ggplot(aes(reservation, vs, fill = party))+
  geom_bar(stat= "identity", position = "dodge")+
  facet_wrap(~year)+
  scale_fill_manual(values = c("BJP" = "orange",
                                "AITC" = "darkgreen")) +
  labs(title = "Average vote share percentage wrt constiteuncy type", x = "Constituency type", y = "Vote share(%)" )+
    theme_minimal_hgrid()+
  theme(legend.position = "bottom",
        text = element_text(family="serif"),
                            )
```

### SC and ST aggregate


```{r}
res_table <- wb_el_res %>% filter(year %in% c(2016,2019)) %>% group_by(year,reservation, party) %>% summarise(vs = mean(vote_share_percentage)) %>% filter(party %in% c("BJP","AITC"))

res_table$reservation1 <- ifelse(res_table$reservation == "GEN", "GEN", "SC/ST")

ggplot(res_table,(aes(reservation1, vs, fill = party)))+
  geom_bar(stat= "identity", position = "dodge")+
  facet_wrap(~year)+
    scale_fill_manual(values = c("BJP" = "orange",
                                "AITC" = "darkgreen"))+
  labs(title = "Average vote share percentage wrt constiteuncy type", x = "Constituency type", y = "Vote share(%)" )+
    theme_minimal_hgrid()+
  theme(legend.position = "bottom",
        text = element_text(family="serif"),
                            )

  

```

### boxplot



```{r}

wb_el_res$reservation1 <-  ifelse(wb_el_res$reservation == "GEN", "GEN", "SC/ST")

ggplot(wb_el_res %>% filter(party %in% c("BJP","AITC")& year %in% c(2016,2019)), aes(reservation1, vote_share_percentage, fill = party))+
  geom_boxplot()+
  facet_wrap(~year)+
    scale_fill_manual(values = c("BJP" = "orange",
                                "AITC" = "darkgreen"))+
  labs(title = "Average vote share percentage wrt constiteuncy type", x = "Constituency type", y = "Vote share(%)", fill = "Party" )+
    theme_minimal_hgrid()+
  theme(legend.position = "bottom",
        text = element_text(family="serif"),
                            )


```

## Vote share change{.tabset}


Parties vote share as a function of SC/ST population.



```{r}
shrug_cen <- read.csv("D:/cpr/elections/wb/wb_shrug_census.csv")

shrug_cen$ac_no <- as.numeric(str_sub(shrug_cen$Ã¯..ac08_id,-3))

wb_vs_16 <- wb_el %>% filter(party %in% c("BJP", "AITC") & year == 2016) %>% select(year,constituency_no,party, vote_share_percentage) %>% rename(vs_16 = vote_share_percentage)

wb_vs_19 <- wb_el %>% filter(party %in% c("BJP", "AITC") & year == 2019) %>% select(year,constituency_no,party, vote_share_percentage) %>% rename(vs_19 = vote_share_percentage)

wb_vs_16_19 <- inner_join(wb_vs_16 , wb_vs_19, by = c("constituency_no", "party"))

wb_vs_16_19$vs_change <- wb_vs_16_19$vs_19- wb_vs_16_19$vs_16

shrug_sc <- shrug_cen %>% select(ac_no, sc_pc, st_pc) %>% mutate(sc_st_pc = sc_pc +st_pc)

## left_congress

wb_el <- wb_el %>% mutate(front_new = case_when(party %in% c("CPM", "CPI", "RSP", "AIFB", "INC") ~"LF+INC",
                                                
                                   TRUE ~party))

wb_vs_16_lf  <- wb_el %>% filter(front_new %in% c("LF+INC", "AITC") & year == 2016) %>% select(year,constituency_no,front_new, vote_share_percentage) %>% rename(vs_16 = vote_share_percentage)

wb_vs_19_lf<- wb_el %>% filter(front_new %in% c("LF+INC","AITC") & year == 2019) %>% select(year,constituency_no,front_new, vote_share_percentage) %>% rename(vs_19 = vote_share_percentage)


wb_vs_16_19_lf <- inner_join(wb_vs_16_lf , wb_vs_19_lf, by = c("constituency_no", "front_new"))

wb_vs_16_19_lf$vs_change <- wb_vs_16_19_lf$vs_19- wb_vs_16_19_lf$vs_16


#####

wb_sc<- dplyr::inner_join(wb_vs_16_19, shrug_sc, by = c("constituency_no" = "ac_no"))
```


### ST - BJP & AITC - 2016-19

```{r fig.dim = c(10, 4.5)}
sc <- ggplot(wb_sc, aes(sc_pc, vs_change, color = party))+
  geom_point(alpha = .5)+
  geom_smooth(se = FALSE, method = "lm")+
    scale_color_manual(values = c("BJP" = "orange",
                              
                                
                                "AITC" = "steelblue")) +
  ggthemes::theme_fivethirtyeight()+
  labs( color = "Party", x= "SC Percentage", y = "Change in vote share % (2016 to 2019)")+
  scale_x_continuous(limits = c(0,80))+
  scale_y_continuous(limits = c(-20,60) )+
  theme(legend.position = "bottom",
        text = element_text(family="serif", face = "bold"),
        axis.title = element_text()
                            )

st <- ggplot(wb_sc, aes(st_pc, vs_change, color = party))+
  geom_point(alpha = .5)+
  geom_smooth(se = FALSE, method = "lm")+
    scale_color_manual(values = c("BJP" = "orange",
                              
                                
                                "AITC" = "steelblue")) +
  ggthemes::theme_fivethirtyeight()+
  labs( color = "Party", x= "ST Percentage", y = "Change in vote share % (2016 to 2019)")+
  scale_x_continuous(limits = c(0,50))+
  scale_y_continuous(limits = c(-20,60) )+
  theme(legend.position = "bottom",
        text = element_text(family="serif", face = "bold"),
        axis.title = element_text()
                            )


library(cowplot)
sc_st <- plot_grid(sc,st)

title <- ggdraw() + 
  draw_label(
    "Change in party vote share wrt SC/ST population",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )
 plot_grid(
  title, sc_st,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

 #ggsave("sc_st.png", width = 10, height = 4.3)

# shrug_cen <- dplyr::inner_join(wb_vs_16_19, shrug_sc, by = c("constituency_no" = "ac_no")) %>%
#  full_join(.,muslim_pc, by = c("constituency_no" ="ac_no" )) %>% ungroup()
# 
# wb_16_19

```


### SC - BJP & AITC - 2016-19



```{r}
ggplot(wb_sc, aes(sc_pc,vs_19 , color = party))+
  geom_point(alpha = .5)+
  geom_smooth(se = FALSE, method = "lm")+
    scale_color_manual(values = c("BJP" = "orange",
                              
                                
                                "AITC" = "steelblue")) +
  ggthemes::theme_fivethirtyeight()+
  labs( color = "Party", x= "SC Percentage", y = " Vote share (%) 2019)",subtitle= "Vote share as a function of proportion of SCs in the constituency")+
  scale_x_continuous(limits = c(0,80))+
  scale_y_continuous(limits = c(0,80) )+
  theme(legend.position = "bottom",
        text = element_text(family="serif", face = "bold"),
        axis.title = element_text()
                            )
```


### SC & ST - BJP & AITC - 2016-19


```{r}
ggplot(wb_sc, aes(sc_st_pc,vs_19 , color = party))+
  geom_point(alpha = .5)+
  geom_smooth(se = FALSE, method = "lm")+
    scale_color_manual(values = c("BJP" = "orange",
                              
                                
                                "AITC" = "steelblue")) +
  ggthemes::theme_fivethirtyeight()+
  labs( color = "Party", x= "SC & ST Percentage", y = " Vote share (%) 2019)",subtitle= "Vote share as a function of proportion of SC and St population  in the constituency")+
  scale_x_continuous(limits = c(0,80))+
  scale_y_continuous(limits = c(0,80) )+
  theme(legend.position = "bottom",
        text = element_text(family="serif", face = "bold"),
        axis.title = element_text()
                            )
```



---



# Muslims

Muslims percentage at AC level aggregated using Raphael's booth level data.


```{r}
muslim_pc <- read.csv("D:/cpr/elections/wb/muslim_pc_14.csv")

names(muslim_pc)[1] <- "ac_no"

wb_el_mus <- full_join(wb_el, muslim_pc, by = c("constituency_no" = "ac_no"))
```

## District level distribution

```{r}

muslim_pc$cat <- cut(muslim_pc$muslim_pc, breaks = c(0,20,30,40, 50,Inf), right = TRUE)

# table(muslim_pc$cat)
# 
# prop.table(table(muslim_pc$cat) )


muslim_pc %>% group_by(cat) %>% summarise(count= n(), pc = (count/274)*100) %>% kable(digits =2, col.names   = c("Muslim percentage cat", "Count of AC", "Percentage of ACs")) %>% kable_styling(bootstrap_options = "striped")

```

## Vote share{.tabset}


### All AE and GE elections- Post 2009

```{r}
ggplot(wb_el_mus %>% filter(front%in%c("BJP",  "AITC")), aes(muslim_pc, vote_share_percentage, color = front))+
  geom_point(alpha=0.4)+
  geom_smooth(method = "lm")+
  scale_color_manual(values = c("BJP" = "orange",
                                
                                "AITC" = "darkgreen")) +
  labs(title = "Muslim voters v/s Vote share of the major parties in the state", y = "Vote share(%)",subtitle = "2011:19 WB elections", x = "Muslim voters (%)", color = "Party")+
  xlim(20,80)+
  theme_minimal_grid()+
  theme(legend.position = "bottom",
        text = element_text(family="serif"),
                            )


```

### AE elections

```{r}

ggplot(wb_el_mus %>% filter(front%in%c("BJP",  "AITC")& election_type =="AE"), aes(muslim_pc, vote_share_percentage, color = front))+
  geom_point(alpha=0.4)+
  geom_smooth(method = "lm")+
  scale_color_manual(values = c("BJP" = "orange",

                                "AITC" = "darkgreen")) +
  labs(title = "Muslim voters v/s Vote share of the major parties in the state", y = "Vote share(%)",subtitle = "2011 & 2016 AE elections", x = "Muslim voters (%)", color = "Party")+
  xlim(20,80)+
  theme_minimal_grid()+
  theme(legend.position = "bottom",
        text = element_text(family="serif"),
                            )

```


### GE elections


```{r}

ggplot(wb_el_mus %>% filter(front%in%c("BJP",  "AITC")& election_type =="GE"), aes(muslim_pc, vote_share_percentage, color = front))+
  geom_point(alpha=0.5)+
  geom_smooth(method = "lm")+
  scale_color_manual(values = c("BJP" = "orange",
                              
                                
                                "AITC" = "darkgreen")) +
  labs(title = "Muslim voters v/s Vote share of the major parties in the state", y = "Vote share(%)",subtitle = "2014 & 2019 GE elections", x = "Muslim voters (%)", color = "Party")+
  xlim(20,80)+
  theme_minimal_grid()+
  theme(legend.position = "bottom",
        text = element_text(family="serif"),
                            )

```


<!-- ### GE 2019 -->



<!-- ```{r} -->


<!-- ggplot(wb_el_mus %>% filter(front%in%c("BJP",  "AITC")& year ==2019), aes(muslim_pc, vote_share_percentage, color = front))+ -->
<!--   geom_point(alpha=0.4)+ -->
<!--   geom_smooth(method = "lm")+ -->
<!--   scale_color_manual(values = c("BJP" = "orange", -->


<!--                                 "AITC" = "darkgreen")) + -->
<!--   labs(title = "Muslim voters v/s Vote share of the major parties in the state", y = "Vote share(%)",subtitle = "2014 & 2019 GE elections", x = "Muslim voters (%)", color = "Party")+ -->
<!--   scale_x_continuous(limits = c(15,80))+ -->

<!--   theme_minimal_grid()+ -->
<!--   theme(legend.position = "bottom", -->
<!--         text = element_text(family="serif"), -->
<!--                             ) -->


<!-- ``` -->




### 2019-  AITC & BJP

```{r}

wb_mus<- dplyr::inner_join( wb_vs_16_19,muslim_pc, shrug_sc, by = c( "constituency_no"=  "ac_no"  ))


ggplot(wb_mus, aes(muslim_pc, vs_19, color = party))+
  geom_point(alpha = .5)+
  geom_smooth(se = FALSE, method = "lm")+
    scale_color_manual(values = c("BJP" = "orange",
                              
                                
                                "AITC" = "steelblue")) +
  ggthemes::theme_fivethirtyeight()+
  labs( color = "Party", subtitle= "vote share as a function of proportion of Muslims in the constituency",x="Muslim Percentage" , y = "vote share(%) 2019)")+
  scale_x_continuous(limits = c(20,80) )+
  scale_y_continuous(limits = c(20,80) )+
  theme(legend.position = "bottom",
        text = element_text(family="serif", face = "bold"),
        axis.title = element_text(),
        title = element_text()
                            )




```

### 2019 -  AITC

```{r}

wb_mus_lf<- dplyr::inner_join( wb_vs_16_19_lf,muslim_pc, shrug_sc, by = c( "constituency_no"=  "ac_no"  ))

ggplot(wb_mus_lf %>%filter(front_new == "AITC"), aes(muslim_pc, vs_19))+
  geom_point(alpha = .5, color = "chartreuse4")+
  geom_smooth(se = FALSE, method = "lm",, color = "chartreuse4") +
  ggthemes::theme_fivethirtyeight()+
  labs(  subtitle= "AITC vote share as a function of proportion of Muslims in the constituency",x="Muslim Percentage" , y = "Vote share (%) 2019")+
  theme(legend.position = "bottom",
        text = element_text(family="serif", face = "bold"),
        axis.title = element_text(),
        title = element_text()
                            )


```





## Vote share change{.tabset}


Paarty vote share change from 2016 as a function of Muslim population


### Vote share change - ATIC & BJP


```{r}

wb_mus<- dplyr::inner_join( wb_vs_16_19,muslim_pc, shrug_sc, by = c( "constituency_no"=  "ac_no"  ))

ggplot(wb_mus, aes(muslim_pc, vs_change, color = party))+
  geom_point(alpha = .5)+
  geom_smooth(se = FALSE, method = "lm")+
    scale_color_manual(values = c("BJP" = "orange",
                              
                                
                                "AITC" = "steelblue")) +
  ggthemes::theme_fivethirtyeight()+
  labs( color = "Party", subtitle= "Change in vote share as a function of proportion of Muslims in the constituency",x="Muslim Percentage" , y = "Change in vote share % (2016 to 2019)")+
  scale_x_continuous(limits = c(20,70), breaks = c(20,30,40,50,60,70),labels  = c(20,30,40,50,60,70) )+
  scale_y_continuous(limits = c(-20,60), breaks = c(-20,0,20,40,60),labels  = c(-20,0,20,40,60) )+
  theme(legend.position = "bottom",
        text = element_text(family="serif", face = "bold"),
        axis.title = element_text(),
        title = element_text()
                            )

 #ggsave("muslim.png", width = 6, height = 4)


```

### Vote share change - ATIC & LF+AITC


```{r}

wb_mus_lf<- dplyr::inner_join( wb_vs_16_19_lf,muslim_pc, shrug_sc, by = c( "constituency_no"=  "ac_no"  ))

ggplot(wb_mus_lf, aes(muslim_pc, vs_change, color = front_new))+
  geom_point(alpha = .5)+
  geom_smooth(se = FALSE, method = "lm")+
    scale_color_manual(values = c(
                                  "LF+INC" = "red",
                              
                                
                                "AITC" = "chartreuse4")) +
  ggthemes::theme_fivethirtyeight()+
  labs( color = "Front", subtitle= "Change in vote share as a function of proportion of Muslims in the constituency",x="Muslim Percentage" , y = "Change in vote share % (2016 to 2019)")+
  xlim(20,80)+
  #scale_x_continuous(limits = c(0,70), breaks = c(0,10,20,30,40,50,60,70),labels  = c(0,10,20,30,40,50,60,70) )+
  #scale_y_continuous(limits = c(-20,60), breaks = c(-20,0,20,40,60),labels  = c(-20,0,20,40,60) )+
  theme(legend.position = "bottom",
        text = element_text(family="serif", face = "bold"),
        axis.title = element_text(),
        title = element_text()
                            )

# ggsave("muslim.png", width = 6, height = 4)



```


### Vote share change - ATIC 


```{r}
ggplot(wb_mus_lf %>%filter(front_new == "AITC"), aes(muslim_pc, vs_change))+
  geom_point(alpha = .5, color = "chartreuse4")+
  geom_smooth(se = FALSE, method = "lm",, color = "chartreuse4") +
  ggthemes::theme_fivethirtyeight()+
  labs( color = "Front", subtitle= "Change in AITC vote share as a function of proportion of Muslims in the constituency",x="Muslim Percentage" , y = "Change in vote share % (2016 to 2019)")+
  theme(legend.position = "bottom",
        text = element_text(family="serif", face = "bold"),
        axis.title = element_text(),
        title = element_text()
                            )

```





# sub region{.tabset}


```{r}

sub_reg <- read.csv("D:/cpr/elections/wb/sub_reg.csv")

names(sub_reg) <- tolower(names(sub_reg))

#sub_reg <- sub_reg  %>% select(-c(pc_no, pc_name, constituency_name))





wb_el_reg <- left_join(wb_el_mus, sub_reg, by= "constituency_no" )

  #  sub_reg_out <- wb_el_reg %>% select(constituency_no, district_name.y, sub_region_ht, pc_no.y, reservation) %>% distinct(constituency_no,.keep_all = TRUE)
  # # 
  #  write.csv(sub_reg_out, "D:/cpr/elections/wb/sub_reg.csv")

```


## Count


```{r}


sub_reg %>% group_by(sub_region_ht) %>% summarise(ac_count=n()) %>% kable(digits =2) %>% kable_styling(bootstrap_options = "striped")


```

## Muslims by region


```{r}

wb_el_reg %>% filter(year == 2019 & position==1) %>% group_by(sub_region_ht) %>% summarise(mean_muslims = mean(muslim_pc, na.rm = TRUE)) %>% kable(digits =2) %>% kable_styling(bootstrap_options = "striped")

```


## Constituency type

```{r}

 wb_el_reg$reservation<- ifelse( wb_el_reg$constituency_type== "GEN", "GEN", "SC/ST")


wb_el_reg %>% filter(year == 2019 & position==1) %>% group_by(sub_region_ht,reservation )%>% summarise(count = n()) %>% pivot_wider(names_from = reservation, values_from = count)  %>% kable()%>% kable_styling(bootstrap_options = "striped")
```




## Vote share



```{r}
wb_el_reg %>% filter(party %in% c("BJP", "AITC") & year %in% c(2016,2019)) %>% group_by(year,sub_region_ht, party) %>% summarise(vs= mean(vote_share_percentage)) %>% 

  ggplot((aes(factor(sub_region_ht, level = c("Hills", "Jangalmahal","South Bengal", "North Bengal", "Central Bengal")), vs, fill = party)))+
  geom_bar(stat= "identity", position="dodge")+
  facet_wrap(~year)+
    labs(title = "Vote share  of parties wrt sub region", y = "Vote share (%)", x = "Sub region", fill = "Election")+
  scale_fill_manual(values = c("BJP" = "orange",
                                "AITC" = "darkgreen"))+
  ylim(0,60)+
  theme_minimal_hgrid()+
  theme(legend.position = "bottom",
        text = element_text(family="serif"),
        axis.text.x = element_text(angle = 45,hjust = 1))
  
```

## seat share

```{r}

wb_el_reg %>% filter(party %in% c("BJP", "AITC") & position==1 & year %in% c(2016,2019)) %>% group_by(year,sub_region_ht, party) %>% summarise(count =n()) %>% pivot_wider(names_from = year, values_from = count)  %>% arrange(sub_region_ht) %>%  mutate(`2016`= replace_na(`2016`,0))%>%kable()%>% kable_styling(bootstrap_options = "striped")

```




# districts

```{r}
n_ac <- wb_el_reg %>% filter(sub_region_ht== "South Bengal" & year == 2019 & position ==1) %>% 
  group_by(district_name.y) %>% summarise(n_ac = n()) 


wb_el_reg %>% filter(sub_region_ht== "South Bengal" & year == 2019 & position ==1) %>% 
  group_by(district_name.y, party) %>% summarise(n_ac_lead = n()) %>% pivot_wider(names_from = party, values_from = n_ac_lead) %>% mutate(`BJP` = replace_na(`BJP` ,0)) %>% left_join(.,n_ac, by = "district_name.y") %>% select(district_name.y, n_ac, AITC, BJP)
```

# South Bengal {.tabset}

## Party vote share



```{r}
wb_el_reg %>% filter(sub_region_ht== "South Bengal" & year %in% c(2016,2019) & party %in% c("AITC", "BJP")) %>% 
  group_by(year,district_name.y, party) %>% summarise(vs= mean(vote_share_percentage)) %>% 
  ggplot(aes(district_name.y, vs, fill =factor(party, level = c("BJP", "AITC"))))+
  geom_bar(stat= "identity", position= "dodge")+
  facet_wrap(~year)+
  coord_flip()+
    scale_fill_manual(values = c("BJP" = "darkorange1",
                                "AITC" = "chartreuse4"))+
  labs(title = "Party performance in the South Bengal", x = "Districts", y = "Average vote share(%)", fill = "Party" )+
  ggthemes::theme_fivethirtyeight()+
  #theme_minimal_hgrid()+
  theme(legend.position = "bottom",
        text = element_text(family="serif", face = "bold"),
        axis.title = element_text(),
        #axis.text.x = element_text(angle = 45,hjust = 1)
        )

 
```



## Party seats


```{r}
wb_el_reg %>% filter(sub_region_ht== "South Bengal" & year %in% c(2016,2019) & party %in% c("AITC", "BJP")& position==1) %>% 
  group_by(year,district_name.y, party) %>% summarise(seats = n()) %>% 
  ggplot(aes(district_name.y, seats, fill =factor(party, level = c("BJP", "AITC"))))+
  geom_bar(stat= "identity", position= "dodge")+
  facet_wrap(~year)+
  coord_flip()+
    scale_fill_manual(values = c("BJP" = "darkorange1",
                                "AITC" = "chartreuse4"))+
  labs(title = "Party performance in the South Bengal", x = "Districts", y = "Number of Assembly segments", fill = "Party" )+
  ggthemes::theme_fivethirtyeight()+
  #theme_minimal_hgrid()+
  theme(legend.position = "bottom",
        text = element_text(family="serif", face = "bold"),
        axis.title = element_text(),
        #axis.text.x = element_text(angle = 45,hjust = 1)
        )

```



# South Bengal -BJP


```{r}


wb_el_reg_19 <- wb_el_reg %>% filter(year ==2019)


wb_el_reg_19  <- wb_el_reg_19 %>% mutate(sub_reg_1 = ifelse(sub_region_ht == "South Bengal", "South Bengal", "Bengal - other"))




wb_el_reg_19 %>% filter(front_new %in% c("BJP", "AITC", "LF+INC") & position ==1) %>% group_by (constituency_no) %>% distinct(front_new, .keep_all = TRUE) %>% ungroup() %>% group_by(sub_reg_1,front_new) %>% summarise(n_ac = n()) %>%  group_by(sub_reg_1) %>% mutate(n_ac_reg = sum(n_ac), ac_pc =( n_ac/n_ac_reg)*100) %>% kable(digits = 2, col.names = c("Region", "Front","Number of ACs leading", "Number of ACs in the region","% of ACs leading in the region")) %>% kable_styling(bootstrap_options = "striped")

```



---



 **List of ACs in south Bengal with vote share of the fronts**


```{r}
vs_ac <- wb_el_reg_19 %>% filter(front_new %in% c("BJP", "AITC", "LF+INC") & sub_reg_1 == "South Bengal") %>% group_by (constituency_no) %>% distinct(front_new, .keep_all = TRUE) %>% ungroup() %>% select(constituency_no, constituency_name,front_new, vote_share_percentage)%>% mutate(vote_share_percentage= round(vote_share_percentage,1)) %>% pivot_wider(names_from = front_new, values_from = vote_share_percentage) 
DT::datatable(vs_ac)
```

---

**How does change in certain percentage point vote share reflects on the number of constituencies led by BJP**



```{r}
winners <- wb_el_reg_19 %>% filter(front_new %in% c("BJP", "AITC", "LF+INC") & sub_reg_1 == "South Bengal") %>% group_by (constituency_no) %>% distinct(front_new, .keep_all = TRUE) %>% ungroup() %>% select(constituency_no, constituency_name,front_new, vote_share_percentage) %>% pivot_wider(names_from = front_new, values_from = vote_share_percentage) %>% rowwise() %>% mutate(winner = ifelse(max(`BJP`, `AITC`, `LF+INC`)<= `BJP`,1,0),
                                                                                                                                                                                                                                                                                                                                                                              winner_1 = ifelse(max(`BJP`, `AITC`, `LF+INC`)<= `BJP`+1,1,0),
                                                                                                                                                                                                                                                                                                                                                                              winner_2 = ifelse(max(`BJP`, `AITC`, `LF+INC`)<= `BJP`+2,1,0),
                                                                                                                                                                                                                                                                                                                                                                              winner_3 = ifelse(max(`BJP`, `AITC`, `LF+INC`)<= `BJP`+3,1,0),
                                                                                                                                                                                                                                                                                                                                                                              winner_5 = ifelse(max(`BJP`, `AITC`, `LF+INC`)<= `BJP`+5,1,0),
                                                                                                                                                                                                                                                                                                                                                                              winner_7 = ifelse(max(`BJP`, `AITC`, `LF+INC`)<= `BJP`+7,1,0),
                                                                                                                                                                                                                                                                                                                                                                              winner_10 = ifelse(max(`BJP`, `AITC`, `LF+INC`)<= `BJP`+10,1,0)
                                                                                                                                                                                                                                                                                                                                                                              )
```



```{r}
win_long <- winners %>% group_by()%>% summarise(winner = sum(winner), winner_1pc = sum(winner_1),
                                    winner_2pc = sum(winner_2),winner_3pc = sum(winner_3),
                                    winner_5pc = sum(winner_5),winner_7pc = sum(winner_7),
                                    winner_10pc = sum(winner_10)) 
title  <- c("win_pc", "n_ac")


win_long_title <- cbind(title, win_long)

win_long_title  %>% pivot_longer(-1) %>% slice(1:7) %>% select(2:3) %>% rename("add_on" = "name", "n_ac_lead" = "value") %>% mutate(pc_ac = n_ac_lead/167*100) %>% 
  kable(digits = 2, col.names= c ("Vote share added", "Number of ACs leading","Percentage of leading ACs in south")) %>% kable_styling(bootstrap_options = "striped")


```











